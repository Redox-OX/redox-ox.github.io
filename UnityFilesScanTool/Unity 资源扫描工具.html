<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Unity èµ„æºæ‰«æå·¥å…·ï¼ˆæœ¬åœ°ç‰ˆï¼‰</title>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
  <style>
      * {
          box-sizing: border-box;
      }
      
      body {
          font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
          max-width: 1200px;
          margin: 0 auto;
          padding: 20px;
          background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
          min-height: 100vh;
          line-height: 1.6;
      }
      
      .container {
          background: rgba(255, 255, 255, 0.95);
          backdrop-filter: blur(10px);
          padding: 40px;
          border-radius: 20px;
          box-shadow: 0 20px 40px rgba(0,0,0,0.1);
          border: 1px solid rgba(255,255,255,0.2);
      }
      
      h1 {
          color: #2d3748;
          text-align: center;
          margin-bottom: 10px;
          display: flex;
          align-items: center;
          justify-content: center;
          gap: 15px;
          font-size: 2.2rem;
          font-weight: 700;
      }
      
      .unity-logo {
          width: 40px;
          height: 40px;
          background: linear-gradient(45deg, #667eea, #764ba2);
          border-radius: 10px;
          display: inline-flex;
          align-items: center;
          justify-content: center;
          color: white;
          font-weight: bold;
          font-size: 18px;
          box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
      }
      
      .subtitle {
          text-align: center;
          color: #718096;
          margin-bottom: 40px;
          font-size: 16px;
          font-weight: 500;
      }
      
      .step {
          margin: 30px 0;
          padding: 30px;
          border: none;
          border-radius: 15px;
          background: linear-gradient(145deg, #ffffff, #f7fafc);
          box-shadow: 0 10px 25px rgba(0,0,0,0.08);
          border: 1px solid rgba(226, 232, 240, 0.8);
          transition: all 0.3s ease;
      }
      
      .step:hover {
          transform: translateY(-2px);
          box-shadow: 0 15px 35px rgba(0,0,0,0.12);
      }
      
      .step-title {
          font-size: 20px;
          font-weight: 600;
          color: #2d3748;
          margin-bottom: 20px;
          display: flex;
          align-items: center;
          gap: 15px;
      }
      
      .step-number {
          background: linear-gradient(45deg, #667eea, #764ba2);
          color: white;
          width: 32px;
          height: 32px;
          border-radius: 50%;
          display: flex;
          align-items: center;
          justify-content: center;
          font-size: 16px;
          font-weight: bold;
          box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
      }
      
      .folder-tree {
          max-height: 400px;
          overflow-y: auto;
          border: 1px solid #e2e8f0;
          border-radius: 10px;
          padding: 15px;
          background: #ffffff;
          font-family: 'SF Mono', Monaco, 'Cascadia Code', 'Roboto Mono', Consolas, 'Courier New', monospace;
          font-size: 14px;
          box-shadow: inset 0 2px 4px rgba(0,0,0,0.06);
      }
      
      .folder-tree::-webkit-scrollbar {
          width: 8px;
      }
      
      .folder-tree::-webkit-scrollbar-track {
          background: #f1f5f9;
          border-radius: 4px;
      }
      
      .folder-tree::-webkit-scrollbar-thumb {
          background: #cbd5e0;
          border-radius: 4px;
      }
      
      .folder-tree::-webkit-scrollbar-thumb:hover {
          background: #a0aec0;
      }
      
      .folder-item {
          padding: 8px 0;
          cursor: pointer;
          user-select: none;
          display: flex;
          align-items: center;
          gap: 8px;
          transition: all 0.2s ease;
          border-radius: 6px;
          padding: 6px 8px;
          margin: 2px 0;
      }
      
      .folder-item:hover {
          background: linear-gradient(90deg, #edf2f7, #e2e8f0);
          transform: translateX(4px);
      }
      
      .folder-item.selected {
          background: linear-gradient(90deg, #667eea, #764ba2);
          color: white;
          box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
      }
      
      .folder-toggle {
          width: 20px;
          height: 20px;
          display: flex;
          align-items: center;
          justify-content: center;
          cursor: pointer;
          border-radius: 4px;
          font-size: 14px;
          transition: all 0.2s ease;
          background: rgba(0,0,0,0.05);
      }
      
      .folder-toggle:hover {
          background: rgba(102, 126, 234, 0.1);
          transform: scale(1.1);
      }
      
      .folder-toggle.expanded {
          transform: rotate(90deg);
      }
      
      .folder-icon {
          width: 20px;
          text-align: center;
          flex-shrink: 0;
          font-size: 16px;
      }
      
      .folder-content {
          flex: 1;
          display: flex;
          align-items: center;
          gap: 8px;
      }
      
      .folder-children {
          margin-left: 25px;
      }
      
      .folder-name {
          flex: 1;
          font-weight: 500;
      }
      
      .file-count {
          font-size: 11px;
          background: linear-gradient(45deg, #667eea, #764ba2);
          color: white;
          padding: 4px 8px;
          border-radius: 12px;
          margin-left: 8px;
          font-weight: 500;
          box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3);
      }
      
      .folder-item.selected .file-count {
          background: rgba(255,255,255,0.2);
          box-shadow: 0 2px 8px rgba(255,255,255,0.2);
      }
      
      .format-selector {
          margin: 25px 0;
          padding: 25px;
          border: 1px solid #e2e8f0;
          border-radius: 15px;
          background: linear-gradient(145deg, #ffffff, #f8fafc);
          box-shadow: 0 4px 15px rgba(0,0,0,0.05);
      }
      
      .format-title {
          font-size: 18px;
          font-weight: 600;
          margin-bottom: 20px;
          color: #2d3748;
      }
      
      .format-grid {
          display: grid;
          grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
          gap: 20px;
      }
      
      .format-category {
          border: 1px solid #e2e8f0;
          border-radius: 12px;
          padding: 20px;
          background: linear-gradient(145deg, #ffffff, #f7fafc);
          transition: all 0.3s ease;
      }
      
      .format-category:hover {
          transform: translateY(-2px);
          box-shadow: 0 8px 25px rgba(0,0,0,0.1);
          border-color: #667eea;
      }
      
      .category-title {
          font-weight: 600;
          margin-bottom: 15px;
          color: #2d3748;
          display: flex;
          align-items: center;
          gap: 8px;
          font-size: 16px;
      }
      
      .format-option {
          display: flex;
          align-items: center;
          gap: 12px;
          margin: 12px 0;
          cursor: pointer;
          padding: 8px;
          border-radius: 8px;
          transition: all 0.2s ease;
      }
      
      .format-option:hover {
          background: linear-gradient(90deg, #edf2f7, #e2e8f0);
          transform: translateX(4px);
      }
      
      .format-option input[type="checkbox"] {
          margin: 0;
          width: 18px;
          height: 18px;
          accent-color: #667eea;
      }
      
      .format-option label {
          cursor: pointer;
          font-size: 14px;
          display: flex;
          align-items: center;
          gap: 8px;
          font-weight: 500;
          color: #4a5568;
      }
      
      .format-icon {
          width: 18px;
          height: 18px;
          border-radius: 4px;
          display: inline-block;
          box-shadow: 0 2px 8px rgba(0,0,0,0.15);
      }
      
      .icon-prefab { background: linear-gradient(45deg, #48bb78, #68d391); }
      .icon-image { background: linear-gradient(45deg, #ed8936, #f6ad55); }
      .icon-audio { background: linear-gradient(45deg, #9f7aea, #b794f6); }
      .icon-model { background: linear-gradient(45deg, #4299e1, #63b3ed); }
      .icon-script { background: linear-gradient(45deg, #718096, #a0aec0); }
      .icon-other { background: linear-gradient(45deg, #a0522d, #d69e2e); }
      
      .resource-list {
          max-height: 500px;
          overflow-y: auto;
          border: 1px solid #e2e8f0;
          border-radius: 15px;
          padding: 20px;
          margin: 20px 0;
          background: linear-gradient(145deg, #ffffff, #f8fafc);
          box-shadow: 0 4px 15px rgba(0,0,0,0.05);
      }
      
      .resource-list::-webkit-scrollbar {
          width: 8px;
      }
      
      .resource-list::-webkit-scrollbar-track {
          background: #f1f5f9;
          border-radius: 4px;
      }
      
      .resource-list::-webkit-scrollbar-thumb {
          background: #cbd5e0;
          border-radius: 4px;
      }
      
      .resource-list::-webkit-scrollbar-thumb:hover {
          background: #a0aec0;
      }
      
      .resource-item {
          padding: 15px 0;
          border-bottom: 1px solid #e2e8f0;
          font-size: 14px;
          display: flex;
          align-items: center;
          gap: 15px;
          transition: all 0.2s ease;
          border-radius: 8px;
          padding: 12px 15px;
          margin: 4px 0;
      }
      
      .resource-item:hover {
          background: linear-gradient(90deg, #edf2f7, #e2e8f0);
          transform: translateX(4px);
      }
      
      .resource-item.selected {
          background: linear-gradient(90deg, #e6fffa, #b2f5ea);
          border-color: #38b2ac;
      }
      
      .resource-item:last-child {
          border-bottom: none;
      }
      
      .resource-checkbox {
          width: 18px;
          height: 18px;
          accent-color: #667eea;
          cursor: pointer;
      }
      
      .resource-info {
          flex: 1;
      }
      
      .resource-name {
          font-weight: 600;
          color: #2d3748;
          margin-bottom: 4px;
      }
      
      .resource-path {
          color: #718096;
          font-size: 12px;
          font-family: 'SF Mono', Monaco, 'Cascadia Code', 'Roboto Mono', Consolas, 'Courier New', monospace;
      }
      
      .resource-type {
          font-size: 11px;
          background: linear-gradient(45deg, #667eea, #764ba2);
          color: white;
          padding: 6px 12px;
          border-radius: 20px;
          text-transform: uppercase;
          font-weight: 600;
          letter-spacing: 0.5px;
          box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3);
      }
      
      .batch-operations {
          background: linear-gradient(145deg, #ffffff, #f8fafc);
          border: 1px solid #e2e8f0;
          border-radius: 12px;
          padding: 15px 20px;
          margin: 15px 0;
          display: flex;
          align-items: center;
          gap: 12px;
          flex-wrap: wrap;
      }
      
      .batch-operations .selected-count {
          color: #4a5568;
          font-weight: 500;
          margin-right: 10px;
      }
      
      .batch-operations button {
          font-size: 12px;
          padding: 6px 12px;
          background: linear-gradient(45deg, #38b2ac, #4fd1c7);
          box-shadow: 0 2px 8px rgba(56, 178, 172, 0.3);
      }
      
      .batch-operations button:hover {
          background: linear-gradient(45deg, #319795, #38b2ac);
      }
      
      .batch-operations button:disabled {
          background: linear-gradient(45deg, #cbd5e0, #a0aec0);
          box-shadow: none;
      }
      
      button {
          background: linear-gradient(45deg, #667eea, #764ba2);
          color: white;
          border: none;
          padding: 12px 24px;
          border-radius: 10px;
          cursor: pointer;
          font-size: 14px;
          font-weight: 600;
          margin: 8px 6px;
          transition: all 0.3s ease;
          box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
          position: relative;
          overflow: hidden;
      }
      
      button:hover {
          transform: translateY(-2px);
          box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4);
      }
      
      button:active {
          transform: translateY(0);
      }
      
      button:disabled {
          background: linear-gradient(45deg, #cbd5e0, #a0aec0);
          cursor: not-allowed;
          transform: none;
          box-shadow: none;
      }
      
      button::before {
          content: '';
          position: absolute;
          top: 0;
          left: -100%;
          width: 100%;
          height: 100%;
          background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
          transition: left 0.5s;
      }
      
      button:hover::before {
          left: 100%;
      }
      
      input[type="text"], select {
          width: 100%;
          padding: 12px 16px;
          font-size: 14px;
          border: 2px solid #e2e8f0;
          border-radius: 10px;
          background: #ffffff;
          transition: all 0.3s ease;
          font-family: inherit;
      }
      
      input[type="text"]:focus, select:focus {
          outline: none;
          border-color: #667eea;
          box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
      }
      
      select {
          width: auto;
          margin: 0 10px;
          padding: 8px 12px;
          cursor: pointer;
      }
      
      .stats {
          background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
          color: white;
          padding: 25px;
          border-radius: 15px;
          margin: 25px 0;
          box-shadow: 0 10px 30px rgba(102, 126, 234, 0.3);
      }
      
      .stats-grid {
          display: grid;
          grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
          gap: 20px;
          margin-top: 20px;
      }
      
      .stat-item {
          background: rgba(255,255,255,0.15);
          backdrop-filter: blur(10px);
          padding: 20px;
          border-radius: 12px;
          text-align: center;
          border: 1px solid rgba(255,255,255,0.2);
          transition: all 0.3s ease;
      }
      
      .stat-item:hover {
          transform: translateY(-4px);
          background: rgba(255,255,255,0.2);
      }
      
      .stat-number {
          font-size: 24px;
          font-weight: 700;
          margin-bottom: 8px;
      }
      
      .stat-label {
          font-size: 12px;
          opacity: 0.9;
          font-weight: 500;
          text-transform: uppercase;
          letter-spacing: 0.5px;
      }
      
      .hidden {
          display: none;
      }
      
      .success-message {
          background: linear-gradient(45deg, #48bb78, #68d391);
          border: 1px solid #38a169;
          color: white;
          padding: 20px;
          border-radius: 12px;
          margin: 20px 0;
          box-shadow: 0 4px 15px rgba(72, 187, 120, 0.3);
          font-weight: 500;
      }
      
      .tree-controls {
          margin-bottom: 15px;
          display: flex;
          gap: 12px;
      }
      
      .tree-controls button {
          font-size: 12px;
          padding: 8px 16px;
          background: linear-gradient(45deg, #718096, #a0aec0);
          box-shadow: 0 2px 8px rgba(113, 128, 150, 0.3);
      }
      
      .tree-controls button:hover {
          background: linear-gradient(45deg, #4a5568, #718096);
      }
      
      .quick-select {
          margin-top: 20px;
          display: flex;
          gap: 12px;
          flex-wrap: wrap;
      }
      
      .quick-select button {
          font-size: 12px;
          padding: 8px 16px;
          background: linear-gradient(45deg, #48bb78, #68d391);
          box-shadow: 0 2px 8px rgba(72, 187, 120, 0.3);
      }
      
      .quick-select button:hover {
          background: linear-gradient(45deg, #38a169, #48bb78);
      }
      
      /* æ‰«æè¿›åº¦æ¡ç°ä»£åŒ– */
      #scanProgressBar {
          margin-bottom: 25px;
          padding: 20px;
          background: linear-gradient(145deg, #ffffff, #f8fafc);
          border-radius: 15px;
          box-shadow: 0 4px 15px rgba(0,0,0,0.05);
          border: 1px solid #e2e8f0;
      }
      
      #scanProgressText {
          font-size: 14px;
          color: #4a5568;
          margin-bottom: 12px;
          font-weight: 500;
      }
      
      #scanProgressInner {
          height: 8px;
          background: linear-gradient(45deg, #667eea, #764ba2);
          border-radius: 4px;
          transition: width 0.3s ease;
          box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3);
      }
      
      /* åˆ†é¡µç°ä»£åŒ– */
      #pagination {
          margin-top: 20px;
          text-align: center;
          font-size: 14px;
          color: #4a5568;
      }
      
      #pagination button {
          margin: 0 4px;
          padding: 8px 12px;
          font-size: 12px;
          min-width: 36px;
      }
      
      /* å¼¹çª—ç°ä»£åŒ– */
      #fieldSelectModal {
          position: fixed;
          left: 0;
          top: 0;
          width: 100vw;
          height: 100vh;
          background: rgba(0,0,0,0.5);
          backdrop-filter: blur(5px);
          z-index: 999;
          align-items: center;
          justify-content: center;
      }
      
      #fieldSelectModal:not(.hidden) {
          display: flex;
      }
      
      #fieldSelectModal > div {
          background: #ffffff;
          padding: 30px 40px;
          border-radius: 20px;
          min-width: 400px;
          max-width: 90vw;
          max-height: 80vh;
          overflow-y: auto;
          box-shadow: 0 20px 40px rgba(0,0,0,0.3);
          border: 1px solid rgba(255,255,255,0.2);
      }
      
      #fieldSelectModal h3 {
          font-size: 20px;
          font-weight: 600;
          margin-bottom: 20px;
          color: #2d3748;
      }
      
      #fieldCheckboxes {
          margin-bottom: 25px;
      }
      
      #fieldCheckboxes label {
          display: block;
          margin-bottom: 12px;
          padding: 8px 12px;
          border-radius: 8px;
          transition: all 0.2s ease;
          cursor: pointer;
          font-weight: 500;
          color: #4a5568;
      }
      
      #fieldCheckboxes label:hover {
          background: linear-gradient(90deg, #edf2f7, #e2e8f0);
      }
      
      #fieldCheckboxes input[type="checkbox"] {
          margin-right: 10px;
          width: 16px;
          height: 16px;
          accent-color: #667eea;
      }
      
      /* å¯è§†åŒ–å›¾è¡¨æ ·å¼ */
      .visualization-panel {
          margin: 25px 0;
          padding: 30px;
          background: linear-gradient(145deg, #ffffff, #f8fafc);
          border-radius: 15px;
          box-shadow: 0 10px 25px rgba(0,0,0,0.08);
          border: 1px solid rgba(226, 232, 240, 0.8);
      }
      
      .chart-controls {
          margin-bottom: 25px;
      }
      
      .chart-controls button {
          margin: 5px;
          font-size: 12px;
          padding: 8px 16px;
          background: linear-gradient(45deg, #667eea, #764ba2);
          box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3);
      }
      
      .chart-controls button:hover {
          background: linear-gradient(45deg, #5a67d8, #667eea);
      }
      
      .charts-container {
          display: grid;
          grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
          gap: 30px;
      }
      
      .chart-item {
          background: #ffffff;
          padding: 25px;
          border-radius: 12px;
          box-shadow: 0 4px 15px rgba(0,0,0,0.08);
          border: 1px solid #e2e8f0;
      }
      
      .chart-item h4 {
          margin: 0 0 20px 0;
          color: #2d3748;
          font-size: 16px;
          font-weight: 600;
          text-align: center;
      }
      
      .chart-item canvas {
          width: 100% !important;
          height: auto !important;
          max-height: 300px;
      }
      
      /* å»é‡å’Œå¼‚å¸¸æ£€æµ‹ç›¸å…³æ ·å¼ */
      .duplicate-group {
          border: 1px solid #e2e8f0;
          border-radius: 12px;
          margin: 15px 0;
          padding: 20px;
          background: linear-gradient(145deg, #ffffff, #f8fafc);
          box-shadow: 0 4px 15px rgba(0,0,0,0.05);
      }
      
      .duplicate-group.type-name {
          border-left: 4px solid #ed8936;
      }
      
      .duplicate-group.type-content {
          border-left: 4px solid #e53e3e;
      }
      
      .duplicate-group-header {
          font-weight: 600;
          color: #2d3748;
          margin-bottom: 15px;
          display: flex;
          align-items: center;
          gap: 10px;
      }
      
      .duplicate-group-files {
          margin-left: 20px;
      }
      
      .duplicate-file-item {
          padding: 8px 12px;
          margin: 6px 0;
          background: rgba(0,0,0,0.02);
          border-radius: 6px;
          font-size: 13px;
          color: #4a5568;
          display: flex;
          align-items: center;
          gap: 10px;
      }
      
      .duplicate-file-item:hover {
          background: rgba(102, 126, 234, 0.1);
      }
      
      .anomaly-item {
          border: 1px solid #e2e8f0;
          border-radius: 12px;
          margin: 10px 0;
          padding: 15px;
          background: linear-gradient(145deg, #ffffff, #f8fafc);
          transition: all 0.2s ease;
      }
      
      .anomaly-item:hover {
          transform: translateY(-2px);
          box-shadow: 0 8px 25px rgba(0,0,0,0.1);
      }
      
      .anomaly-item.severity-error {
          border-left: 4px solid #e53e3e;
      }
      
      .anomaly-item.severity-warning {
          border-left: 4px solid #ed8936;
      }
      
      .anomaly-item.severity-info {
          border-left: 4px solid #3182ce;
      }
      
      .anomaly-header {
          font-weight: 600;
          color: #2d3748;
          margin-bottom: 8px;
          display: flex;
          align-items: center;
          gap: 8px;
      }
      
      .anomaly-path {
          color: #718096;
          font-size: 12px;
          font-family: 'SF Mono', Monaco, 'Cascadia Code', 'Roboto Mono', Consolas, 'Courier New', monospace;
          margin-bottom: 8px;
      }
      
      .anomaly-details {
          margin-top: 10px;
      }
      
      .anomaly-rule {
          display: inline-block;
          padding: 4px 8px;
          margin: 2px 4px 2px 0;
          border-radius: 12px;
          font-size: 11px;
          font-weight: 500;
      }
      
      .anomaly-rule.severity-error {
          background: #fed7d7;
          color: #c53030;
      }
      
      .anomaly-rule.severity-warning {
          background: #feebc8;
          color: #dd6b20;
      }
      
      .anomaly-rule.severity-info {
          background: #bee3f8;
          color: #2b6cb0;
      }
      
      .anomaly-suggestion {
          color: #4a5568;
          font-size: 12px;
          font-style: italic;
          margin-top: 8px;
          padding: 8px;
          background: rgba(0,0,0,0.02);
          border-radius: 6px;
      }
      
      .analysis-advice-item {
          margin: 15px 0;
          padding: 20px;
          border-radius: 12px;
          background: linear-gradient(145deg, #ffffff, #f8fafc);
          border: 1px solid #e2e8f0;
      }
      
      .advice-title {
          font-weight: 600;
          color: #2d3748;
          margin-bottom: 10px;
          display: flex;
          align-items: center;
          gap: 8px;
      }
      
      .advice-content {
          color: #4a5568;
          line-height: 1.6;
      }
      
      .cleanup-actions {
          margin-top: 20px;
          padding: 20px;
          background: linear-gradient(145deg, #ffffff, #f8fafc);
          border-radius: 12px;
          border: 1px solid #e2e8f0;
      }
      
      .cleanup-actions button {
          margin: 5px;
          font-size: 12px;
          padding: 8px 16px;
      }
      
      .cleanup-actions button.danger {
          background: linear-gradient(45deg, #e53e3e, #fc8181);
          box-shadow: 0 2px 8px rgba(229, 62, 62, 0.3);
      }
      
      .cleanup-actions button.danger:hover {
          background: linear-gradient(45deg, #c53030, #e53e3e);
      }
      
      /* å¼•ç”¨å…³ç³»åˆ†ææ ·å¼ */
      .dependency-graph {
          margin: 25px 0;
          padding: 25px;
          background: linear-gradient(145deg, #ffffff, #f8fafc);
          border-radius: 15px;
          box-shadow: 0 4px 15px rgba(0,0,0,0.05);
          border: 1px solid #e2e8f0;
      }
      
      .dependency-graph h4 {
          margin: 0 0 20px 0;
          color: #2d3748;
          font-size: 18px;
          font-weight: 600;
      }
      
      .graph-controls {
          display: flex;
          align-items: center;
          gap: 15px;
          margin-bottom: 20px;
      }
      
      .graph-controls button {
          font-size: 12px;
          padding: 8px 16px;
          background: linear-gradient(45deg, #4299e1, #63b3ed);
          box-shadow: 0 2px 8px rgba(66, 153, 225, 0.3);
      }
      
      .graph-controls button:hover {
          background: linear-gradient(45deg, #3182ce, #4299e1);
      }
      
      .graph-controls select {
          padding: 6px 12px;
          border: 1px solid #e2e8f0;
          border-radius: 6px;
          background: #ffffff;
          font-size: 12px;
      }
      
      .reference-item {
          border: 1px solid #e2e8f0;
          border-radius: 12px;
          margin: 10px 0;
          padding: 20px;
          background: linear-gradient(145deg, #ffffff, #f8fafc);
          transition: all 0.2s ease;
      }
      
      .reference-item:hover {
          transform: translateY(-2px);
          box-shadow: 0 8px 25px rgba(0,0,0,0.1);
      }
      
      .reference-header {
          font-weight: 600;
          color: #2d3748;
          margin-bottom: 12px;
          display: flex;
          align-items: center;
          gap: 10px;
          font-size: 16px;
      }
      
      .reference-path {
          color: #718096;
          font-size: 12px;
          font-family: 'SF Mono', Monaco, 'Cascadia Code', 'Roboto Mono', Consolas, 'Courier New', monospace;
          margin-bottom: 12px;
      }
      
      .reference-dependencies {
          margin-top: 15px;
      }
      
      .dependency-list {
          margin: 10px 0;
          padding-left: 20px;
      }
      
      .dependency-item {
          padding: 6px 0;
          color: #4a5568;
          font-size: 13px;
          display: flex;
          align-items: center;
          gap: 8px;
      }
      
      .dependency-type {
          display: inline-block;
          padding: 2px 6px;
          border-radius: 8px;
          font-size: 10px;
          font-weight: 500;
          text-transform: uppercase;
      }
      
      .dependency-type.prefab {
          background: #e6fffa;
          color: #234e52;
      }
      
      .dependency-type.texture {
          background: #fef5e7;
          color: #744210;
      }
      
      .dependency-type.material {
          background: #edf2f7;
          color: #2d3748;
      }
      
      .dependency-type.script {
          background: #e6f3ff;
          color: #2a4365;
      }
      
      .circular-dependency {
          border-left: 4px solid #e53e3e;
          background: linear-gradient(145deg, #fed7d7, #feb2b2);
      }
      
      .unused-asset {
          border-left: 4px solid #ed8936;
          background: linear-gradient(145deg, #feebc8, #fbd38d);
      }
      
      .reference-count {
          font-size: 11px;
          background: linear-gradient(45deg, #667eea, #764ba2);
          color: white;
          padding: 4px 8px;
          border-radius: 12px;
          margin-left: 8px;
          font-weight: 500;
          box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3);
      }
      
      /* å“åº”å¼è®¾è®¡ */
      @media (max-width: 768px) {
          body {
              padding: 10px;
          }
          
          .container {
              padding: 20px;
          }
          
          h1 {
              font-size: 1.8rem;
          }
          
          .format-grid {
              grid-template-columns: 1fr;
          }
          
          .stats-grid {
              grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
          }
          
          .quick-select {
              justify-content: center;
          }
          
          #fieldSelectModal > div {
              margin: 20px;
              padding: 20px;
              min-width: auto;
          }
          
          .duplicate-group-files {
              margin-left: 0;
          }
          
          .cleanup-actions {
              text-align: center;
          }
      }
      
      /* å…¼å®¹æ€§æç¤ºæ ·å¼ */
      .compatibility-warning {
          background: linear-gradient(135deg, #fff3cd, #ffeaa7);
          border: 2px solid #ffc107;
          border-radius: 15px;
          margin: 20px 0;
          padding: 0;
          box-shadow: 0 8px 25px rgba(255, 193, 7, 0.3);
          animation: slideDown 0.5s ease-out;
      }
      
      .compatibility-warning.hidden {
          display: none;
      }
      
      @keyframes slideDown {
          from {
              opacity: 0;
              transform: translateY(-20px);
          }
          to {
              opacity: 1;
              transform: translateY(0);
          }
      }
      
      .warning-content {
          padding: 25px;
      }
      
      .warning-header {
          display: flex;
          align-items: center;
          gap: 10px;
          margin-bottom: 15px;
          color: #856404;
          font-size: 18px;
      }
      
      .warning-icon {
          font-size: 24px;
      }
      
      .warning-body {
          color: #856404;
          line-height: 1.6;
      }
      
      .warning-body p {
          margin-bottom: 15px;
      }
      
      .browser-support {
          display: grid;
          grid-template-columns: 1fr 1fr;
          gap: 20px;
          margin: 15px 0;
          font-size: 14px;
      }
      
      .supported, .not-supported {
          padding: 15px;
          border-radius: 10px;
          background: rgba(255,255,255,0.3);
      }
      
      .supported {
          border-left: 4px solid #28a745;
      }
      
      .not-supported {
          border-left: 4px solid #dc3545;
      }
      
      .browser-support ul {
          margin: 8px 0 0 20px;
          padding: 0;
      }
      
      .browser-support li {
          margin: 4px 0;
      }
      
      .security-note {
          margin-top: 15px;
          padding: 15px;
          background: rgba(255,255,255,0.4);
          border-radius: 10px;
          border-left: 4px solid #17a2b8;
      }
      
      .security-note ul {
          margin: 8px 0 0 20px;
          padding: 0;
      }
      
      .security-note li {
          margin: 4px 0;
      }
      
      .dismiss-btn {
          margin-top: 20px;
          background: linear-gradient(45deg, #ffc107, #ffca2c);
          color: #856404;
          border: none;
          padding: 10px 20px;
          border-radius: 8px;
          font-weight: 600;
          cursor: pointer;
          transition: all 0.3s ease;
          box-shadow: 0 2px 8px rgba(255, 193, 7, 0.3);
      }
      
      .dismiss-btn:hover {
          background: linear-gradient(45deg, #e0a800, #ffc107);
          transform: translateY(-2px);
          box-shadow: 0 4px 15px rgba(255, 193, 7, 0.4);
      }
      
      /* é¢„è§ˆåŒºåŸŸæ ·å¼ */
      .preview-img, .preview-audio {
          border-radius: 8px;
          overflow: hidden;
          box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      }
      
      .preview-img {
          background: 
              linear-gradient(45deg, #e2e8f0 25%, transparent 25%), 
              linear-gradient(-45deg, #e2e8f0 25%, transparent 25%), 
              linear-gradient(45deg, transparent 75%, #e2e8f0 75%), 
              linear-gradient(-45deg, transparent 75%, #e2e8f0 75%);
          background-size: 8px 8px;
          background-position: 0 0, 0 4px, 4px -4px, -4px 0px;
          border: 2px solid #e2e8f0;
      }
      
      .preview-audio {
          background: #f8fafc;
          border: 1px solid #e2e8f0;
          padding: 4px;
      }
  </style>
</head>
<body>
  <div class="container">
      <h1>
          <div class="unity-logo">U</div>
          Unity èµ„æºæ‰«æå·¥å…·ï¼ˆæœ¬åœ°ç‰ˆï¼‰
      </h1>
      <div class="subtitle">é€‰æ‹©Unityé¡¹ç›®ç›®å½• â†’ é€‰æ‹©ç›®æ ‡æ–‡ä»¶å¤¹ â†’ é€‰æ‹©æ–‡ä»¶æ ¼å¼ â†’ å¯¼å‡ºèµ„æºåˆ—è¡¨ï¼ˆå…¨ç¨‹æœ¬åœ°å¤„ç†ï¼Œæ•°æ®ä¸ä¼šä¸Šä¼ ï¼‰</div>
      
      <!-- å…¼å®¹æ€§æç¤º -->
      <div id="compatibilityWarning" class="compatibility-warning">
          <div class="warning-content">
              <div class="warning-header">
                  <span class="warning-icon">âš ï¸</span>
                  <strong>æµè§ˆå™¨å…¼å®¹æ€§æé†’</strong>
              </div>
              <div class="warning-body">
                  <p>æœ¬å·¥å…·ä½¿ç”¨ç°ä»£æµè§ˆå™¨çš„ <strong>File System Access API</strong> æ¥è®¿é—®æœ¬åœ°æ–‡ä»¶ç³»ç»Ÿã€‚</p>
                  <div class="browser-support">
                      <div class="supported">
                          <strong>âœ… æ”¯æŒçš„æµè§ˆå™¨ï¼š</strong>
                          <ul>
                              <li>Chrome 86+ (æ¨è)</li>
                              <li>Edge 86+</li>
                              <li>Safari 15.2+ (macOS)</li>
                          </ul>
                      </div>
                      <div class="not-supported">
                          <strong>âŒ ä¸æ”¯æŒçš„æµè§ˆå™¨ï¼š</strong>
                          <ul>
                              <li>Firefox (æ‰€æœ‰ç‰ˆæœ¬)</li>
                              <li>Internet Explorer</li>
                              <li>è¾ƒæ—§ç‰ˆæœ¬çš„æµè§ˆå™¨</li>
                          </ul>
                      </div>
                  </div>
                  <div class="security-note">
                      <strong>ğŸ”’ å®‰å…¨è¯´æ˜ï¼š</strong>
                      <ul>
                          <li>å·¥å…·å®Œå…¨åœ¨æœ¬åœ°è¿è¡Œï¼Œä¸ä¼šä¸Šä¼ ä»»ä½•æ–‡ä»¶æˆ–æ•°æ®</li>
                          <li>éœ€è¦æ‚¨ä¸»åŠ¨æˆæƒè®¿é—®æ–‡ä»¶å¤¹</li>
                          <li>æ‰€æœ‰æ•°æ®å¤„ç†éƒ½åœ¨æ‚¨çš„è®¾å¤‡ä¸Šå®Œæˆ</li>
                      </ul>
                  </div>
              </div>
              <button id="dismissWarning" class="dismiss-btn">æˆ‘çŸ¥é“äº†</button>
          </div>
      </div>
      
      <!-- æ‰«æè¿›åº¦æ¡ -->
      <div id="scanProgressBar" class="hidden">
          <div id="scanProgressText"></div>
          <div style="background:#e2e8f0;border-radius:8px;overflow:hidden;height:8px;">
              <div id="scanProgressInner" style="width:0%;"></div>
          </div>
      </div>
      
      <!-- æ­¥éª¤1: é€‰æ‹©Unityé¡¹ç›®ç›®å½• -->
      <div class="step">
          <div class="step-title">
              <div class="step-number">1</div>
              é€‰æ‹©Unityé¡¹ç›®ç›®å½•
          </div>
          <div style="text-align:center;">
              <button id="pickDirBtn">ğŸ“‚ é€‰æ‹©Unityé¡¹ç›®æ ¹ç›®å½•</button>
              <div id="pickedDir" style="margin-top:15px;color:#718096;font-size:14px;font-weight:500;"></div>
              
              <!-- æ‰«æé€‰é¡¹ -->
              <div class="scan-options" style="margin-top: 20px; padding: 15px; background: #f8fafc; border-radius: 10px; border: 1px solid #e2e8f0;">
                  <div style="font-weight: 600; margin-bottom: 10px; color: #2d3748;">âš™ï¸ æ‰«æé€‰é¡¹</div>
                  <div style="display: flex; flex-direction: column; gap: 8px; text-align: left;">
                      <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                          <input type="radio" name="scanScope" value="full" checked style="accent-color: #667eea;">
                          <span>ğŸ” å®Œæ•´æ‰«æï¼ˆæ‰«ææ•´ä¸ªé¡¹ç›®ç›®å½•ï¼‰</span>
                      </label>
                      <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                          <input type="radio" name="scanScope" value="assets" style="accent-color: #667eea;">
                          <span>ğŸ¯ ä»…Assetsç›®å½•ï¼ˆæ¨èï¼Œè·³è¿‡Library/Tempç­‰ç³»ç»Ÿç›®å½•ï¼‰</span>
                      </label>
                      <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                          <input type="radio" name="scanScope" value="custom" style="accent-color: #667eea;">
                          <span>ğŸ“ è‡ªå®šä¹‰èŒƒå›´ï¼ˆæ‰‹åŠ¨é€‰æ‹©è¦æ‰«æçš„ç›®å½•ï¼‰</span>
                      </label>
                  </div>
              </div>
          </div>
      </div>

      <!-- æ­¥éª¤2: é€‰æ‹©ç›®æ ‡æ–‡ä»¶å¤¹ -->
      <div class="step hidden" id="step2">
          <div class="step-title">
              <div class="step-number">2</div>
              é€‰æ‹©è¦å¯¼å‡ºçš„ç›®æ ‡æ–‡ä»¶å¤¹
          </div>
          <div class="tree-controls">
              <button id="expandAllBtn">ğŸ“‚ å±•å¼€å…¨éƒ¨</button>
              <button id="collapseAllBtn">ğŸ“ æŠ˜å å…¨éƒ¨</button>
          </div>
          <div class="folder-tree" id="folderTree"></div>
          <div style="margin-top: 20px;">
              <span id="selectedFolder" style="color: #718096; font-size: 14px; font-weight: 500;"></span>
          </div>
      </div>

      <!-- æ­¥éª¤3: é€‰æ‹©æ–‡ä»¶æ ¼å¼å¹¶å¯¼å‡º -->
      <div class="step hidden" id="step3">
          <div class="step-title">
              <div class="step-number">3</div>
              é€‰æ‹©è¦å¯¼å‡ºçš„æ–‡ä»¶æ ¼å¼
          </div>
          <div class="format-selector">
              <div class="format-title">ğŸ¯ é€‰æ‹©è¦å¯¼å‡ºçš„èµ„æºç±»å‹ï¼ˆå¯å¤šé€‰ï¼‰</div>
              <div class="format-grid">
                  <div class="format-category">
                      <div class="category-title">ğŸ® æ¸¸æˆå¯¹è±¡</div>
                      <div class="format-option">
                          <input type="checkbox" id="prefab" value="prefab" checked>
                          <label for="prefab"><span class="format-icon icon-prefab"></span>Prefab (.prefab)</label>
                      </div>
                      <div class="format-option">
                          <input type="checkbox" id="unity" value="unity">
                          <label for="unity"><span class="format-icon icon-prefab"></span>åœºæ™¯ (.unity)</label>
                      </div>
                  </div>
                  <div class="format-category">
                      <div class="category-title">ğŸ–¼ï¸ å›¾åƒèµ„æº</div>
                      <div class="format-option">
                          <input type="checkbox" id="png" value="png">
                          <label for="png"><span class="format-icon icon-image"></span>PNG (.png)</label>
                      </div>
                      <div class="format-option">
                          <input type="checkbox" id="jpg" value="jpg">
                          <label for="jpg"><span class="format-icon icon-image"></span>JPG (.jpg/.jpeg)</label>
                      </div>
                      <div class="format-option">
                          <input type="checkbox" id="tga" value="tga">
                          <label for="tga"><span class="format-icon icon-image"></span>TGA (.tga)</label>
                      </div>
                      <div class="format-option">
                          <input type="checkbox" id="psd" value="psd">
                          <label for="psd"><span class="format-icon icon-image"></span>PSD (.psd)</label>
                      </div>
                  </div>
                  <div class="format-category">
                      <div class="category-title">ğŸµ éŸ³é¢‘èµ„æº</div>
                      <div class="format-option">
                          <input type="checkbox" id="wav" value="wav">
                          <label for="wav"><span class="format-icon icon-audio"></span>WAV (.wav)</label>
                      </div>
                      <div class="format-option">
                          <input type="checkbox" id="mp3" value="mp3">
                          <label for="mp3"><span class="format-icon icon-audio"></span>MP3 (.mp3)</label>
                      </div>
                      <div class="format-option">
                          <input type="checkbox" id="ogg" value="ogg">
                          <label for="ogg"><span class="format-icon icon-audio"></span>OGG (.ogg)</label>
                      </div>
                  </div>
                  <div class="format-category">
                      <div class="category-title">ğŸ² 3Dæ¨¡å‹</div>
                      <div class="format-option">
                          <input type="checkbox" id="fbx" value="fbx">
                          <label for="fbx"><span class="format-icon icon-model"></span>FBX (.fbx)</label>
                      </div>
                      <div class="format-option">
                          <input type="checkbox" id="obj" value="obj">
                          <label for="obj"><span class="format-icon icon-model"></span>OBJ (.obj)</label>
                      </div>
                      <div class="format-option">
                          <input type="checkbox" id="blend" value="blend">
                          <label for="blend"><span class="format-icon icon-model"></span>Blender (.blend)</label>
                      </div>
                  </div>
                  <div class="format-category">
                      <div class="category-title">ğŸ“ è„šæœ¬ä»£ç </div>
                      <div class="format-option">
                          <input type="checkbox" id="cs" value="cs">
                          <label for="cs"><span class="format-icon icon-script"></span>C# (.cs)</label>
                      </div>
                      <div class="format-option">
                          <input type="checkbox" id="js" value="js">
                          <label for="js"><span class="format-icon icon-script"></span>JavaScript (.js)</label>
                      </div>
                  </div>
                  <div class="format-category">
                      <div class="category-title">ğŸ“„ å…¶ä»–èµ„æº</div>
                      <div class="format-option">
                          <input type="checkbox" id="txt" value="txt">
                          <label for="txt"><span class="format-icon icon-other"></span>æ–‡æœ¬ (.txt)</label>
                      </div>
                      <div class="format-option">
                          <input type="checkbox" id="json" value="json">
                          <label for="json"><span class="format-icon icon-other"></span>JSON (.json)</label>
                      </div>
                      <div class="format-option">
                          <input type="checkbox" id="xml" value="xml">
                          <label for="xml"><span class="format-icon icon-other"></span>XML (.xml)</label>
                      </div>
                  </div>
              </div>
              <div class="quick-select">
                  <button id="selectAllBtn">âœ… å…¨é€‰</button>
                  <button id="clearAllBtn">âŒ æ¸…ç©º</button>
                  <button id="selectImageBtn">ğŸ–¼ï¸ é€‰æ‹©å›¾åƒ</button>
                  <button id="selectAudioBtn">ğŸµ é€‰æ‹©éŸ³é¢‘</button>
                  <button id="selectModelBtn">ğŸ² é€‰æ‹©æ¨¡å‹</button>
                  <button id="smartDetectBtn">ğŸ” æ™ºèƒ½æ£€æµ‹æ ¼å¼</button>
              </div>
          </div>
          <div style="text-align: center; margin-top: 25px;">
              <button id="showBtn" disabled>ğŸ” ç­›é€‰å¹¶é¢„è§ˆ</button>
              <button id="fieldSelectBtn" disabled>ğŸ“ é€‰æ‹©å¯¼å‡ºå­—æ®µ</button>
              <select id="exportFormat">
                  <option value="excel">Excel</option>
                  <option value="csv">CSV</option>
                  <option value="json">JSON</option>
              </select>
              <button id="exportBtn" disabled>ğŸ“Š å¯¼å‡º</button>
              <button id="copyAllPathsBtn" disabled>ğŸ“‹ å¤åˆ¶æ‰€æœ‰è·¯å¾„</button>
              <button id="resetBtn">ğŸ”„ é‡æ–°å¼€å§‹</button>
          </div>
      </div>

      <!-- æ­¥éª¤4: ç»“æœå±•ç¤º -->
      <div class="step hidden" id="step4">
          <div class="step-title">
              <div class="step-number">4</div>
              ç­›é€‰ç»“æœ
          </div>
          <div style="margin-bottom: 20px;">
              <input type="text" id="searchInput" placeholder="è¾“å…¥æ–‡ä»¶åæˆ–è·¯å¾„å…³é”®å­—è¿›è¡Œè¿‡æ»¤...">
          </div>
          <div class="stats hidden" id="stats"></div>
          
          <!-- å¯è§†åŒ–ç»Ÿè®¡å›¾è¡¨ -->
          <div class="visualization-panel hidden" id="visualPanel">
              <div class="step-title" style="margin-bottom: 20px;">
                  <div class="step-number">ğŸ“Š</div>
                  èµ„æºç»Ÿè®¡å¯è§†åŒ–
              </div>
              <div class="chart-controls" style="text-align: center; margin-bottom: 20px;">
                  <button id="showTypeChartBtn">ğŸ“Š æŒ‰ç±»å‹ç»Ÿè®¡</button>
                  <button id="showSizeChartBtn">ğŸ“ æŒ‰å¤§å°åˆ†å¸ƒ</button>
                  <button id="showFolderChartBtn">ğŸ“ æŒ‰æ–‡ä»¶å¤¹ç»Ÿè®¡</button>
                  <button id="hideChartsBtn">âŒ éšè—å›¾è¡¨</button>
              </div>
              <div class="charts-container">
                  <div class="chart-item hidden" id="typeChart">
                      <h4>æ–‡ä»¶ç±»å‹åˆ†å¸ƒ</h4>
                      <canvas id="typeChartCanvas" width="400" height="200"></canvas>
                  </div>
                  <div class="chart-item hidden" id="sizeChart">
                      <h4>æ–‡ä»¶å¤§å°åˆ†å¸ƒ</h4>
                      <canvas id="sizeChartCanvas" width="400" height="200"></canvas>
                  </div>
                  <div class="chart-item hidden" id="folderChart">
                      <h4>æ–‡ä»¶å¤¹åˆ†å¸ƒï¼ˆTop 10ï¼‰</h4>
                      <canvas id="folderChartCanvas" width="400" height="200"></canvas>
                  </div>
              </div>
          </div>
          <div class="batch-operations hidden" id="batchOperations">
              <div class="selected-count" id="selectedCount">å·²é€‰æ‹© 0 ä¸ªæ–‡ä»¶</div>
              <button id="selectAllBtn2">âœ… å…¨é€‰</button>
              <button id="clearSelectionBtn">âŒ å–æ¶ˆå…¨é€‰</button>
              <button id="copyPathsBtn" disabled>ğŸ“‹ å¤åˆ¶è·¯å¾„</button>
              <button id="exportSelectedBtn" disabled>ğŸ“Š å¯¼å‡ºé€‰ä¸­</button>
          </div>
          <div class="resource-list" id="resourceList"></div>
          <div id="pagination"></div>
      </div>

      <!-- æ­¥éª¤5: å»é‡ä¸å¼‚å¸¸æ£€æµ‹ -->
      <div class="step hidden" id="step5">
          <div class="step-title">
              <div class="step-number">5</div>
              èµ„æºå»é‡ä¸å¼‚å¸¸æ£€æµ‹
          </div>
          <div style="text-align: center; margin-bottom: 25px;">
              <button id="detectDuplicatesBtn">ğŸ” æ£€æµ‹é‡å¤èµ„æº</button>
              <button id="detectAnomaliesBtn">âš ï¸ æ£€æµ‹å¼‚å¸¸é—®é¢˜</button>
              <button id="runFullAnalysisBtn">ğŸ”¬ å®Œæ•´åˆ†æ</button>
          </div>
          
          <!-- å»é‡æ£€æµ‹ç»“æœ -->
          <div id="duplicateResults" class="hidden">
              <h3 style="color: #2d3748; margin-bottom: 20px;">ğŸ” é‡å¤èµ„æºæ£€æµ‹ç»“æœ</h3>
              <div id="duplicateStats" class="stats"></div>
              <div id="duplicateGroups" class="resource-list"></div>
          </div>
          
          <!-- å¼‚å¸¸æ£€æµ‹ç»“æœ -->
          <div id="anomalyResults" class="hidden">
              <h3 style="color: #2d3748; margin-bottom: 20px;">âš ï¸ å¼‚å¸¸é—®é¢˜æ£€æµ‹ç»“æœ</h3>
              <div id="anomalyStats" class="stats"></div>
              <div id="anomalyList" class="resource-list"></div>
          </div>
          
          <!-- åˆ†æå»ºè®® -->
          <div id="analysisAdvice" class="hidden">
              <h3 style="color: #2d3748; margin-bottom: 20px;">ğŸ’¡ ä¼˜åŒ–å»ºè®®</h3>
              <div id="adviceContent" class="format-selector"></div>
          </div>
      </div>

      <!-- æ­¥éª¤6: èµ„æºå¼•ç”¨å…³ç³»åˆ†æ -->
      <div class="step hidden" id="step6">
          <div class="step-title">
              <div class="step-number">6</div>
              èµ„æºå¼•ç”¨å…³ç³»åˆ†æ
          </div>
          <div style="text-align: center; margin-bottom: 25px;">
              <button id="analyzeReferencesBtn">ğŸ”— åˆ†æå¼•ç”¨å…³ç³»</button>
              <button id="findUnusedAssetsBtn">ğŸ—‘ï¸ æŸ¥æ‰¾æœªä½¿ç”¨èµ„æº</button>
              <button id="detectCircularDepsBtn">ğŸ”„ æ£€æµ‹å¾ªç¯ä¾èµ–</button>
              <button id="exportDependencyBtn" disabled>ğŸ“Š å¯¼å‡ºä¾èµ–æŠ¥å‘Š</button>
          </div>
          
          <!-- å¼•ç”¨å…³ç³»åˆ†æç»“æœ -->
          <div id="referenceResults" class="hidden">
              <h3 style="color: #2d3748; margin-bottom: 20px;">ğŸ”— å¼•ç”¨å…³ç³»åˆ†æç»“æœ</h3>
              <div id="referenceStats" class="stats"></div>
              
              <!-- ä¾èµ–å…³ç³»å›¾ -->
              <div class="dependency-graph hidden" id="dependencyGraph">
                  <h4>ğŸ“Š ä¾èµ–å…³ç³»å¯è§†åŒ–</h4>
                  <div class="graph-controls" style="margin-bottom: 15px;">
                      <button id="showGraphBtn">ğŸ“ˆ æ˜¾ç¤ºä¾èµ–å›¾</button>
                      <button id="hideGraphBtn">âŒ éšè—ä¾èµ–å›¾</button>
                      <select id="graphTypeSelect">
                          <option value="force">åŠ›å¯¼å‘å›¾</option>
                          <option value="tree">æ ‘çŠ¶å›¾</option>
                          <option value="circular">ç¯å½¢å›¾</option>
                      </select>
                  </div>
                  <div id="dependencyGraphContainer" style="width: 100%; height: 400px; border: 1px solid #e2e8f0; border-radius: 8px; background: #f8fafc;"></div>
              </div>
              
              <!-- è¯¦ç»†åˆ†æç»“æœ -->
              <div id="referenceDetails" class="resource-list"></div>
          </div>
          
          <!-- æœªä½¿ç”¨èµ„æºç»“æœ -->
          <div id="unusedResults" class="hidden">
              <h3 style="color: #2d3748; margin-bottom: 20px;">ğŸ—‘ï¸ æœªä½¿ç”¨èµ„æºæ£€æµ‹ç»“æœ</h3>
              <div id="unusedStats" class="stats"></div>
              <div id="unusedList" class="resource-list"></div>
          </div>
          
          <!-- å¾ªç¯ä¾èµ–ç»“æœ -->
          <div id="circularResults" class="hidden">
              <h3 style="color: #2d3748; margin-bottom: 20px;">ğŸ”„ å¾ªç¯ä¾èµ–æ£€æµ‹ç»“æœ</h3>
              <div id="circularStats" class="stats"></div>
              <div id="circularList" class="resource-list"></div>
          </div>
      </div>
  </div>

  <!-- å­—æ®µé€‰æ‹©å¼¹çª— -->
  <div id="fieldSelectModal" class="hidden">
    <div>
      <h3>é€‰æ‹©è¦å¯¼å‡ºçš„å­—æ®µ</h3>
      <div id="fieldCheckboxes"></div>
      <div style="text-align:right;">
        <button id="cancelFieldBtn" style="background:linear-gradient(45deg, #cbd5e0, #a0aec0);color:#4a5568;">å–æ¶ˆ</button>
        <button id="confirmFieldBtn" style="margin-left:12px;">ç¡®å®š</button>
      </div>
    </div>
  </div>

  <script>
    // å…¨å±€å˜é‡
    let dirHandle = null;
    let allFiles = [];
    let selectedFolderPath = '';
    let filteredFiles = [];
    let resourceData = [];
    let folderTreeRoot = null;
    let scanFileCount = 0;
    let scanDirCount = 0;
    let scanProgressActive = false;
    let currentPage = 1;
    let pageSize = 100;
    let lastDisplayFiles = [];
    let selectedItems = new Set(); // å­˜å‚¨é€‰ä¸­é¡¹çš„ç´¢å¼•
    
    // å»é‡å’Œå¼‚å¸¸æ£€æµ‹ç›¸å…³
    let duplicateGroups = [];
    let anomalyResults = [];
    let analysisInProgress = false;
    
    // å¼•ç”¨å…³ç³»åˆ†æç›¸å…³
    let assetGuidMap = new Map(); // GUID -> èµ„æºä¿¡æ¯
    let dependencyMap = new Map(); // èµ„æºè·¯å¾„ -> ä¾èµ–åˆ—è¡¨
    let reverseDepMap = new Map(); // èµ„æºè·¯å¾„ -> è¢«å¼•ç”¨åˆ—è¡¨
    let unusedAssets = [];
    let circularDependencies = [];
    
    // å­—æ®µå®šä¹‰
    const allFields = [
      {key:'æ–‡ä»¶åç§°', label:'æ–‡ä»¶åç§°', default:true},
      {key:'æ–‡ä»¶è·¯å¾„', label:'æ–‡ä»¶è·¯å¾„', default:true},
      {key:'æ–‡ä»¶ç±»å‹', label:'æ–‡ä»¶ç±»å‹', default:true},
      {key:'æ–‡ä»¶å¤§å°', label:'æ–‡ä»¶å¤§å°(Byte)', default:false},
      {key:'ä¿®æ”¹æ—¶é—´', label:'ä¿®æ”¹æ—¶é—´', default:false},
      {key:'çˆ¶æ–‡ä»¶å¤¹', label:'çˆ¶æ–‡ä»¶å¤¹', default:false},
      {key:'é‡å¤çŠ¶æ€', label:'é‡å¤çŠ¶æ€', default:false},
      {key:'å¼‚å¸¸ä¿¡æ¯', label:'å¼‚å¸¸ä¿¡æ¯', default:false}
    ];
    let selectedFields = [];
    
    // åˆå§‹åŒ–
    function init() {
      loadFieldSelect();
      bindEvents();
      checkCompatibility();
      // ç¡®ä¿å¼¹çª—åˆå§‹çŠ¶æ€éšè—
      document.getElementById('fieldSelectModal').classList.add('hidden');
    }
    
    // æ£€æŸ¥æµè§ˆå™¨å…¼å®¹æ€§
    function checkCompatibility() {
      const warningDiv = document.getElementById('compatibilityWarning');
      const dismissBtn = document.getElementById('dismissWarning');
      
      // æ£€æŸ¥æ˜¯å¦å·²ç»å…³é—­è¿‡æç¤º
      if (localStorage.getItem('unity_tool_warning_dismissed') === 'true') {
        warningDiv.classList.add('hidden');
        return;
      }
      
      // æ£€æŸ¥æµè§ˆå™¨æ”¯æŒ
      const isSupported = 'showDirectoryPicker' in window;
      const userAgent = navigator.userAgent;
      const isChrome = /Chrome/.test(userAgent) && !/Edge/.test(userAgent);
      const isEdge = /Edge/.test(userAgent);
      const isSafari = /Safari/.test(userAgent) && !/Chrome/.test(userAgent);
      const isFirefox = /Firefox/.test(userAgent);
      
      if (!isSupported || isFirefox) {
        // æ›´æ–°è­¦å‘Šå†…å®¹ä¸ºä¸å…¼å®¹
        const warningHeader = warningDiv.querySelector('.warning-header strong');
        const warningBody = warningDiv.querySelector('.warning-body');
        
        warningHeader.textContent = 'âŒ æµè§ˆå™¨ä¸å…¼å®¹è­¦å‘Š';
        warningDiv.style.background = 'linear-gradient(135deg, #f8d7da, #f5c6cb)';
        warningDiv.style.borderColor = '#dc3545';
        
        warningBody.innerHTML = `
          <p><strong>æŠ±æ­‰ï¼Œæ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒæœ¬å·¥å…·æ‰€éœ€çš„ File System Access APIã€‚</strong></p>
          <div class="browser-support">
              <div class="supported">
                  <strong>âœ… è¯·ä½¿ç”¨ä»¥ä¸‹æµè§ˆå™¨ï¼š</strong>
                  <ul>
                      <li>Chrome 86+ (å¼ºçƒˆæ¨è)</li>
                      <li>Microsoft Edge 86+</li>
                      <li>Safari 15.2+ (macOS)</li>
                  </ul>
              </div>
              <div class="not-supported">
                  <strong>âŒ å½“å‰æµè§ˆå™¨ï¼š</strong>
                  <ul>
                      <li>${isFirefox ? 'Firefox (ä¸æ”¯æŒ)' : 'æœªçŸ¥æµè§ˆå™¨'}</li>
                      <li>å»ºè®®åˆ‡æ¢åˆ°Chromeæµè§ˆå™¨</li>
                  </ul>
              </div>
          </div>
          <div class="security-note">
              <strong>ğŸ“± å¦‚ä½•è§£å†³ï¼š</strong>
              <ul>
                  <li>ä¸‹è½½å¹¶å®‰è£… Google Chrome æµè§ˆå™¨</li>
                  <li>æˆ–ä½¿ç”¨ Microsoft Edge æµè§ˆå™¨</li>
                  <li>macOS ç”¨æˆ·å¯ä»¥ä½¿ç”¨ Safari 15.2+</li>
                  <li>ç„¶åé‡æ–°è®¿é—®æœ¬å·¥å…·</li>
              </ul>
          </div>
        `;
      }
      
      // ç»‘å®šå…³é—­äº‹ä»¶
      dismissBtn.onclick = function() {
        warningDiv.classList.add('hidden');
        localStorage.setItem('unity_tool_warning_dismissed', 'true');
      };
    }
    
    // è¯»å–æœ¬åœ°å­—æ®µé€‰æ‹©
    function loadFieldSelect() {
      let saved = localStorage.getItem('unity_asset_export_fields');
      if (saved) {
        try {
          selectedFields = JSON.parse(saved);
        } catch(e) {
          selectedFields = [];
        }
      }
      if (!selectedFields || !Array.isArray(selectedFields) || selectedFields.length === 0) {
        selectedFields = allFields.filter(f => f.default).map(f => f.key);
      }
    }
    
    // ç»‘å®šäº‹ä»¶
    function bindEvents() {
      // ä¸»è¦æŒ‰é’®äº‹ä»¶
      document.getElementById('pickDirBtn').onclick = pickDirectory;
      document.getElementById('expandAllBtn').onclick = expandAll;
      document.getElementById('collapseAllBtn').onclick = collapseAll;
      document.getElementById('showBtn').onclick = showResults;
      document.getElementById('fieldSelectBtn').onclick = openFieldSelect;
      document.getElementById('exportBtn').onclick = exportData;
      document.getElementById('copyAllPathsBtn').onclick = copyAllPaths;
      document.getElementById('resetBtn').onclick = resetTool;
      
      // å¿«æ·é€‰æ‹©æŒ‰é’®
      document.getElementById('selectAllBtn').onclick = selectAllFormats;
      document.getElementById('clearAllBtn').onclick = clearAllFormats;
      document.getElementById('selectImageBtn').onclick = selectImageFormats;
      document.getElementById('selectAudioBtn').onclick = selectAudioFormats;
      document.getElementById('selectModelBtn').onclick = selectModelFormats;
      document.getElementById('smartDetectBtn').onclick = smartDetectFormats;
      
      // å­—æ®µé€‰æ‹©å¼¹çª—
      document.getElementById('cancelFieldBtn').onclick = closeFieldSelect;
      document.getElementById('confirmFieldBtn').onclick = applyFieldSelect;
      
      // æ‰¹é‡æ“ä½œæŒ‰é’®
      document.getElementById('selectAllBtn2').onclick = selectAllItems;
      document.getElementById('clearSelectionBtn').onclick = clearSelection;
      document.getElementById('copyPathsBtn').onclick = copySelectedPaths;
      document.getElementById('exportSelectedBtn').onclick = exportSelectedItems;
      
      // å»é‡å’Œå¼‚å¸¸æ£€æµ‹æŒ‰é’®
      document.getElementById('detectDuplicatesBtn').onclick = detectDuplicates;
      document.getElementById('detectAnomaliesBtn').onclick = detectAnomalies;
      document.getElementById('runFullAnalysisBtn').onclick = runFullAnalysis;
      
      // å¯è§†åŒ–å›¾è¡¨æŒ‰é’®
      document.getElementById('showTypeChartBtn').onclick = showTypeChart;
      document.getElementById('showSizeChartBtn').onclick = showSizeChart;
      document.getElementById('showFolderChartBtn').onclick = showFolderChart;
      document.getElementById('hideChartsBtn').onclick = hideCharts;
      
      // å¼•ç”¨å…³ç³»åˆ†ææŒ‰é’®
      document.getElementById('analyzeReferencesBtn').onclick = analyzeReferences;
      document.getElementById('findUnusedAssetsBtn').onclick = findUnusedAssets;
      document.getElementById('detectCircularDepsBtn').onclick = detectCircularDependencies;
      document.getElementById('exportDependencyBtn').onclick = exportDependencyReport;
      
      // æœç´¢è¾“å…¥æ¡†
      document.getElementById('searchInput').addEventListener('input', function() {
        currentPage = 1;
        selectedItems.clear();
        updateBatchOperations();
        renderFilteredResults();
      });
      
      // é¡µé¢å¸è½½æ—¶æ¸…ç†
      window.addEventListener('beforeunload', function() {
        if(window._previewBlobUrls) {
          window._previewBlobUrls.forEach(url => URL.revokeObjectURL(url));
          window._previewBlobUrls = [];
        }
      });
    }
    
    // è¿›åº¦æ¡ç›¸å…³
    function showScanProgress() {
      document.getElementById('scanProgressBar').classList.remove('hidden');
      updateScanProgress();
    }
    
    function hideScanProgress() {
      document.getElementById('scanProgressBar').classList.add('hidden');
    }
    
    function updateScanProgress(currentDir) {
      const text = `å·²æ‰«æ <b>${scanFileCount}</b> ä¸ªæ–‡ä»¶ï¼Œ<b>${scanDirCount}</b> ä¸ªæ–‡ä»¶å¤¹${currentDir ? 'ï¼Œå½“å‰ç›®å½•ï¼š' + currentDir : ''}`;
      document.getElementById('scanProgressText').innerHTML = text;
      if (scanProgressActive) {
        const percent = (scanFileCount % 100) + 1;
        document.getElementById('scanProgressInner').style.width = percent + '%';
      } else {
        document.getElementById('scanProgressInner').style.width = '0%';
      }
    }
    
    // é€‰æ‹©ç›®å½•
    async function pickDirectory() {
      if (!window.showDirectoryPicker) {
        alert('ä½ çš„æµè§ˆå™¨ä¸æ”¯æŒæœ¬åœ°ç›®å½•è®¿é—®ï¼ˆFile System Access APIï¼‰ã€‚è¯·ä½¿ç”¨æœ€æ–°ç‰ˆ Chromeã€Edge æˆ– Safariã€‚');
        return;
      }
      
      try {
        dirHandle = await window.showDirectoryPicker();
        document.getElementById('pickedDir').textContent = 'å·²é€‰æ‹©ç›®å½•: ' + dirHandle.name;
        document.getElementById('step2').classList.remove('hidden');
        
        // é‡ç½®çŠ¶æ€
        allFiles = [];
        selectedFolderPath = '';
        filteredFiles = [];
        resourceData = [];
        folderTreeRoot = null;
        document.getElementById('step3').classList.add('hidden');
        document.getElementById('step4').classList.add('hidden');
        
        // æ˜¾ç¤ºå¼€å§‹æ‰«ææŒ‰é’®
        showStartScanButton();
        
      } catch (e) {
        console.log('ç”¨æˆ·å–æ¶ˆé€‰æ‹©ç›®å½•');
      }
    }
    
    // æ˜¾ç¤ºå¼€å§‹æ‰«ææŒ‰é’®
    function showStartScanButton() {
      const existingBtn = document.getElementById('startScanBtn');
      if (existingBtn) {
        existingBtn.remove();
      }
      
      const scanOptions = document.querySelector('.scan-options');
      const startBtn = document.createElement('button');
      startBtn.id = 'startScanBtn';
      startBtn.innerHTML = 'ğŸš€ å¼€å§‹æ‰«æ';
      startBtn.style.cssText = `
        background: linear-gradient(45deg, #4CAF50, #45a049);
        font-size: 16px;
        padding: 12px 24px;
        margin-top: 15px;
        width: 100%;
        box-shadow: 0 4px 15px rgba(76, 175, 80, 0.3);
      `;
      startBtn.onclick = startScanning;
      scanOptions.appendChild(startBtn);
    }
    
    // å¼€å§‹æ‰«æ
    async function startScanning() {
      if (!dirHandle) {
        alert('è¯·å…ˆé€‰æ‹©Unityé¡¹ç›®ç›®å½•');
        return;
      }
      
      // éšè—å¼€å§‹æ‰«ææŒ‰é’®
      const startBtn = document.getElementById('startScanBtn');
      if (startBtn) {
        startBtn.style.display = 'none';
      }
      
      // é‡ç½®æ‰«æçŠ¶æ€
      scanFileCount = 0;
      scanDirCount = 0;
      scanProgressActive = true;
      showScanProgress();
      
      try {
        await initFolderTree();
        scanProgressActive = false;
        hideScanProgress();
      } catch (e) {
        scanProgressActive = false;
        hideScanProgress();
        console.error('æ‰«æè¿‡ç¨‹ä¸­å‡ºé”™:', e);
        alert('æ‰«æè¿‡ç¨‹ä¸­å‡ºç°é”™è¯¯ï¼Œè¯·é‡è¯•');
        
        // é‡æ–°æ˜¾ç¤ºå¼€å§‹æ‰«ææŒ‰é’®
        if (startBtn) {
          startBtn.style.display = 'block';
        }
      }
    }
    
    // æ‡’åŠ è½½æ–‡ä»¶å¤¹æ ‘
    async function buildLazyFolderTree(handle, pathPrefix = '', pathArr = []) {
      const entries = [];
      for await (const entry of handle.values()) {
        entries.push(entry);
      }
      
      const folders = [];
      const files = [];
      
      for (const entry of entries) {
        if (entry.kind === 'directory') {
          folders.push({
            name: entry.name,
            path: pathPrefix + entry.name,
            handle: entry,
            loaded: false,
            children: [],
            parent: pathArr.length ? pathArr.join('/') : null,
            expanded: false,
            fileCount: 0
          });
        } else if (entry.kind === 'file') {
          files.push({
            name: entry.name,
            path: pathPrefix + entry.name,
            ext: entry.name.includes('.') ? entry.name.split('.').pop().toLowerCase() : '',
            pathArr: [...pathArr, entry.name],
            size: '',
            lastModified: '',
            parentFolder: pathArr.length > 0 ? pathArr[pathArr.length - 1] : ''
          });
        }
      }
      
      return {folders, files};
    }
    
    // åˆå§‹åŒ–æ–‡ä»¶å¤¹æ ‘
    async function initFolderTree() {
      if (!dirHandle) return;
      
      // è·å–æ‰«æèŒƒå›´
      const scanScope = document.querySelector('input[name="scanScope"]:checked').value;
      let scanHandle = dirHandle;
      let scanPath = '';
      
      if (scanScope === 'assets') {
        // å°è¯•æ‰¾åˆ°Assetsæ–‡ä»¶å¤¹
        try {
          scanHandle = await dirHandle.getDirectoryHandle('Assets');
          scanPath = 'Assets/';
          console.log('ä½¿ç”¨Assetsç›®å½•æ‰«æ');
        } catch (e) {
          console.warn('æœªæ‰¾åˆ°Assetsæ–‡ä»¶å¤¹ï¼Œä½¿ç”¨å®Œæ•´æ‰«æ');
          alert('âš ï¸ æœªæ‰¾åˆ°Assetsæ–‡ä»¶å¤¹ï¼Œå°†ä½¿ç”¨å®Œæ•´æ‰«ææ¨¡å¼ã€‚\nè¯·ç¡®ä¿é€‰æ‹©çš„æ˜¯Unityé¡¹ç›®æ ¹ç›®å½•ã€‚');
        }
      }
      
      const {folders} = await buildLazyFolderTree(scanHandle, scanPath, scanPath ? ['Assets'] : []);
      folderTreeRoot = folders.map(f => ({...f}));
      renderFolderTree();
      
      // æ‰«æå®Œæˆæç¤º
      if (allFiles.length > 0) {
        const scopeText = scanScope === 'assets' ? 'ï¼ˆä»…Assetsç›®å½•ï¼‰' : 
                         scanScope === 'custom' ? 'ï¼ˆè‡ªå®šä¹‰èŒƒå›´ï¼‰' : 'ï¼ˆå®Œæ•´é¡¹ç›®ï¼‰';
        const summary = `âœ… æ‰«æå®Œæˆ${scopeText}ï¼å‘ç° ${scanFileCount} ä¸ªæ–‡ä»¶ï¼Œ${scanDirCount} ä¸ªæ–‡ä»¶å¤¹`;
        document.getElementById('scanProgressText').innerHTML = summary;
        
        // 3ç§’åéšè—è¿›åº¦æ¡
        setTimeout(() => {
          hideScanProgress();
        }, 3000);
      }
    }
    
    // æ‡’åŠ è½½å­ç›®å½•
    async function loadFolderChildren(folder) {
      if (folder.loaded) return;
      
      const {folders, files} = await buildLazyFolderTree(
        folder.handle, 
        folder.path + '/', 
        folder.path ? folder.path.split('/') : []
      );
      
      folder.children = folders;
      folder.loaded = true;
      folder.fileCount = files.length;
    }
    
    // æ¸²æŸ“æ–‡ä»¶å¤¹æ ‘
    function renderFolderTree() {
      const folderTree = document.getElementById('folderTree');
      folderTree.innerHTML = '';
      
      if (!folderTreeRoot) return;
      
      folderTreeRoot.forEach(rootFolder => {
        renderFolderNodeLazy(rootFolder, folderTree, 0);
      });
    }
    
    // æ¸²æŸ“æ–‡ä»¶å¤¹èŠ‚ç‚¹
    function renderFolderNodeLazy(folder, container, depth) {
      const folderItem = document.createElement('div');
      folderItem.className = 'folder-item' + (selectedFolderPath === folder.path ? ' selected' : '');
      folderItem.dataset.path = folder.path;
      
      const indent = 'ã€€'.repeat(depth);
      folderItem.innerHTML = `
        <div class="folder-content">
          <div class="folder-toggle ${folder.expanded ? 'expanded' : ''}">${folder.expanded ? 'â–¼' : 'â–¶'}</div>
          <span class="folder-icon">ğŸ“</span>
          <span class="folder-name">${indent}${folder.name}</span>
          ${folder.fileCount > 0 ? `<span class="file-count">${folder.fileCount}</span>` : ''}
        </div>
      `;
      
      // å±•å¼€/æŠ˜å äº‹ä»¶
      folderItem.querySelector('.folder-toggle').onclick = async (e) => {
        e.stopPropagation();
        if (!folder.expanded) {
          await loadFolderChildren(folder);
        }
        folder.expanded = !folder.expanded;
        renderFolderTree();
      };
      
      // é€‰æ‹©æ–‡ä»¶å¤¹äº‹ä»¶
      folderItem.addEventListener('click', function(e) {
        if (e.target.classList.contains('folder-toggle')) return;
        
        document.querySelectorAll('.folder-item').forEach(item => {
          item.classList.remove('selected');
        });
        
        this.classList.add('selected');
        selectedFolderPath = this.dataset.path;
        document.getElementById('selectedFolder').textContent = `å·²é€‰æ‹©: ${selectedFolderPath}`;
        document.getElementById('step3').classList.remove('hidden');
        document.getElementById('showBtn').disabled = false;
        document.getElementById('fieldSelectBtn').disabled = false;
        document.getElementById('exportBtn').disabled = false;
        document.getElementById('copyAllPathsBtn').disabled = false;
        document.getElementById('step4').classList.add('hidden');
      });
      
      container.appendChild(folderItem);
      
      // æ¸²æŸ“å­æ–‡ä»¶å¤¹
      if (folder.expanded && folder.children && folder.children.length > 0) {
        const childrenContainer = document.createElement('div');
        childrenContainer.className = 'folder-children';
        
        folder.children.forEach(childFolder => {
          renderFolderNodeLazy(childFolder, childrenContainer, depth + 1);
        });
        
        container.appendChild(childrenContainer);
      }
    }
    
    // å±•å¼€/æŠ˜å æ‰€æœ‰æ–‡ä»¶å¤¹
    function expandAll() {
      // æ‡’åŠ è½½æƒ…å†µä¸‹ï¼Œåªèƒ½å±•å¼€å·²åŠ è½½çš„
      if (folderTreeRoot) {
        expandFolderRecursive(folderTreeRoot);
        renderFolderTree();
      }
    }
    
    function collapseAll() {
      if (folderTreeRoot) {
        collapseFolderRecursive(folderTreeRoot);
        renderFolderTree();
      }
    }
    
    function expandFolderRecursive(folders) {
      folders.forEach(folder => {
        folder.expanded = true;
        if (folder.children && folder.children.length > 0) {
          expandFolderRecursive(folder.children);
        }
      });
    }
    
    function collapseFolderRecursive(folders) {
      folders.forEach(folder => {
        folder.expanded = false;
        if (folder.children && folder.children.length > 0) {
          collapseFolderRecursive(folder.children);
        }
      });
    }
    
    // æ ¼å¼é€‰æ‹©ç›¸å…³
    function getSelectedFormats() {
      const checkboxes = document.querySelectorAll('.format-option input[type="checkbox"]:checked');
      return Array.from(checkboxes).map(cb => cb.value);
    }
    
    function selectAllFormats() {
      document.querySelectorAll('.format-option input[type="checkbox"]').forEach(cb => cb.checked = true);
    }
    
    function clearAllFormats() {
      document.querySelectorAll('.format-option input[type="checkbox"]').forEach(cb => cb.checked = false);
    }
    
    function selectImageFormats() {
      clearAllFormats();
      ['png','jpg','tga','psd'].forEach(id => {
        const el = document.getElementById(id);
        if (el) el.checked = true;
      });
    }
    
    function selectAudioFormats() {
      clearAllFormats();
      ['wav','mp3','ogg'].forEach(id => {
        const el = document.getElementById(id);
        if (el) el.checked = true;
      });
    }
    
    function selectModelFormats() {
      clearAllFormats();
      ['fbx','obj','blend'].forEach(id => {
        const el = document.getElementById(id);
        if (el) el.checked = true;
      });
    }
    
    // æ™ºèƒ½æ ¼å¼æ£€æµ‹
    function smartDetectFormats() {
      if (!selectedFolderPath || allFiles.length === 0) {
        alert('è¯·å…ˆé€‰æ‹©æ–‡ä»¶å¤¹å¹¶ç­‰å¾…æ‰«æå®Œæˆ');
        return;
      }
      
      // è·å–é€‰ä¸­æ–‡ä»¶å¤¹ä¸‹çš„æ‰€æœ‰æ–‡ä»¶
      const folderFiles = allFiles.filter(f => f.path.startsWith(selectedFolderPath + '/'));
      
      if (folderFiles.length === 0) {
        alert('é€‰ä¸­çš„æ–‡ä»¶å¤¹ä¸­æ²¡æœ‰æ‰¾åˆ°æ–‡ä»¶ï¼Œè¯·é€‰æ‹©å…¶ä»–æ–‡ä»¶å¤¹');
        return;
      }
      
      // ç»Ÿè®¡æ–‡ä»¶æ ¼å¼
      const extCounts = {};
      folderFiles.forEach(f => {
        if (f.ext) {
          extCounts[f.ext] = (extCounts[f.ext] || 0) + 1;
        }
      });
      
      // æ¸…ç©ºå½“å‰é€‰æ‹©
      clearAllFormats();
      
      // å®šä¹‰å·¥å…·æ”¯æŒçš„æ ¼å¼æ˜ å°„
      const formatMap = {
        'prefab': 'prefab',
        'unity': 'unity',
        'png': 'png',
        'jpg': 'jpg',
        'jpeg': 'jpg',
        'tga': 'tga',
        'psd': 'psd',
        'wav': 'wav',
        'mp3': 'mp3',
        'ogg': 'ogg',
        'fbx': 'fbx',
        'obj': 'obj',
        'blend': 'blend',
        'cs': 'cs',
        'js': 'js',
        'txt': 'txt',
        'json': 'json',
        'xml': 'xml'
      };
      
      // è‡ªåŠ¨é€‰æ‹©å­˜åœ¨çš„æ ¼å¼
      let selectedCount = 0;
      const detectedFormats = [];
      
      Object.entries(extCounts).forEach(([ext, count]) => {
        if (formatMap[ext]) {
          const checkbox = document.getElementById(formatMap[ext]);
          if (checkbox) {
            checkbox.checked = true;
            selectedCount++;
            detectedFormats.push(`${ext.toUpperCase()}(${count}ä¸ª)`);
          }
        }
      });
      
      // æ˜¾ç¤ºæ£€æµ‹ç»“æœ
      if (selectedCount > 0) {
        alert(`ğŸ¯ æ™ºèƒ½æ£€æµ‹å®Œæˆï¼\n\n` +
              `åœ¨æ–‡ä»¶å¤¹"${selectedFolderPath}"ä¸­æ£€æµ‹åˆ°ä»¥ä¸‹æ ¼å¼ï¼š\n` +
              `${detectedFormats.join(', ')}\n\n` +
              `å·²è‡ªåŠ¨ä¸ºæ‚¨é€‰æ‹©è¿™äº›æ ¼å¼ï¼Œæ‚¨å¯ä»¥ç›´æ¥ç‚¹å‡»"ç­›é€‰å¹¶é¢„è§ˆ"ã€‚`);
      } else {
        // æ˜¾ç¤ºæ‰€æœ‰æ£€æµ‹åˆ°çš„æ ¼å¼
        const allFormats = Object.entries(extCounts)
          .sort((a, b) => b[1] - a[1])
          .slice(0, 10)
          .map(([ext, count]) => `${ext || '(æ— æ‰©å±•å)'}: ${count}ä¸ª`)
          .join('\n');
        
        alert(`âŒ æœªæ£€æµ‹åˆ°å·¥å…·æ”¯æŒçš„æ ¼å¼\n\n` +
              `è¯¥æ–‡ä»¶å¤¹ä¸­çš„æ–‡ä»¶æ ¼å¼åˆ†å¸ƒï¼š\n${allFormats}\n\n` +
              `å»ºè®®ï¼š\n1. é€‰æ‹©Unityé¡¹ç›®çš„Assetsæ–‡ä»¶å¤¹\n2. æ‰‹åŠ¨é€‰æ‹©éœ€è¦çš„æ ¼å¼`);
      }
    }
    
    // æ‰«æé€‰ä¸­æ–‡ä»¶å¤¹çš„æ–‡ä»¶
    async function scanSelectedFolder() {
      if (!selectedFolderPath || !dirHandle) return [];
      
      const files = [];
      const pathParts = selectedFolderPath.split('/');
      
      let currentHandle = dirHandle;
      for (const part of pathParts) {
        currentHandle = await currentHandle.getDirectoryHandle(part);
      }
      
      await scanDirRecursive(currentHandle, selectedFolderPath + '/', pathParts);
      return allFiles.filter(f => f.path.startsWith(selectedFolderPath + '/'));
    }
    
    async function scanDirRecursive(handle, pathPrefix, pathArr) {
      scanDirCount++;
      updateScanProgress(pathPrefix);
      
      let batch = 0;
      const entries = [];
      
      try {
        for await (const entry of handle.values()) {
          entries.push(entry);
        }
      } catch (e) {
        console.warn('æ— æ³•è¯»å–ç›®å½•:', pathPrefix, e);
        return;
      }
      
      for (let i = 0; i < entries.length; i++) {
        const entry = entries[i];
        
        try {
          if (entry.kind === 'file') {
            let fileObj = {
              name: entry.name,
              path: pathPrefix + entry.name,
              ext: entry.name.includes('.') ? entry.name.split('.').pop().toLowerCase() : '',
              pathArr: [...pathArr, entry.name],
              size: 0,
              lastModified: '',
              parentFolder: pathArr.length > 0 ? pathArr[pathArr.length - 1] : ''
            };
            
            try {
              const file = await entry.getFile();
              fileObj.size = file.size;
              fileObj.lastModified = new Date(file.lastModified).toLocaleString();
            } catch(e) {
              console.warn('æ— æ³•è·å–æ–‡ä»¶ä¿¡æ¯:', entry.name, e);
              // å³ä½¿æ— æ³•è·å–è¯¦ç»†ä¿¡æ¯ï¼Œä¹Ÿä¿ç•™æ–‡ä»¶è®°å½•
            }
            
            allFiles.push(fileObj);
            scanFileCount++;
            
            // æ·»åŠ è°ƒè¯•æ—¥å¿—ï¼ˆä»…åœ¨æ§åˆ¶å°æ˜¾ç¤ºï¼‰
            if (scanFileCount <= 10) {
              console.log('æ‰«æåˆ°æ–‡ä»¶:', fileObj.path, 'æ ¼å¼:', fileObj.ext);
            }
            
          } else if (entry.kind === 'directory') {
            // è·³è¿‡ä¸€äº›ç³»ç»Ÿç›®å½•
            const skipDirs = ['.git', '.svn', 'node_modules', '.DS_Store', 'Temp', 'Library'];
            if (!skipDirs.includes(entry.name)) {
              await scanDirRecursive(entry, pathPrefix + entry.name + '/', [...pathArr, entry.name]);
            }
          }
        } catch (e) {
          console.warn('å¤„ç†æ¡ç›®å¤±è´¥:', entry.name, e);
          continue;
        }
        
        batch++;
        if (batch % 30 === 0) {
          updateScanProgress(pathPrefix);
          await new Promise(res => setTimeout(res, 0));
        }
      }
      
      updateScanProgress(pathPrefix);
    }
    
    // æ˜¾ç¤ºç­›é€‰ç»“æœ
    async function showResults() {
      if (!selectedFolderPath) {
        alert('è¯·å…ˆé€‰æ‹©ç›®æ ‡æ–‡ä»¶å¤¹');
        return;
      }
      
      const selectedFormats = getSelectedFormats();
      if (selectedFormats.length === 0) {
        alert('è¯·è‡³å°‘é€‰æ‹©ä¸€ç§æ–‡ä»¶æ ¼å¼ï¼');
        return;
      }
      
      // å¦‚æœè¿˜æ²¡æœ‰æ‰«æè¿‡é€‰ä¸­æ–‡ä»¶å¤¹ï¼Œå…ˆæ‰«æ
      if (allFiles.length === 0 || !allFiles.some(f => f.path.startsWith(selectedFolderPath + '/'))) {
        scanFileCount = 0;
        scanDirCount = 0;
        scanProgressActive = true;
        showScanProgress();
        
        await scanSelectedFolder();
        
        scanProgressActive = false;
        hideScanProgress();
      }
      
      // ç­›é€‰æ–‡ä»¶
      filteredFiles = allFiles.filter(file => {
        if (!file.path.startsWith(selectedFolderPath + '/')) return false;
        
        if (selectedFormats.includes(file.ext)) return true;
        if (selectedFormats.includes('jpg') && (file.ext === 'jpg' || file.ext === 'jpeg')) return true;
        
        return false;
      });
      
      if (filteredFiles.length === 0) {
        // æ·»åŠ è¯¦ç»†çš„è°ƒè¯•ä¿¡æ¯
        const debugInfo = `
          <div style="text-align: center; color: #718096; padding: 40px;">
            <div style="font-size: 18px; margin-bottom: 20px;">âŒ æœªæ‰¾åˆ°ä»»ä½•ç›®æ ‡æ ¼å¼çš„æ–‡ä»¶</div>
            <div style="background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 8px; padding: 20px; margin: 20px auto; max-width: 600px; text-align: left;">
              <h4 style="margin-top: 0; color: #2d3748;">ğŸ“Š æ‰«æç»Ÿè®¡ä¿¡æ¯ï¼š</h4>
              <p><strong>é€‰æ‹©çš„æ–‡ä»¶å¤¹ï¼š</strong> ${selectedFolderPath || 'æœªé€‰æ‹©'}</p>
              <p><strong>æ‰«æåˆ°çš„æ€»æ–‡ä»¶æ•°ï¼š</strong> ${allFiles.length}</p>
              <p><strong>é€‰æ‹©çš„æ ¼å¼ï¼š</strong> ${selectedFormats.join(', ') || 'æœªé€‰æ‹©'}</p>
              <p><strong>è¯¥æ–‡ä»¶å¤¹ä¸‹çš„æ–‡ä»¶æ•°ï¼š</strong> ${allFiles.filter(f => f.path.startsWith(selectedFolderPath + '/')).length}</p>
              ${allFiles.length > 0 ? `
                <h4 style="color: #2d3748;">ğŸ“ æ–‡ä»¶å¤¹ä¸‹çš„æ–‡ä»¶ç±»å‹åˆ†å¸ƒï¼š</h4>
                <div style="font-size: 12px; color: #4a5568;">
                  ${(() => {
                    const folderFiles = allFiles.filter(f => f.path.startsWith(selectedFolderPath + '/'));
                    const extCounts = {};
                    folderFiles.forEach(f => {
                      extCounts[f.ext] = (extCounts[f.ext] || 0) + 1;
                    });
                    return Object.entries(extCounts)
                      .sort((a, b) => b[1] - a[1])
                      .slice(0, 10)
                      .map(([ext, count]) => `${ext || '(æ— æ‰©å±•å)'}: ${count}ä¸ª`)
                      .join('<br>');
                  })()}
                </div>
              ` : ''}
            </div>
            <div style="margin-top: 20px;">
              <h4 style="color: #2d3748;">ğŸ’¡ å¯èƒ½çš„è§£å†³æ–¹æ¡ˆï¼š</h4>
              <div style="text-align: left; max-width: 500px; margin: 0 auto; color: #4a5568;">
                <p>1. ç¡®è®¤é€‰æ‹©çš„æ–‡ä»¶å¤¹ä¸­ç¡®å®åŒ…å«ç›®æ ‡æ ¼å¼çš„æ–‡ä»¶</p>
                <p>2. æ£€æŸ¥æ˜¯å¦é€‰æ‹©äº†æ­£ç¡®çš„æ–‡ä»¶æ ¼å¼</p>
                <p>3. å°è¯•é€‰æ‹©é¡¹ç›®çš„æ ¹ç›®å½•æˆ–Assetsæ–‡ä»¶å¤¹</p>
                <p>4. å¦‚æœæ˜¯åˆšæ‰«æçš„é¡¹ç›®ï¼Œè¯·ç­‰å¾…æ‰«æå®Œæˆ</p>
              </div>
            </div>
          </div>
        `;
        document.getElementById('resourceList').innerHTML = debugInfo;
        document.getElementById('stats').style.display = 'none';
        document.getElementById('step4').classList.remove('hidden');
        return;
      }
      
      // æ„å»ºèµ„æºæ•°æ®
      resourceData = filteredFiles.map(f => ({
        'æ–‡ä»¶åç§°': f.name,
        'æ–‡ä»¶è·¯å¾„': f.path,
        'æ–‡ä»¶ç±»å‹': f.ext.toUpperCase(),
        'æ–‡ä»¶å¤§å°': f.size,
        'ä¿®æ”¹æ—¶é—´': f.lastModified,
        'çˆ¶æ–‡ä»¶å¤¹': f.parentFolder,
        'é‡å¤çŠ¶æ€': 'æœªæ£€æµ‹',
        'å¼‚å¸¸ä¿¡æ¯': 'æœªæ£€æµ‹'
      }));
      
      currentPage = 1;
      document.getElementById('step4').classList.remove('hidden');
      document.getElementById('step5').classList.remove('hidden'); // æ˜¾ç¤ºæ­¥éª¤5
      document.getElementById('step6').classList.remove('hidden'); // æ˜¾ç¤ºæ­¥éª¤6
      document.getElementById('visualPanel').classList.remove('hidden'); // æ˜¾ç¤ºå¯è§†åŒ–é¢æ¿
      renderFilteredResults();
    }
    
    // å¯è§†åŒ–å›¾è¡¨åŠŸèƒ½
    let currentCharts = {};
    
    function showTypeChart() {
      if (!resourceData || resourceData.length === 0) {
        alert('è¯·å…ˆæ‰«æå’Œç­›é€‰èµ„æºæ–‡ä»¶');
        return;
      }
      
      // ç»Ÿè®¡æ–‡ä»¶ç±»å‹
      const typeCounts = {};
      resourceData.forEach(f => {
        const type = f['æ–‡ä»¶ç±»å‹'].toLowerCase();
        typeCounts[type] = (typeCounts[type] || 0) + 1;
      });
      
      const sortedTypes = Object.entries(typeCounts)
        .sort((a, b) => b[1] - a[1])
        .slice(0, 10); // å–å‰10ç§ç±»å‹
      
      const labels = sortedTypes.map(([type, count]) => `${type.toUpperCase()} (${count})`);
      const data = sortedTypes.map(([type, count]) => count);
      const colors = generateColors(sortedTypes.length);
      
      document.getElementById('typeChart').classList.remove('hidden');
      
      const ctx = document.getElementById('typeChartCanvas').getContext('2d');
      
      // é”€æ¯ä¹‹å‰çš„å›¾è¡¨
      if (currentCharts.typeChart) {
        currentCharts.typeChart.destroy();
      }
      
      currentCharts.typeChart = new Chart(ctx, {
        type: 'doughnut',
        data: {
          labels: labels,
          datasets: [{
            data: data,
            backgroundColor: colors,
            borderWidth: 2,
            borderColor: '#ffffff'
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              position: 'bottom',
              labels: {
                padding: 15,
                usePointStyle: true,
                font: {
                  size: 12
                }
              }
            },
            tooltip: {
              callbacks: {
                label: function(context) {
                  const total = context.dataset.data.reduce((a, b) => a + b, 0);
                  const percentage = ((context.parsed * 100) / total).toFixed(1);
                  return `${context.label}: ${percentage}%`;
                }
              }
            }
          }
        }
      });
    }
    
    function showSizeChart() {
      if (!resourceData || resourceData.length === 0) {
        alert('è¯·å…ˆæ‰«æå’Œç­›é€‰èµ„æºæ–‡ä»¶');
        return;
      }
      
      // æŒ‰æ–‡ä»¶å¤§å°åˆ†ç»„
      const sizeRanges = [
        { label: '< 10KB', min: 0, max: 10 * 1024 },
        { label: '10KB - 100KB', min: 10 * 1024, max: 100 * 1024 },
        { label: '100KB - 1MB', min: 100 * 1024, max: 1024 * 1024 },
        { label: '1MB - 10MB', min: 1024 * 1024, max: 10 * 1024 * 1024 },
        { label: '10MB - 50MB', min: 10 * 1024 * 1024, max: 50 * 1024 * 1024 },
        { label: '> 50MB', min: 50 * 1024 * 1024, max: Infinity }
      ];
      
      const sizeCounts = sizeRanges.map(range => {
        return resourceData.filter(f => {
          const size = f['æ–‡ä»¶å¤§å°'] || 0;
          return size >= range.min && size < range.max;
        }).length;
      });
      
      const labels = sizeRanges.map(range => range.label);
      const colors = ['#ff6384', '#36a2eb', '#ffce56', '#4bc0c0', '#9966ff', '#ff9f40'];
      
      document.getElementById('sizeChart').classList.remove('hidden');
      
      const ctx = document.getElementById('sizeChartCanvas').getContext('2d');
      
      if (currentCharts.sizeChart) {
        currentCharts.sizeChart.destroy();
      }
      
      currentCharts.sizeChart = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: labels,
          datasets: [{
            label: 'æ–‡ä»¶æ•°é‡',
            data: sizeCounts,
            backgroundColor: colors,
            borderColor: colors.map(color => color + '80'),
            borderWidth: 1
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              display: false
            },
            tooltip: {
              callbacks: {
                label: function(context) {
                  return `${context.label}: ${context.parsed.y} ä¸ªæ–‡ä»¶`;
                }
              }
            }
          },
          scales: {
            y: {
              beginAtZero: true,
              ticks: {
                stepSize: 1
              }
            }
          }
        }
      });
    }
    
    function showFolderChart() {
      if (!resourceData || resourceData.length === 0) {
        alert('è¯·å…ˆæ‰«æå’Œç­›é€‰èµ„æºæ–‡ä»¶');
        return;
      }
      
      // ç»Ÿè®¡æ–‡ä»¶å¤¹åˆ†å¸ƒ
      const folderCounts = {};
      resourceData.forEach(f => {
        const folder = f['çˆ¶æ–‡ä»¶å¤¹'] || 'æ ¹ç›®å½•';
        folderCounts[folder] = (folderCounts[folder] || 0) + 1;
      });
      
      const sortedFolders = Object.entries(folderCounts)
        .sort((a, b) => b[1] - a[1])
        .slice(0, 10); // å–å‰10ä¸ªæ–‡ä»¶å¤¹
      
      const labels = sortedFolders.map(([folder, count]) => folder);
      const data = sortedFolders.map(([folder, count]) => count);
      const colors = generateColors(sortedFolders.length);
      
      document.getElementById('folderChart').classList.remove('hidden');
      
      const ctx = document.getElementById('folderChartCanvas').getContext('2d');
      
      if (currentCharts.folderChart) {
        currentCharts.folderChart.destroy();
      }
      
      currentCharts.folderChart = new Chart(ctx, {
        type: 'horizontalBar',
        data: {
          labels: labels,
          datasets: [{
            label: 'æ–‡ä»¶æ•°é‡',
            data: data,
            backgroundColor: colors,
            borderColor: colors.map(color => color + '80'),
            borderWidth: 1
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              display: false
            },
            tooltip: {
              callbacks: {
                label: function(context) {
                  return `${context.label}: ${context.parsed.x} ä¸ªæ–‡ä»¶`;
                }
              }
            }
          },
          scales: {
            x: {
              beginAtZero: true,
              ticks: {
                stepSize: 1
              }
            }
          }
        }
      });
    }
    
    function hideCharts() {
      document.getElementById('typeChart').classList.add('hidden');
      document.getElementById('sizeChart').classList.add('hidden');
      document.getElementById('folderChart').classList.add('hidden');
      
      // é”€æ¯æ‰€æœ‰å›¾è¡¨
      Object.values(currentCharts).forEach(chart => {
        if (chart) chart.destroy();
      });
      currentCharts = {};
    }
    
    // ç”Ÿæˆé¢œè‰²æ•°ç»„
    function generateColors(count) {
      const baseColors = [
        '#ff6384', '#36a2eb', '#ffce56', '#4bc0c0', '#9966ff', 
        '#ff9f40', '#ff6384', '#c9cbcf', '#4bc0c0', '#ff6384'
      ];
      
      const colors = [];
      for (let i = 0; i < count; i++) {
        if (i < baseColors.length) {
          colors.push(baseColors[i]);
        } else {
          // ç”Ÿæˆéšæœºé¢œè‰²
          const hue = (i * 137.508) % 360; // é»„é‡‘è§’åº¦
          colors.push(`hsl(${hue}, 70%, 60%)`);
        }
      }
      return colors;
    }
    
    // ========================================
    // å¼•ç”¨å…³ç³»åˆ†æåŠŸèƒ½
    // ========================================
    
    // åˆ†æå¼•ç”¨å…³ç³»
    async function analyzeReferences() {
      if (!dirHandle || !resourceData || resourceData.length === 0) {
        alert('è¯·å…ˆæ‰«æèµ„æºæ–‡ä»¶');
        return;
      }
      
      analysisInProgress = true;
      showScanProgress();
      document.getElementById('scanProgressText').innerHTML = 'æ­£åœ¨åˆ†æèµ„æºå¼•ç”¨å…³ç³»...';
      
      // é‡ç½®æ•°æ®
      assetGuidMap.clear();
      dependencyMap.clear();
      reverseDepMap.clear();
      
      try {
        // ç¬¬ä¸€æ­¥ï¼šæ”¶é›†æ‰€æœ‰èµ„æºçš„GUIDä¿¡æ¯
        await collectAssetGuids();
        
        // ç¬¬äºŒæ­¥ï¼šåˆ†æä¾èµ–å…³ç³»
        await analyzeDependencies();
        
        // ç¬¬ä¸‰æ­¥ï¼šæ„å»ºåå‘å¼•ç”¨å…³ç³»
        buildReverseReferences();
        
        // æ˜¾ç¤ºç»“æœ
        renderReferenceResults();
        
      } catch (error) {
        console.error('åˆ†æå¼•ç”¨å…³ç³»å¤±è´¥:', error);
        alert('åˆ†æå¼•ç”¨å…³ç³»å¤±è´¥: ' + error.message);
      } finally {
        analysisInProgress = false;
        hideScanProgress();
      }
    }
    
    // æ”¶é›†èµ„æºGUIDä¿¡æ¯
    async function collectAssetGuids() {
      document.getElementById('scanProgressText').innerHTML = 'æ­£åœ¨æ”¶é›†èµ„æºGUIDä¿¡æ¯...';
      
      let processed = 0;
      const totalFiles = allFiles.length;
      
      for (const file of allFiles) {
        try {
          // æŸ¥æ‰¾å¯¹åº”çš„.metaæ–‡ä»¶
          const metaPath = file.path + '.meta';
          const metaHandle = await getFileHandleByPath(dirHandle, metaPath);
          
          if (metaHandle) {
            const metaFile = await metaHandle.getFile();
            const metaContent = await metaFile.text();
            const guid = extractGuidFromMeta(metaContent);
            
            if (guid) {
              assetGuidMap.set(guid, {
                path: file.path,
                name: file.name,
                ext: file.ext,
                guid: guid
              });
            }
          }
        } catch (e) {
          // å¿½ç•¥æ— æ³•è¯»å–çš„æ–‡ä»¶
        }
        
        processed++;
        if (processed % 10 === 0) {
          document.getElementById('scanProgressText').innerHTML = 
            `æ­£åœ¨æ”¶é›†èµ„æºGUIDä¿¡æ¯... (${processed}/${totalFiles})`;
          await new Promise(res => setTimeout(res, 0));
        }
      }
    }
    
    // ä».metaæ–‡ä»¶ä¸­æå–GUID
    function extractGuidFromMeta(metaContent) {
      const guidMatch = metaContent.match(/guid:\s*([a-f0-9]{32})/i);
      return guidMatch ? guidMatch[1] : null;
    }
    
    // åˆ†æä¾èµ–å…³ç³»
    async function analyzeDependencies() {
      document.getElementById('scanProgressText').innerHTML = 'æ­£åœ¨åˆ†æä¾èµ–å…³ç³»...';
      
      const unityFiles = allFiles.filter(f => 
        ['prefab', 'unity', 'mat', 'asset'].includes(f.ext.toLowerCase())
      );
      
      let processed = 0;
      const totalFiles = unityFiles.length;
      
      for (const file of unityFiles) {
        try {
          const fileHandle = await getFileHandleByPath(dirHandle, file.path);
          if (fileHandle) {
            const fileContent = await fileHandle.getFile();
            const content = await fileContent.text();
            const dependencies = extractDependencies(content);
            
            if (dependencies.length > 0) {
              dependencyMap.set(file.path, dependencies);
            }
          }
        } catch (e) {
          console.warn('åˆ†ææ–‡ä»¶ä¾èµ–å¤±è´¥:', file.path, e);
        }
        
        processed++;
        if (processed % 5 === 0) {
          document.getElementById('scanProgressText').innerHTML = 
            `æ­£åœ¨åˆ†æä¾èµ–å…³ç³»... (${processed}/${totalFiles})`;
          await new Promise(res => setTimeout(res, 0));
        }
      }
    }
    
    // ä»æ–‡ä»¶å†…å®¹ä¸­æå–ä¾èµ–å…³ç³»
    function extractDependencies(content) {
      const dependencies = [];
      
      // åŒ¹é…GUIDå¼•ç”¨æ¨¡å¼
      const guidPattern = /guid:\s*([a-f0-9]{32})/gi;
      let match;
      
      while ((match = guidPattern.exec(content)) !== null) {
        const guid = match[1];
        const asset = assetGuidMap.get(guid);
        
        if (asset && !dependencies.some(dep => dep.guid === guid)) {
          dependencies.push({
            guid: guid,
            path: asset.path,
            name: asset.name,
            type: getAssetType(asset.ext)
          });
        }
      }
      
      return dependencies;
    }
    
    // è·å–èµ„æºç±»å‹
    function getAssetType(ext) {
      const typeMap = {
        'prefab': 'prefab',
        'png': 'texture',
        'jpg': 'texture',
        'jpeg': 'texture',
        'mat': 'material',
        'cs': 'script',
        'unity': 'scene',
        'fbx': 'model',
        'wav': 'audio',
        'mp3': 'audio'
      };
      return typeMap[ext.toLowerCase()] || 'other';
    }
    
    // æ„å»ºåå‘å¼•ç”¨å…³ç³»
    function buildReverseReferences() {
      reverseDepMap.clear();
      
      for (const [filePath, dependencies] of dependencyMap) {
        dependencies.forEach(dep => {
          if (!reverseDepMap.has(dep.path)) {
            reverseDepMap.set(dep.path, []);
          }
          
          reverseDepMap.get(dep.path).push({
            path: filePath,
            name: filePath.split('/').pop(),
            type: getAssetType(filePath.split('.').pop())
          });
        });
      }
    }
    
    // æ¸²æŸ“å¼•ç”¨å…³ç³»åˆ†æç»“æœ
    function renderReferenceResults() {
      document.getElementById('step6').classList.remove('hidden');
      document.getElementById('referenceResults').classList.remove('hidden');
      document.getElementById('exportDependencyBtn').disabled = false;
      
      // ç»Ÿè®¡ä¿¡æ¯
      const totalAssets = assetGuidMap.size;
      const assetsWithDeps = dependencyMap.size;
      const totalDependencies = Array.from(dependencyMap.values())
        .reduce((sum, deps) => sum + deps.length, 0);
      
      let statsHtml = `<div style="font-size:18px;font-weight:600;">åˆ†æäº† <b>${totalAssets}</b> ä¸ªèµ„æºï¼Œå‘ç° <b>${totalDependencies}</b> ä¸ªä¾èµ–å…³ç³»</div>`;
      statsHtml += '<div class="stats-grid">';
      statsHtml += `<div class="stat-item"><div class="stat-number">${totalAssets}</div><div class="stat-label">æ€»èµ„æºæ•°</div></div>`;
      statsHtml += `<div class="stat-item"><div class="stat-number">${assetsWithDeps}</div><div class="stat-label">æœ‰ä¾èµ–çš„èµ„æº</div></div>`;
      statsHtml += `<div class="stat-item"><div class="stat-number">${totalDependencies}</div><div class="stat-label">ä¾èµ–å…³ç³»æ•°</div></div>`;
      statsHtml += `<div class="stat-item"><div class="stat-number">${reverseDepMap.size}</div><div class="stat-label">è¢«å¼•ç”¨çš„èµ„æº</div></div>`;
      statsHtml += '</div>';
      
      document.getElementById('referenceStats').innerHTML = statsHtml;
      
      // è¯¦ç»†ä¾èµ–å…³ç³»åˆ—è¡¨
      let detailsHtml = '';
      let itemCount = 0;
      const maxItems = 50; // é™åˆ¶æ˜¾ç¤ºæ•°é‡ä»¥æé«˜æ€§èƒ½
      
      for (const [filePath, dependencies] of dependencyMap) {
        if (itemCount >= maxItems) {
          detailsHtml += `<div style="text-align: center; padding: 20px; color: #718096;">
            è¿˜æœ‰ ${dependencyMap.size - maxItems} ä¸ªèµ„æºæœªæ˜¾ç¤ºï¼Œè¯·ä½¿ç”¨å¯¼å‡ºåŠŸèƒ½æŸ¥çœ‹å®Œæ•´æŠ¥å‘Š
          </div>`;
          break;
        }
        
        const fileName = filePath.split('/').pop();
        const references = reverseDepMap.get(filePath) || [];
        
        detailsHtml += `<div class="reference-item">
          <div class="reference-header">
            ğŸ“„ ${fileName}
            <span class="reference-count">ä¾èµ– ${dependencies.length}</span>
            <span class="reference-count">è¢«å¼•ç”¨ ${references.length}</span>
          </div>
          <div class="reference-path">${filePath}</div>
          
          ${dependencies.length > 0 ? `
            <div class="reference-dependencies">
              <strong>ä¾èµ–çš„èµ„æºï¼š</strong>
              <div class="dependency-list">
                ${dependencies.slice(0, 10).map(dep => `
                  <div class="dependency-item">
                    <span class="dependency-type ${dep.type}">${dep.type}</span>
                    <span>${dep.name}</span>
                  </div>
                `).join('')}
                ${dependencies.length > 10 ? `<div style="color: #718096; font-size: 12px;">è¿˜æœ‰ ${dependencies.length - 10} ä¸ªä¾èµ–...</div>` : ''}
              </div>
            </div>
          ` : ''}
          
          ${references.length > 0 ? `
            <div class="reference-dependencies">
              <strong>è¢«ä»¥ä¸‹èµ„æºå¼•ç”¨ï¼š</strong>
              <div class="dependency-list">
                ${references.slice(0, 5).map(ref => `
                  <div class="dependency-item">
                    <span class="dependency-type ${ref.type}">${ref.type}</span>
                    <span>${ref.name}</span>
                  </div>
                `).join('')}
                ${references.length > 5 ? `<div style="color: #718096; font-size: 12px;">è¿˜æœ‰ ${references.length - 5} ä¸ªå¼•ç”¨...</div>` : ''}
              </div>
            </div>
          ` : ''}
        </div>`;
        
        itemCount++;
      }
      
      if (detailsHtml === '') {
        detailsHtml = '<div style="text-align: center; color: #718096; padding: 40px;">æœªå‘ç°èµ„æºä¾èµ–å…³ç³»</div>';
      }
      
      document.getElementById('referenceDetails').innerHTML = detailsHtml;
    }
    
    // æŸ¥æ‰¾æœªä½¿ç”¨èµ„æº
    async function findUnusedAssets() {
      if (assetGuidMap.size === 0) {
        alert('è¯·å…ˆè¿è¡Œ"åˆ†æå¼•ç”¨å…³ç³»"');
        return;
      }
      
      unusedAssets = [];
      
      // æŸ¥æ‰¾æ²¡æœ‰è¢«ä»»ä½•èµ„æºå¼•ç”¨çš„èµ„æº
      for (const [guid, asset] of assetGuidMap) {
        const isReferenced = reverseDepMap.has(asset.path);
        const isSceneOrPrefab = ['unity', 'prefab'].includes(asset.ext.toLowerCase());
        
        // åœºæ™¯æ–‡ä»¶å’Œé¢„åˆ¶ä»¶é€šå¸¸æ˜¯å…¥å£ç‚¹ï¼Œä¸ç®—æœªä½¿ç”¨
        if (!isReferenced && !isSceneOrPrefab) {
          unusedAssets.push(asset);
        }
      }
      
      renderUnusedResults();
    }
    
    // æ¸²æŸ“æœªä½¿ç”¨èµ„æºç»“æœ
    function renderUnusedResults() {
      document.getElementById('unusedResults').classList.remove('hidden');
      
      let statsHtml = `<div style="font-size:18px;font-weight:600;">å‘ç° <b>${unusedAssets.length}</b> ä¸ªå¯èƒ½æœªä½¿ç”¨çš„èµ„æº</div>`;
      statsHtml += '<div class="stats-grid">';
      
      const typeStats = {};
      unusedAssets.forEach(asset => {
        const type = getAssetType(asset.ext);
        typeStats[type] = (typeStats[type] || 0) + 1;
      });
      
      Object.entries(typeStats).forEach(([type, count]) => {
        statsHtml += `<div class="stat-item"><div class="stat-number">${count}</div><div class="stat-label">${type.toUpperCase()}</div></div>`;
      });
      
      statsHtml += '</div>';
      document.getElementById('unusedStats').innerHTML = statsHtml;
      
      // æœªä½¿ç”¨èµ„æºåˆ—è¡¨
      let listHtml = '';
      unusedAssets.slice(0, 100).forEach(asset => {
        listHtml += `<div class="reference-item unused-asset">
          <div class="reference-header">
            ğŸ—‘ï¸ ${asset.name}
            <span class="dependency-type ${getAssetType(asset.ext)}">${getAssetType(asset.ext)}</span>
          </div>
          <div class="reference-path">${asset.path}</div>
          <div style="margin-top: 10px; color: #dd6b20; font-size: 13px;">
            ğŸ’¡ æ­¤èµ„æºä¼¼ä¹æ²¡æœ‰è¢«å…¶ä»–èµ„æºå¼•ç”¨ï¼Œå¯èƒ½å¯ä»¥å®‰å…¨åˆ é™¤
          </div>
        </div>`;
      });
      
      if (unusedAssets.length > 100) {
        listHtml += `<div style="text-align: center; padding: 20px; color: #718096;">
          è¿˜æœ‰ ${unusedAssets.length - 100} ä¸ªæœªä½¿ç”¨èµ„æºï¼Œè¯·ä½¿ç”¨å¯¼å‡ºåŠŸèƒ½æŸ¥çœ‹å®Œæ•´åˆ—è¡¨
        </div>`;
      }
      
      if (listHtml === '') {
        listHtml = '<div style="text-align: center; color: #718096; padding: 40px;">âœ… æ‰€æœ‰èµ„æºéƒ½æœ‰è¢«å¼•ç”¨</div>';
      }
      
      document.getElementById('unusedList').innerHTML = listHtml;
    }
    
    // æ£€æµ‹å¾ªç¯ä¾èµ–
    async function detectCircularDependencies() {
      if (dependencyMap.size === 0) {
        alert('è¯·å…ˆè¿è¡Œ"åˆ†æå¼•ç”¨å…³ç³»"');
        return;
      }
      
      circularDependencies = [];
      const visited = new Set();
      const visiting = new Set();
      
      // æ·±åº¦ä¼˜å…ˆæœç´¢æ£€æµ‹å¾ªç¯
      function detectCycle(path, currentPath = []) {
        if (visiting.has(path)) {
          // æ‰¾åˆ°å¾ªç¯ä¾èµ–
          const cycleStart = currentPath.indexOf(path);
          if (cycleStart !== -1) {
            const cycle = currentPath.slice(cycleStart);
            cycle.push(path); // å®Œæˆå¾ªç¯
            circularDependencies.push(cycle);
          }
          return;
        }
        
        if (visited.has(path)) {
          return;
        }
        
        visiting.add(path);
        currentPath.push(path);
        
        const dependencies = dependencyMap.get(path) || [];
        dependencies.forEach(dep => {
          detectCycle(dep.path, [...currentPath]);
        });
        
        visiting.delete(path);
        visited.add(path);
        currentPath.pop();
      }
      
      // æ£€æŸ¥æ‰€æœ‰èµ„æº
      for (const filePath of dependencyMap.keys()) {
        if (!visited.has(filePath)) {
          detectCycle(filePath);
        }
      }
      
      renderCircularResults();
    }
    
    // æ¸²æŸ“å¾ªç¯ä¾èµ–ç»“æœ
    function renderCircularResults() {
      document.getElementById('circularResults').classList.remove('hidden');
      
      let statsHtml = `<div style="font-size:18px;font-weight:600;">å‘ç° <b>${circularDependencies.length}</b> ä¸ªå¾ªç¯ä¾èµ–</div>`;
      if (circularDependencies.length > 0) {
        statsHtml += '<div style="color: #e53e3e; margin-top: 10px;">âš ï¸ å¾ªç¯ä¾èµ–å¯èƒ½å¯¼è‡´åŠ è½½é—®é¢˜ï¼Œå»ºè®®åŠæ—¶ä¿®å¤</div>';
      }
      
      document.getElementById('circularStats').innerHTML = statsHtml;
      
      // å¾ªç¯ä¾èµ–åˆ—è¡¨
      let listHtml = '';
      circularDependencies.forEach((cycle, index) => {
        listHtml += `<div class="reference-item circular-dependency">
          <div class="reference-header">
            ğŸ”„ å¾ªç¯ä¾èµ– ${index + 1}
            <span class="reference-count">${cycle.length - 1} ä¸ªæ–‡ä»¶</span>
          </div>
          <div class="dependency-list">
            ${cycle.map((path, i) => {
              const fileName = path.split('/').pop();
              const isLast = i === cycle.length - 1;
              return `
                <div class="dependency-item">
                  <span>${i + 1}.</span>
                  <span>${fileName}</span>
                  ${!isLast ? '<span style="color: #667eea;">â†’</span>' : '<span style="color: #e53e3e;">ğŸ”„</span>'}
                </div>
              `;
            }).join('')}
          </div>
          <div style="margin-top: 10px; color: #c53030; font-size: 13px;">
            ğŸ’¡ å»ºè®®é‡æ„è¿™äº›èµ„æºçš„ä¾èµ–å…³ç³»ä»¥æ‰“ç ´å¾ªç¯
          </div>
        </div>`;
      });
      
      if (listHtml === '') {
        listHtml = '<div style="text-align: center; color: #718096; padding: 40px;">âœ… æœªå‘ç°å¾ªç¯ä¾èµ–</div>';
      }
      
      document.getElementById('circularList').innerHTML = listHtml;
    }
    
    // å¯¼å‡ºä¾èµ–å…³ç³»æŠ¥å‘Š
    function exportDependencyReport() {
      if (assetGuidMap.size === 0) {
        alert('è¯·å…ˆè¿è¡Œå¼•ç”¨å…³ç³»åˆ†æ');
        return;
      }
      
      const reportData = [];
      
      // ä¾èµ–å…³ç³»æŠ¥å‘Š
      for (const [filePath, dependencies] of dependencyMap) {
        const references = reverseDepMap.get(filePath) || [];
        
        reportData.push({
          'èµ„æºåç§°': filePath.split('/').pop(),
          'èµ„æºè·¯å¾„': filePath,
          'èµ„æºç±»å‹': getAssetType(filePath.split('.').pop()),
          'ä¾èµ–æ•°é‡': dependencies.length,
          'è¢«å¼•ç”¨æ•°é‡': references.length,
          'ä¾èµ–åˆ—è¡¨': dependencies.map(dep => dep.path).join('; '),
          'è¢«å¼•ç”¨åˆ—è¡¨': references.map(ref => ref.path).join('; '),
          'çŠ¶æ€': unusedAssets.some(asset => asset.path === filePath) ? 'æœªä½¿ç”¨' : 
                 circularDependencies.some(cycle => cycle.includes(filePath)) ? 'å¾ªç¯ä¾èµ–' : 'æ­£å¸¸'
        });
      }
      
      const ws = XLSX.utils.json_to_sheet(reportData);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, "ä¾èµ–å…³ç³»æŠ¥å‘Š");
      
      // æ·»åŠ æœªä½¿ç”¨èµ„æºè¡¨
      if (unusedAssets.length > 0) {
        const unusedData = unusedAssets.map(asset => ({
          'èµ„æºåç§°': asset.name,
          'èµ„æºè·¯å¾„': asset.path,
          'èµ„æºç±»å‹': getAssetType(asset.ext),
          'å»ºè®®': 'å¯èƒ½å¯ä»¥å®‰å…¨åˆ é™¤'
        }));
        const unusedWs = XLSX.utils.json_to_sheet(unusedData);
        XLSX.utils.book_append_sheet(wb, unusedWs, "æœªä½¿ç”¨èµ„æº");
      }
      
      // æ·»åŠ å¾ªç¯ä¾èµ–è¡¨
      if (circularDependencies.length > 0) {
        const circularData = [];
        circularDependencies.forEach((cycle, index) => {
          cycle.slice(0, -1).forEach((path, i) => {
            circularData.push({
              'å¾ªç¯ç»„': index + 1,
              'é¡ºåº': i + 1,
              'èµ„æºåç§°': path.split('/').pop(),
              'èµ„æºè·¯å¾„': path,
              'ä¸‹ä¸€ä¸ªä¾èµ–': cycle[i + 1].split('/').pop()
            });
          });
        });
        const circularWs = XLSX.utils.json_to_sheet(circularData);
        XLSX.utils.book_append_sheet(wb, circularWs, "å¾ªç¯ä¾èµ–");
      }
      
      XLSX.writeFile(wb, `Unityä¾èµ–å…³ç³»æŠ¥å‘Š_${new Date().toISOString().slice(0,10)}.xlsx`);
      
      alert(`âœ… ä¾èµ–å…³ç³»æŠ¥å‘Šå·²å¯¼å‡ºï¼\n\n` +
            `åŒ…å«å†…å®¹ï¼š\n` +
            `â€¢ å®Œæ•´ä¾èµ–å…³ç³»åˆ†æ (${reportData.length} ä¸ªèµ„æº)\n` +
            `â€¢ æœªä½¿ç”¨èµ„æºåˆ—è¡¨ (${unusedAssets.length} ä¸ª)\n` +
            `â€¢ å¾ªç¯ä¾èµ–æ£€æµ‹ (${circularDependencies.length} ä¸ª)\n\n` +
            `å¯ç”¨äºé¡¹ç›®ä¼˜åŒ–å’Œèµ„æºæ¸…ç†ã€‚`);
    }
    
    // æ¸²æŸ“ç­›é€‰ç»“æœ
    function renderFilteredResults() {
      const searchInput = document.getElementById('searchInput');
      let keyword = searchInput ? searchInput.value.trim().toLowerCase() : '';
      let displayFiles = resourceData;
      
      if (keyword) {
        displayFiles = resourceData.filter(f =>
          f['æ–‡ä»¶åç§°'].toLowerCase().includes(keyword) ||
          f['æ–‡ä»¶è·¯å¾„'].toLowerCase().includes(keyword)
        );
      }
      
      lastDisplayFiles = displayFiles;
      
      if (displayFiles.length === 0) {
        document.getElementById('resourceList').innerHTML = '<div style="text-align: center; color: #718096; padding: 40px;">âŒ æœªæ‰¾åˆ°ä»»ä½•ç›®æ ‡æ ¼å¼çš„æ–‡ä»¶</div>';
        document.getElementById('stats').style.display = 'none';
        document.getElementById('batchOperations').classList.add('hidden');
        renderPagination(0, 1, pageSize);
        return;
      }
      
      // ç»Ÿè®¡
      const formatStats = {};
      displayFiles.forEach(f => {
        let ext = f['æ–‡ä»¶ç±»å‹'].toLowerCase();
        if (ext === 'jpeg') ext = 'jpg';
        formatStats[ext] = (formatStats[ext] || 0) + 1;
      });
      
      let statsHtml = '<div style="font-size:18px;font-weight:600;">å…±æ‰¾åˆ° <b>' + displayFiles.length + '</b> ä¸ªèµ„æºæ–‡ä»¶</div>';
      statsHtml += '<div class="stats-grid">';
      Object.entries(formatStats).forEach(([ext, count]) => {
        statsHtml += `<div class="stat-item"><div class="stat-number">${count}</div><div class="stat-label">${ext.toUpperCase()}</div></div>`;
      });
      statsHtml += '</div>';
      
      document.getElementById('stats').innerHTML = statsHtml;
      document.getElementById('stats').style.display = '';
      document.getElementById('batchOperations').classList.remove('hidden');
      
      // åˆ†é¡µ
      const pageCount = Math.max(1, Math.ceil(displayFiles.length / pageSize));
      if (currentPage > pageCount) currentPage = pageCount;
      
      const startIdx = (currentPage - 1) * pageSize;
      const endIdx = Math.min(startIdx + pageSize, displayFiles.length);
      
      // æ¸…ç†ä¹‹å‰çš„é¢„è§ˆ
      if (window._previewBlobUrls) {
        window._previewBlobUrls.forEach(url => URL.revokeObjectURL(url));
      }
      window._previewBlobUrls = [];
      
      let listHtml = '';
      for (let i = startIdx; i < endIdx; i++) {
        const f = displayFiles[i];
        const isSelected = selectedItems.has(i);
        let previewHtml = '';
        const ext = f['æ–‡ä»¶ç±»å‹'].toLowerCase();
        
        if (['png','jpg','jpeg','gif','bmp','webp'].includes(ext)) {
          previewHtml = `<span class='preview-img' data-path='${f['æ–‡ä»¶è·¯å¾„']}' style='display:inline-block;width:48px;height:48px;vertical-align:middle;background:#f7fafc;border:2px solid #e2e8f0;border-radius:8px;overflow:hidden;'></span>`;
        } else if (['mp3','wav','ogg'].includes(ext)) {
          previewHtml = `<span class='preview-audio' data-path='${f['æ–‡ä»¶è·¯å¾„']}' style='display:inline-block;width:120px;vertical-align:middle;'></span>`;
        }
        
        listHtml += `<div class="resource-item ${isSelected ? 'selected' : ''}">
          <input type="checkbox" class="resource-checkbox" data-index="${i}" ${isSelected ? 'checked' : ''}>
          <div class="resource-info">
            <div class="resource-name">${f['æ–‡ä»¶åç§°']}</div>
            <div class="resource-path">${f['æ–‡ä»¶è·¯å¾„']}</div>
          </div>
          <div class="resource-type">${f['æ–‡ä»¶ç±»å‹']}</div>
          <div>${previewHtml}</div>
        </div>`;
      }
      
      document.getElementById('resourceList').innerHTML = listHtml;
      renderPagination(displayFiles.length, currentPage, pageSize);
      
      // ç»‘å®šå¤šé€‰æ¡†äº‹ä»¶
      document.querySelectorAll('.resource-checkbox').forEach(checkbox => {
        checkbox.addEventListener('change', function() {
          const index = parseInt(this.dataset.index);
          if (this.checked) {
            selectedItems.add(index);
          } else {
            selectedItems.delete(index);
          }
          updateBatchOperations();
        });
      });
      
      updateBatchOperations();
      // å¼‚æ­¥åŠ è½½é¢„è§ˆ
      loadPreviews();
    }
    
    // åŠ è½½é¢„è§ˆï¼ˆé™æµï¼‰
    function loadPreviews() {
      const MAX_PREVIEW_CONCURRENCY = 8;
      
      if (window._previewAbort) window._previewAbort.cancelled = true;
      window._previewAbort = {cancelled: false};
      
      setTimeout(() => {
        const container = document.getElementById('resourceList');
        if (!container) return;
        
        const tasks = [];
        
        // æ”¶é›†å›¾ç‰‡ä»»åŠ¡
        for (const el of container.querySelectorAll('.preview-img')) {
          const path = el.getAttribute('data-path');
          tasks.push({el, path, type: 'img'});
        }
        
        // æ”¶é›†éŸ³é¢‘ä»»åŠ¡
        for (const el of container.querySelectorAll('.preview-audio')) {
          const path = el.getAttribute('data-path');
          tasks.push({el, path, type: 'audio'});
        }
        
        let running = 0, idx = 0;
        
        function runNext() {
          if (window._previewAbort.cancelled) return;
          
          while (running < MAX_PREVIEW_CONCURRENCY && idx < tasks.length) {
            const task = tasks[idx++];
            running++;
            
            (async () => {
              try {
                const fileHandle = await getFileHandleByPath(dirHandle, task.path);
                if (fileHandle) {
                  const file = await fileHandle.getFile();
                  const url = URL.createObjectURL(file);
                  window._previewBlobUrls.push(url);
                  
                  if (task.type === 'img') {
                    task.el.innerHTML = `<img src='${url}' style='width:100%;height:100%;object-fit:cover;' loading='lazy'>`;
                  } else if (task.type === 'audio') {
                    task.el.innerHTML = `<audio src='${url}' controls style='width:100px;height:32px;'></audio>`;
                  }
                }
              } catch(e) {
                console.warn('é¢„è§ˆåŠ è½½å¤±è´¥:', task.path);
              }
              
              running--;
              runNext();
            })();
          }
        }
        
        runNext();
      }, 0);
    }
    
    // é€’å½’æŸ¥æ‰¾æ–‡ä»¶å¥æŸ„
    async function getFileHandleByPath(rootHandle, relPath) {
      const parts = relPath.split('/');
      let curr = rootHandle;
      
      for (let i = 0; i < parts.length; i++) {
        if (i === parts.length - 1) {
          return await curr.getFileHandle(parts[i]).catch(() => null);
        } else {
          curr = await curr.getDirectoryHandle(parts[i]).catch(() => null);
          if (!curr) return null;
        }
      }
      
      return null;
    }
    
    // åˆ†é¡µç›¸å…³
    function renderPagination(total, page, pageSize) {
      const pageCount = Math.max(1, Math.ceil(total / pageSize));
      let html = '';
      
      if (pageCount <= 1) {
        document.getElementById('pagination').innerHTML = '';
        return;
      }
      
      html += `<button data-page="1" ${page === 1 ? 'disabled' : ''}>é¦–é¡µ</button> `;
      html += `<button data-page="${page - 1}" ${page === 1 ? 'disabled' : ''}>ä¸Šä¸€é¡µ</button> `;
      
      let start = Math.max(1, page - 2), end = Math.min(pageCount, page + 2);
      if (start > 1) html += '... ';
      
      for (let i = start; i <= end; i++) {
        html += `<button data-page="${i}" ${i === page ? 'style="font-weight:bold;background:linear-gradient(45deg, #667eea, #764ba2);color:#fff;"' : ''}>${i}</button> `;
      }
      
      if (end < pageCount) html += '... ';
      html += `<button data-page="${page + 1}" ${page === pageCount ? 'disabled' : ''}>ä¸‹ä¸€é¡µ</button> `;
      html += `<button data-page="${pageCount}" ${page === pageCount ? 'disabled' : ''}>æœ«é¡µ</button> `;
      html += `&nbsp; ç¬¬ ${page} / ${pageCount} é¡µï¼Œå…± ${total} æ¡`;
      
      document.getElementById('pagination').innerHTML = html;
      
      // ç»‘å®šåˆ†é¡µæŒ‰é’®äº‹ä»¶
      document.querySelectorAll('#pagination button[data-page]').forEach(btn => {
        btn.addEventListener('click', function() {
          if (!this.disabled) {
            gotoPage(parseInt(this.dataset.page));
          }
        });
      });
    }
    
    function gotoPage(page) {
      currentPage = page;
      renderFilteredResults();
    }
    
    // å­—æ®µé€‰æ‹©å¼¹çª—
    function openFieldSelect() {
      const modal = document.getElementById('fieldSelectModal');
      const box = document.getElementById('fieldCheckboxes');
      
      box.innerHTML = allFields.map(f =>
        `<label><input type='checkbox' value='${f.key}' ${selectedFields.includes(f.key) ? 'checked' : ''}> ${f.label}</label>`
      ).join('');
      
      modal.classList.remove('hidden');
    }
    
    function closeFieldSelect() {
      document.getElementById('fieldSelectModal').classList.add('hidden');
    }
    
    function applyFieldSelect() {
      const box = document.getElementById('fieldCheckboxes');
      selectedFields = Array.from(box.querySelectorAll('input[type=checkbox]:checked')).map(cb => cb.value);
      
      if (selectedFields.length === 0) {
        alert('è¯·è‡³å°‘é€‰æ‹©ä¸€ä¸ªå­—æ®µ');
        return;
      }
      
      localStorage.setItem('unity_asset_export_fields', JSON.stringify(selectedFields));
      closeFieldSelect();
    }
    
    // æ‰¹é‡æ“ä½œç›¸å…³
    function updateBatchOperations() {
      const selectedCountSpan = document.getElementById('selectedCount');
      const selectAllBtn2 = document.getElementById('selectAllBtn2');
      const clearSelectionBtn = document.getElementById('clearSelectionBtn');
      const copyPathsBtn = document.getElementById('copyPathsBtn');
      const exportSelectedBtn = document.getElementById('exportSelectedBtn');

      const totalItems = lastDisplayFiles.length;
      const selectedCount = selectedItems.size;

      selectedCountSpan.textContent = `å·²é€‰æ‹© ${selectedCount} ä¸ªæ–‡ä»¶`;
      selectAllBtn2.disabled = totalItems === 0;
      clearSelectionBtn.disabled = selectedCount === 0;
      copyPathsBtn.disabled = selectedCount === 0;
      exportSelectedBtn.disabled = selectedCount === 0;
    }

    function selectAllItems() {
      selectedItems.clear();
      for (let i = 0; i < lastDisplayFiles.length; i++) {
        selectedItems.add(i);
      }
      renderFilteredResults(); // é‡æ–°æ¸²æŸ“ä»¥æ›´æ–°é€‰ä¸­çŠ¶æ€çš„è§†è§‰åé¦ˆ
    }

    function clearSelection() {
      selectedItems.clear();
      renderFilteredResults(); // é‡æ–°æ¸²æŸ“ä»¥æ¸…é™¤é€‰ä¸­çŠ¶æ€çš„è§†è§‰åé¦ˆ
    }

    function copySelectedPaths() {
      if (selectedItems.size === 0) {
        alert('è¯·å…ˆé€‰æ‹©è¦å¤åˆ¶çš„æ–‡ä»¶');
        return;
      }
      const paths = selectedItems.size === 0 ? [] : Array.from(selectedItems).map(idx => lastDisplayFiles[idx]['æ–‡ä»¶è·¯å¾„']);
      const pathsString = paths.join('\n');
      navigator.clipboard.writeText(pathsString).then(() => {
        alert('å·²å¤åˆ¶ ' + selectedItems.size + ' ä¸ªæ–‡ä»¶çš„è·¯å¾„åˆ°å‰ªè´´æ¿ï¼');
      }).catch(err => {
        console.error('å¤åˆ¶å¤±è´¥:', err);
        alert('å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨å¤åˆ¶ã€‚');
      });
    }

    function exportSelectedItems() {
      if (selectedItems.size === 0) {
        alert('è¯·å…ˆé€‰æ‹©è¦å¯¼å‡ºçš„æ–‡ä»¶');
        return;
      }
      
      if (!selectedFields || selectedFields.length === 0) {
        alert('è¯·å…ˆé€‰æ‹©è¦å¯¼å‡ºçš„å­—æ®µ');
        return;
      }

      const exportRows = Array.from(selectedItems).map(idx => {
        const f = lastDisplayFiles[idx];
        const obj = {};
        selectedFields.forEach(field => obj[field] = f[field]);
        return obj;
      });
      
      const format = document.getElementById('exportFormat').value;
      
      if (format === 'excel') {
        const ws = XLSX.utils.json_to_sheet(exportRows);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "èµ„æºåˆ—è¡¨");
        XLSX.writeFile(wb, "Unityèµ„æºæ¸…å•.xlsx");
      } else if (format === 'csv') {
        let csv = selectedFields.join(',') + '\n';
        exportRows.forEach(row => {
          csv += selectedFields.map(f => '"' + String(row[f] || '').replace(/"/g, '""') + '"').join(',') + '\n';
        });
        
        const blob = new Blob([csv], {type: 'text/csv'});
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = 'Unityèµ„æºæ¸…å•.csv';
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
      } else if (format === 'json') {
        const blob = new Blob([JSON.stringify(exportRows, null, 2)], {type: 'application/json'});
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = 'Unityèµ„æºæ¸…å•.json';
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
      }
    }
    
    // å¯¼å‡ºæ•°æ®
    function exportData() {
      if (!resourceData || resourceData.length === 0) {
        alert('è¯·å…ˆç­›é€‰å¹¶é¢„è§ˆè¦å¯¼å‡ºçš„å†…å®¹');
        return;
      }
      
      if (!selectedFields || selectedFields.length === 0) {
        alert('è¯·å…ˆé€‰æ‹©è¦å¯¼å‡ºçš„å­—æ®µ');
        return;
      }
      
      const exportRows = resourceData.map(row => {
        const obj = {};
        selectedFields.forEach(f => obj[f] = row[f]);
        return obj;
      });
      
      const format = document.getElementById('exportFormat').value;
      
      if (format === 'excel') {
        const ws = XLSX.utils.json_to_sheet(exportRows);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "èµ„æºåˆ—è¡¨");
        XLSX.writeFile(wb, "Unityèµ„æºæ¸…å•.xlsx");
      } else if (format === 'csv') {
        let csv = selectedFields.join(',') + '\n';
        exportRows.forEach(row => {
          csv += selectedFields.map(f => '"' + String(row[f] || '').replace(/"/g, '""') + '"').join(',') + '\n';
        });
        
        const blob = new Blob([csv], {type: 'text/csv'});
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = 'Unityèµ„æºæ¸…å•.csv';
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
      } else if (format === 'json') {
        const blob = new Blob([JSON.stringify(exportRows, null, 2)], {type: 'application/json'});
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = 'Unityèµ„æºæ¸…å•.json';
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
      }
    }
    
    // å¤åˆ¶æ‰€æœ‰æ–‡ä»¶è·¯å¾„
    function copyAllPaths() {
      if (!resourceData || resourceData.length === 0) {
        alert('è¯·å…ˆç­›é€‰å¹¶é¢„è§ˆè¦å¯¼å‡ºçš„å†…å®¹');
        return;
      }
      
      // æ˜¾ç¤ºè·¯å¾„æ ¼å¼é€‰æ‹©å¯¹è¯æ¡†
      const pathType = confirm(
        'é€‰æ‹©è·¯å¾„æ ¼å¼ï¼š\n\n' +
        'ç¡®å®š = ç›¸å¯¹è·¯å¾„ï¼ˆç›¸å¯¹äºUnityé¡¹ç›®æ ¹ç›®å½•ï¼‰\n' +
        'å–æ¶ˆ = ç»å¯¹è·¯å¾„ï¼ˆå®Œæ•´æ–‡ä»¶ç³»ç»Ÿè·¯å¾„ï¼‰\n\n' +
        `å°†å¤åˆ¶ ${resourceData.length} ä¸ªæ–‡ä»¶çš„è·¯å¾„åˆ°å‰ªè´´æ¿ã€‚`
      );
      
      let pathsString;
      if (pathType) {
        // ç›¸å¯¹è·¯å¾„
        pathsString = resourceData.map(f => {
          // ç§»é™¤é¡¹ç›®æ ¹ç›®å½•éƒ¨åˆ†ï¼Œä¿ç•™ç›¸å¯¹è·¯å¾„
          let relativePath = f['æ–‡ä»¶è·¯å¾„'];
          if (dirHandle && dirHandle.name) {
            const projectName = dirHandle.name;
            const index = relativePath.indexOf(projectName);
            if (index !== -1) {
              relativePath = relativePath.substring(index + projectName.length + 1);
            }
          }
          return relativePath;
        }).join('\n');
      } else {
        // ç»å¯¹è·¯å¾„
        pathsString = resourceData.map(f => f['æ–‡ä»¶è·¯å¾„']).join('\n');
      }
      
      // å¤åˆ¶åˆ°å‰ªè´´æ¿
      navigator.clipboard.writeText(pathsString).then(() => {
        const pathTypeText = pathType ? 'ç›¸å¯¹è·¯å¾„' : 'ç»å¯¹è·¯å¾„';
        alert(`âœ… æˆåŠŸå¤åˆ¶ ${resourceData.length} ä¸ªæ–‡ä»¶çš„${pathTypeText}åˆ°å‰ªè´´æ¿ï¼\n\n` +
              `æ ¼å¼ï¼šæ¯è¡Œä¸€ä¸ªæ–‡ä»¶è·¯å¾„\n` +
              `å¯ä»¥ç›´æ¥ç²˜è´´åˆ°æ–‡æœ¬ç¼–è¾‘å™¨æˆ–Excelä¸­ä½¿ç”¨ã€‚`);
      }).catch(err => {
        console.error('å¤åˆ¶å¤±è´¥:', err);
        
        // å¤‡ç”¨æ–¹æ¡ˆï¼šåˆ›å»ºæ–‡æœ¬åŒºåŸŸå¹¶é€‰æ‹©
        const textarea = document.createElement('textarea');
        textarea.value = pathsString;
        document.body.appendChild(textarea);
        textarea.select();
        document.execCommand('copy');
        document.body.removeChild(textarea);
        
        alert(`âœ… å·²å¤åˆ¶ ${resourceData.length} ä¸ªæ–‡ä»¶è·¯å¾„åˆ°å‰ªè´´æ¿ï¼`);
      });
    }
    
    // é‡ç½®å·¥å…·
    function resetTool() {
      dirHandle = null;
      allFiles = [];
      selectedFolderPath = '';
      filteredFiles = [];
      resourceData = [];
      folderTreeRoot = null;
      currentPage = 1;
      selectedItems.clear(); // é‡ç½®é€‰ä¸­é¡¹
      
      // é‡ç½®å»é‡å’Œå¼‚å¸¸æ£€æµ‹æ•°æ®
      duplicateGroups = [];
      anomalyResults = [];
      analysisInProgress = false;
      
      // é‡ç½®å¼•ç”¨å…³ç³»åˆ†ææ•°æ®
      assetGuidMap.clear();
      dependencyMap.clear();
      reverseDepMap.clear();
      unusedAssets = [];
      circularDependencies = [];
      
      document.getElementById('pickedDir').textContent = '';
      document.getElementById('selectedFolder').textContent = '';
      document.getElementById('step2').classList.add('hidden');
      document.getElementById('step3').classList.add('hidden');
      document.getElementById('step4').classList.add('hidden');
      document.getElementById('step5').classList.add('hidden');
      document.getElementById('step6').classList.add('hidden');
      
      // éšè—åˆ†æç»“æœ
      document.getElementById('duplicateResults').classList.add('hidden');
      document.getElementById('anomalyResults').classList.add('hidden');
      document.getElementById('analysisAdvice').classList.add('hidden');
      document.getElementById('referenceResults').classList.add('hidden');
      document.getElementById('unusedResults').classList.add('hidden');
      document.getElementById('circularResults').classList.add('hidden');
      
      // æ¸…ç†é¢„è§ˆ
      if (window._previewBlobUrls) {
        window._previewBlobUrls.forEach(url => URL.revokeObjectURL(url));
        window._previewBlobUrls = [];
      }
      
      // é‡ç½®æ ¼å¼é€‰æ‹©
      document.querySelectorAll('.format-option input[type="checkbox"]').forEach(cb => cb.checked = false);
      document.getElementById('prefab').checked = true;
      
      // é‡ç½®æœç´¢
      document.getElementById('searchInput').value = '';
    }
    
    // è®¡ç®—æ–‡ä»¶hash
    async function calculateFileHash(fileHandle) {
      try {
        const file = await fileHandle.getFile();
        const arrayBuffer = await file.arrayBuffer();
        const hashBuffer = await crypto.subtle.digest('SHA-256', arrayBuffer);
        const hashArray = Array.from(new Uint8Array(hashBuffer));
        return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
      } catch (e) {
        console.warn('è®¡ç®—æ–‡ä»¶hashå¤±è´¥:', e);
        return null;
      }
    }
    
    // èµ„æºå»é‡æ£€æµ‹
    async function detectDuplicates() {
      if (!resourceData || resourceData.length === 0) {
        alert('è¯·å…ˆæ‰«æèµ„æºæ–‡ä»¶');
        return;
      }
      
      analysisInProgress = true;
      showScanProgress();
      document.getElementById('scanProgressText').innerHTML = 'æ­£åœ¨åˆ†æèµ„æºé‡å¤æƒ…å†µ...';
      
      const duplicateMap = new Map();
      const sizeMap = new Map();
      const nameMap = new Map();
      
      // æŒ‰æ–‡ä»¶å¤§å°åˆ†ç»„
      for (let i = 0; i < resourceData.length; i++) {
        const file = resourceData[i];
        const size = file['æ–‡ä»¶å¤§å°'];
        const name = file['æ–‡ä»¶åç§°'];
        
        if (!sizeMap.has(size)) {
          sizeMap.set(size, []);
        }
        sizeMap.get(size).push({index: i, file});
        
        if (!nameMap.has(name)) {
          nameMap.set(name, []);
        }
        nameMap.get(name).push({index: i, file});
        
        if (i % 10 === 0) {
          document.getElementById('scanProgressText').innerHTML = `æ­£åœ¨åˆ†æèµ„æºé‡å¤æƒ…å†µ... (${i + 1}/${resourceData.length})`;
          await new Promise(res => setTimeout(res, 0));
        }
      }
      
      duplicateGroups = [];
      
      // æ£€æµ‹åŒåæ–‡ä»¶
      for (const [name, files] of nameMap) {
        if (files.length > 1) {
          duplicateGroups.push({
            type: 'name',
            key: name,
            files: files,
            description: `åŒåæ–‡ä»¶ (${files.length}ä¸ª)`
          });
        }
      }
      
      // æ£€æµ‹åŒå¤§å°æ–‡ä»¶å¹¶è®¡ç®—hash
      for (const [size, files] of sizeMap) {
        if (files.length > 1 && size > 0) {
          document.getElementById('scanProgressText').innerHTML = `æ­£åœ¨è®¡ç®—æ–‡ä»¶hash... (å¤§å°: ${size} bytes)`;
          
          const hashMap = new Map();
          for (const {index, file} of files) {
            try {
              const fileHandle = await getFileHandleByPath(dirHandle, file['æ–‡ä»¶è·¯å¾„']);
              if (fileHandle) {
                const hash = await calculateFileHash(fileHandle);
                if (hash) {
                  if (!hashMap.has(hash)) {
                    hashMap.set(hash, []);
                  }
                  hashMap.get(hash).push({index, file});
                }
              }
            } catch (e) {
              console.warn('å¤„ç†æ–‡ä»¶å¤±è´¥:', file['æ–‡ä»¶è·¯å¾„']);
            }
          }
          
          // æ·»åŠ å†…å®¹ç›¸åŒçš„æ–‡ä»¶ç»„
          for (const [hash, hashFiles] of hashMap) {
            if (hashFiles.length > 1) {
              duplicateGroups.push({
                type: 'content',
                key: hash,
                files: hashFiles,
                description: `å†…å®¹ç›¸åŒ (${hashFiles.length}ä¸ª, ${size} bytes)`
              });
            }
          }
        }
      }
      
      // æ›´æ–°èµ„æºæ•°æ®ï¼Œæ·»åŠ é‡å¤çŠ¶æ€
      resourceData.forEach((file, index) => {
        let duplicateStatus = 'æ— é‡å¤';
        
        for (const group of duplicateGroups) {
          if (group.files.some(f => f.index === index)) {
            if (group.type === 'name') {
              duplicateStatus = 'åŒåé‡å¤';
            } else if (group.type === 'content') {
              duplicateStatus = 'å†…å®¹é‡å¤';
            }
            break;
          }
        }
        
        file['é‡å¤çŠ¶æ€'] = duplicateStatus;
      });
      
      analysisInProgress = false;
      hideScanProgress();
      
      // æ˜¾ç¤ºç»“æœ
      renderDuplicateResults();
    }
    
    // å¼‚å¸¸æ£€æµ‹
    function detectAnomalies() {
      if (!resourceData || resourceData.length === 0) {
        alert('è¯·å…ˆæ‰«æèµ„æºæ–‡ä»¶');
        return;
      }
      
      anomalyResults = [];
      
      // å®šä¹‰å¼‚å¸¸æ£€æµ‹è§„åˆ™
      const rules = [
        {
          name: 'æ–‡ä»¶è¿‡å¤§',
          check: (file) => {
            const size = file['æ–‡ä»¶å¤§å°'];
            const ext = file['æ–‡ä»¶ç±»å‹'].toLowerCase();
            const limits = {
              'png': 5 * 1024 * 1024,  // 5MB
              'jpg': 3 * 1024 * 1024,  // 3MB
              'jpeg': 3 * 1024 * 1024,
              'wav': 10 * 1024 * 1024, // 10MB
              'mp3': 5 * 1024 * 1024,  // 5MB
              'fbx': 20 * 1024 * 1024, // 20MB
              'prefab': 1 * 1024 * 1024 // 1MB
            };
            return size > (limits[ext] || 10 * 1024 * 1024);
          },
          severity: 'warning',
          suggestion: 'è€ƒè™‘å‹ç¼©æˆ–ä¼˜åŒ–æ–‡ä»¶å¤§å°'
        },
        {
          name: 'å‘½åä¸è§„èŒƒ',
          check: (file) => {
            const name = file['æ–‡ä»¶åç§°'];
            // æ£€æŸ¥æ˜¯å¦åŒ…å«ä¸­æ–‡ã€ç‰¹æ®Šå­—ç¬¦ã€ç©ºæ ¼
            return /[\u4e00-\u9fa5\s]/.test(name) || /[^\w\-\.]/.test(name);
          },
          severity: 'info',
          suggestion: 'å»ºè®®ä½¿ç”¨è‹±æ–‡å‘½åï¼Œé¿å…ç©ºæ ¼å’Œç‰¹æ®Šå­—ç¬¦'
        },
        {
          name: 'è·¯å¾„è¿‡æ·±',
          check: (file) => {
            const path = file['æ–‡ä»¶è·¯å¾„'];
            return path.split('/').length > 8;
          },
          severity: 'warning',
          suggestion: 'è·¯å¾„å±‚çº§è¿‡æ·±ï¼Œå»ºè®®ç®€åŒ–ç›®å½•ç»“æ„'
        },
        {
          name: 'ä¸´æ—¶æ–‡ä»¶',
          check: (file) => {
            const name = file['æ–‡ä»¶åç§°'];
            return name.includes('temp') || name.includes('tmp') || name.includes('~') || name.startsWith('.');
          },
          severity: 'error',
          suggestion: 'å»ºè®®åˆ é™¤ä¸´æ—¶æ–‡ä»¶'
        },
        {
          name: 'ç‰ˆæœ¬å†²çª',
          check: (file) => {
            const name = file['æ–‡ä»¶åç§°'];
            return /\d+$/.test(name.replace(/\.[^.]+$/, '')) || name.includes('copy') || name.includes('å‰¯æœ¬');
          },
          severity: 'warning',
          suggestion: 'å¯èƒ½å­˜åœ¨ç‰ˆæœ¬å†²çªï¼Œå»ºè®®æ£€æŸ¥æ˜¯å¦ä¸ºé‡å¤æ–‡ä»¶'
        }
      ];
      
      // åº”ç”¨æ£€æµ‹è§„åˆ™
      resourceData.forEach((file, index) => {
        const anomalies = [];
        
        rules.forEach(rule => {
          if (rule.check(file)) {
            anomalies.push({
              rule: rule.name,
              severity: rule.severity,
              suggestion: rule.suggestion
            });
          }
        });
        
        if (anomalies.length > 0) {
          anomalyResults.push({
            index,
            file,
            anomalies
          });
        }
        
        // æ›´æ–°æ–‡ä»¶çš„å¼‚å¸¸ä¿¡æ¯
        file['å¼‚å¸¸ä¿¡æ¯'] = anomalies.length > 0 ? 
          anomalies.map(a => `${a.rule}(${a.severity})`).join('; ') : 
          'æ— å¼‚å¸¸';
      });
      
      renderAnomalyResults();
    }
    
    // æ¸²æŸ“å»é‡æ£€æµ‹ç»“æœ
    function renderDuplicateResults() {
      document.getElementById('step5').classList.remove('hidden');
      document.getElementById('duplicateResults').classList.remove('hidden');
      
      // ç»Ÿè®¡ä¿¡æ¯
      const duplicateCount = duplicateGroups.reduce((sum, group) => sum + group.files.length, 0);
      const groupCount = duplicateGroups.length;
      
      let statsHtml = `<div style="font-size:18px;font-weight:600;">å‘ç° <b>${groupCount}</b> ç»„é‡å¤èµ„æºï¼Œå…± <b>${duplicateCount}</b> ä¸ªæ–‡ä»¶</div>`;
      statsHtml += '<div class="stats-grid">';
      
      const nameGroups = duplicateGroups.filter(g => g.type === 'name');
      const contentGroups = duplicateGroups.filter(g => g.type === 'content');
      
      statsHtml += `<div class="stat-item"><div class="stat-number">${nameGroups.length}</div><div class="stat-label">åŒåé‡å¤ç»„</div></div>`;
      statsHtml += `<div class="stat-item"><div class="stat-number">${contentGroups.length}</div><div class="stat-label">å†…å®¹é‡å¤ç»„</div></div>`;
      statsHtml += `<div class="stat-item"><div class="stat-number">${duplicateCount}</div><div class="stat-label">é‡å¤æ–‡ä»¶æ•°</div></div>`;
      statsHtml += '</div>';
      
      document.getElementById('duplicateStats').innerHTML = statsHtml;
      
      // é‡å¤ç»„åˆ—è¡¨
      let groupsHtml = '';
      duplicateGroups.forEach((group, index) => {
        const icon = group.type === 'name' ? 'ğŸ“' : 'ğŸ”—';
        groupsHtml += `<div class="duplicate-group type-${group.type}">
          <div class="duplicate-group-header">
            ${icon} ${group.description}
          </div>
          <div class="duplicate-group-files">`;
        
        group.files.forEach(({file}) => {
          groupsHtml += `<div class="duplicate-file-item">
            <span>ğŸ“„</span>
            <span style="flex:1;">${file['æ–‡ä»¶åç§°']}</span>
            <span style="color:#718096;font-size:12px;">${file['æ–‡ä»¶è·¯å¾„']}</span>
          </div>`;
        });
        
        groupsHtml += `</div></div>`;
      });
      
      if (groupsHtml === '') {
        groupsHtml = '<div style="text-align: center; color: #718096; padding: 40px;">âœ… æœªå‘ç°é‡å¤èµ„æº</div>';
      }
      
      document.getElementById('duplicateGroups').innerHTML = groupsHtml;
    }
    
    // æ¸²æŸ“å¼‚å¸¸æ£€æµ‹ç»“æœ
    function renderAnomalyResults() {
      document.getElementById('step5').classList.remove('hidden');
      document.getElementById('anomalyResults').classList.remove('hidden');
      
      // ç»Ÿè®¡ä¿¡æ¯
      const errorCount = anomalyResults.filter(a => a.anomalies.some(an => an.severity === 'error')).length;
      const warningCount = anomalyResults.filter(a => a.anomalies.some(an => an.severity === 'warning')).length;
      const infoCount = anomalyResults.filter(a => a.anomalies.some(an => an.severity === 'info')).length;
      
      let statsHtml = `<div style="font-size:18px;font-weight:600;">å‘ç° <b>${anomalyResults.length}</b> ä¸ªå¼‚å¸¸æ–‡ä»¶</div>`;
      statsHtml += '<div class="stats-grid">';
      statsHtml += `<div class="stat-item"><div class="stat-number">${errorCount}</div><div class="stat-label">ä¸¥é‡é”™è¯¯</div></div>`;
      statsHtml += `<div class="stat-item"><div class="stat-number">${warningCount}</div><div class="stat-label">è­¦å‘Š</div></div>`;
      statsHtml += `<div class="stat-item"><div class="stat-number">${infoCount}</div><div class="stat-label">æé†’</div></div>`;
      statsHtml += '</div>';
      
      document.getElementById('anomalyStats').innerHTML = statsHtml;
      
      // å¼‚å¸¸åˆ—è¡¨
      let anomaliesHtml = '';
      anomalyResults.forEach(result => {
        const highestSeverity = result.anomalies.reduce((max, a) => {
          const levels = {error: 3, warning: 2, info: 1};
          return levels[a.severity] > levels[max] ? a.severity : max;
        }, 'info');
        
        const icon = {error: 'âŒ', warning: 'âš ï¸', info: 'â„¹ï¸'}[highestSeverity];
        
        anomaliesHtml += `<div class="anomaly-item severity-${highestSeverity}">
          <div class="anomaly-header">
            ${icon} ${result.file['æ–‡ä»¶åç§°']}
          </div>
          <div class="anomaly-path">${result.file['æ–‡ä»¶è·¯å¾„']}</div>
          <div class="anomaly-details">`;
        
        result.anomalies.forEach(anomaly => {
          anomaliesHtml += `<span class="anomaly-rule severity-${anomaly.severity}">${anomaly.rule}</span>`;
        });
        
        anomaliesHtml += `</div>`;
        
        // æ˜¾ç¤ºå»ºè®®
        const suggestions = [...new Set(result.anomalies.map(a => a.suggestion))];
        suggestions.forEach(suggestion => {
          anomaliesHtml += `<div class="anomaly-suggestion">ğŸ’¡ ${suggestion}</div>`;
        });
        
        anomaliesHtml += `</div>`;
      });
      
      if (anomaliesHtml === '') {
        anomaliesHtml = '<div style="text-align: center; color: #718096; padding: 40px;">âœ… æœªå‘ç°å¼‚å¸¸é—®é¢˜</div>';
      }
      
      document.getElementById('anomalyList').innerHTML = anomaliesHtml;
    }
    
    // å®Œæ•´åˆ†æ
    async function runFullAnalysis() {
      if (!resourceData || resourceData.length === 0) {
        alert('è¯·å…ˆæ‰«æèµ„æºæ–‡ä»¶');
        return;
      }
      
      document.getElementById('step5').classList.remove('hidden');
      
      // ä¾æ¬¡è¿è¡Œå»é‡å’Œå¼‚å¸¸æ£€æµ‹
      await detectDuplicates();
      detectAnomalies();
      
      // ç”Ÿæˆåˆ†æå»ºè®®
      generateAnalysisAdvice();
    }
    
    // ç”Ÿæˆåˆ†æå»ºè®®
    function generateAnalysisAdvice() {
      document.getElementById('analysisAdvice').classList.remove('hidden');
      
      const advice = [];
      
      // åŸºäºå»é‡ç»“æœçš„å»ºè®®
      if (duplicateGroups.length > 0) {
        const duplicateCount = duplicateGroups.reduce((sum, group) => sum + group.files.length, 0);
        advice.push({
          title: 'ğŸ” é‡å¤èµ„æºæ¸…ç†',
          content: `å‘ç° ${duplicateGroups.length} ç»„é‡å¤èµ„æºï¼Œå…± ${duplicateCount} ä¸ªæ–‡ä»¶ã€‚å»ºè®®ï¼š
          <br>â€¢ åˆ é™¤å†…å®¹ç›¸åŒçš„é‡å¤æ–‡ä»¶ï¼Œä¿ç•™ä¸€ä¸ªç‰ˆæœ¬
          <br>â€¢ æ£€æŸ¥åŒåæ–‡ä»¶æ˜¯å¦ä¸ºä¸åŒç‰ˆæœ¬ï¼Œè€ƒè™‘é‡å‘½åæˆ–åˆå¹¶
          <br>â€¢ å»ºç«‹ç»Ÿä¸€çš„èµ„æºå‘½åè§„èŒƒï¼Œé¿å…æœªæ¥é‡å¤`
        });
      }
      
      // åŸºäºå¼‚å¸¸æ£€æµ‹çš„å»ºè®®
      if (anomalyResults.length > 0) {
        const errorCount = anomalyResults.filter(a => a.anomalies.some(an => an.severity === 'error')).length;
        const warningCount = anomalyResults.filter(a => a.anomalies.some(an => an.severity === 'warning')).length;
        
        if (errorCount > 0) {
          advice.push({
            title: 'âŒ ä¸¥é‡é—®é¢˜ä¿®å¤',
            content: `å‘ç° ${errorCount} ä¸ªä¸¥é‡é—®é¢˜ï¼Œéœ€è¦ç«‹å³å¤„ç†ï¼š
            <br>â€¢ åˆ é™¤ä¸´æ—¶æ–‡ä»¶å’Œç³»ç»Ÿç”Ÿæˆçš„éšè—æ–‡ä»¶
            <br>â€¢ æ£€æŸ¥å¹¶ä¿®å¤æŸåçš„èµ„æºæ–‡ä»¶
            <br>â€¢ æ¸…ç†å¼€å‘è¿‡ç¨‹ä¸­äº§ç”Ÿçš„æµ‹è¯•æ–‡ä»¶`
          });
        }
        
        if (warningCount > 0) {
          advice.push({
            title: 'âš ï¸ ä¼˜åŒ–å»ºè®®',
            content: `å‘ç° ${warningCount} ä¸ªå¯ä¼˜åŒ–é¡¹ç›®ï¼š
            <br>â€¢ å‹ç¼©è¿‡å¤§çš„å›¾ç‰‡å’ŒéŸ³é¢‘æ–‡ä»¶
            <br>â€¢ ç®€åŒ–è¿‡æ·±çš„ç›®å½•ç»“æ„
            <br>â€¢ ç»Ÿä¸€èµ„æºå‘½åè§„èŒƒï¼Œä½¿ç”¨è‹±æ–‡å‘½å`
          });
        }
      }
      
      // é€šç”¨å»ºè®®
      advice.push({
        title: 'ğŸ“‹ æœ€ä½³å®è·µ',
        content: `å»ºè®®å»ºç«‹ä»¥ä¸‹èµ„æºç®¡ç†è§„èŒƒï¼š
        <br>â€¢ å®šæœŸè¿è¡Œèµ„æºæ‰«æå’Œæ¸…ç†
        <br>â€¢ ä½¿ç”¨ç‰ˆæœ¬æ§åˆ¶ç³»ç»Ÿç®¡ç†èµ„æºå˜æ›´
        <br>â€¢ å»ºç«‹èµ„æºå®¡æŸ¥æµç¨‹ï¼Œé¿å…å¼•å…¥é—®é¢˜æ–‡ä»¶
        <br>â€¢ å®šä¹‰æ¸…æ™°çš„æ–‡ä»¶å¤¹ç»“æ„å’Œå‘½åçº¦å®š`
      });
      
      let adviceHtml = '';
      advice.forEach(item => {
        adviceHtml += `<div class="analysis-advice-item">
          <div class="advice-title">${item.title}</div>
          <div class="advice-content">${item.content}</div>
        </div>`;
      });
      
      // æ·»åŠ æ¸…ç†æ“ä½œæŒ‰é’®
      adviceHtml += `<div class="cleanup-actions">
        <h4 style="margin-bottom: 15px;">ğŸ› ï¸ å¿«é€Ÿæ“ä½œ</h4>
        <button onclick="exportDuplicateReport()">ğŸ“Š å¯¼å‡ºé‡å¤æ–‡ä»¶æŠ¥å‘Š</button>
        <button onclick="exportAnomalyReport()">ğŸ“‹ å¯¼å‡ºå¼‚å¸¸é—®é¢˜æŠ¥å‘Š</button>
        <button onclick="generateCleanupScript()">ğŸ“ ç”Ÿæˆæ¸…ç†è„šæœ¬</button>
        <button class="danger" onclick="confirmBatchCleanup()">ğŸ—‘ï¸ æ‰¹é‡æ¸…ç†ï¼ˆè°¨æ…ä½¿ç”¨ï¼‰</button>
      </div>`;
      
      document.getElementById('adviceContent').innerHTML = adviceHtml;
    }
    
    // å¯¼å‡ºé‡å¤æ–‡ä»¶æŠ¥å‘Š
    function exportDuplicateReport() {
      if (duplicateGroups.length === 0) {
        alert('æ²¡æœ‰å‘ç°é‡å¤æ–‡ä»¶');
        return;
      }
      
      const reportData = [];
      duplicateGroups.forEach(group => {
        group.files.forEach(({file}) => {
          reportData.push({
            'æ–‡ä»¶åç§°': file['æ–‡ä»¶åç§°'],
            'æ–‡ä»¶è·¯å¾„': file['æ–‡ä»¶è·¯å¾„'],
            'é‡å¤ç±»å‹': group.type === 'name' ? 'åŒåé‡å¤' : 'å†…å®¹é‡å¤',
            'é‡å¤ç»„': group.description,
            'æ–‡ä»¶å¤§å°': file['æ–‡ä»¶å¤§å°'],
            'ä¿®æ”¹æ—¶é—´': file['ä¿®æ”¹æ—¶é—´']
          });
        });
      });
      
      const ws = XLSX.utils.json_to_sheet(reportData);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, "é‡å¤æ–‡ä»¶æŠ¥å‘Š");
      XLSX.writeFile(wb, "Unityé‡å¤æ–‡ä»¶æŠ¥å‘Š.xlsx");
    }
    
    // å¯¼å‡ºå¼‚å¸¸é—®é¢˜æŠ¥å‘Š
    function exportAnomalyReport() {
      if (anomalyResults.length === 0) {
        alert('æ²¡æœ‰å‘ç°å¼‚å¸¸é—®é¢˜');
        return;
      }
      
      const reportData = [];
      anomalyResults.forEach(result => {
        result.anomalies.forEach(anomaly => {
          reportData.push({
            'æ–‡ä»¶åç§°': result.file['æ–‡ä»¶åç§°'],
            'æ–‡ä»¶è·¯å¾„': result.file['æ–‡ä»¶è·¯å¾„'],
            'å¼‚å¸¸ç±»å‹': anomaly.rule,
            'ä¸¥é‡ç¨‹åº¦': anomaly.severity,
            'ä¿®å¤å»ºè®®': anomaly.suggestion,
            'æ–‡ä»¶å¤§å°': result.file['æ–‡ä»¶å¤§å°'],
            'ä¿®æ”¹æ—¶é—´': result.file['ä¿®æ”¹æ—¶é—´']
          });
        });
      });
      
      const ws = XLSX.utils.json_to_sheet(reportData);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, "å¼‚å¸¸é—®é¢˜æŠ¥å‘Š");
      XLSX.writeFile(wb, "Unityå¼‚å¸¸é—®é¢˜æŠ¥å‘Š.xlsx");
    }
    
    // ç”Ÿæˆæ¸…ç†è„šæœ¬
    function generateCleanupScript() {
      let script = '#!/bin/bash\n';
      script += '# Unityèµ„æºæ¸…ç†å»ºè®®è„šæœ¬\n';
      script += '# æ­¤è„šæœ¬ä»…ä¸ºå»ºè®®ï¼Œè¯·æ ¹æ®å®é™…æƒ…å†µè°¨æ…æ‰§è¡Œ\n';
      script += '# å»ºè®®ï¼š1. å¤‡ä»½é¡¹ç›® 2. ä½¿ç”¨ç‰ˆæœ¬æ§åˆ¶ 3. é€æ¡æ£€æŸ¥åæ‰§è¡Œ\n\n';
      
      let hasContent = false;
      
      // é‡å¤æ–‡ä»¶å¤„ç†å»ºè®®
      if (duplicateGroups.length > 0) {
        script += '# =========================\n';
        script += '# é‡å¤æ–‡ä»¶å¤„ç†å»ºè®®\n';
        script += '# =========================\n\n';
        
        duplicateGroups.forEach((group, index) => {
          script += `# é‡å¤ç»„ ${index + 1}: ${group.description}\n`;
          
          if (group.type === 'content') {
            script += '# å†…å®¹å®Œå…¨ç›¸åŒçš„æ–‡ä»¶ï¼Œå»ºè®®ä¿ç•™ä¸€ä¸ªï¼š\n';
            group.files.forEach((item, fileIndex) => {
              if (fileIndex === 0) {
                script += `# ä¿ç•™: "${item.file['æ–‡ä»¶è·¯å¾„']}"\n`;
              } else {
                script += `# å¯åˆ é™¤: rm "${item.file['æ–‡ä»¶è·¯å¾„']}"\n`;
              }
            });
          } else {
            script += '# åŒåæ–‡ä»¶ï¼Œè¯·æ‰‹åŠ¨æ£€æŸ¥æ˜¯å¦ä¸ºä¸åŒç‰ˆæœ¬ï¼š\n';
            group.files.forEach(item => {
              script += `# æ£€æŸ¥: "${item.file['æ–‡ä»¶è·¯å¾„']}"\n`;
            });
          }
          script += '\n';
        });
        hasContent = true;
      }
      
      // å¼‚å¸¸æ–‡ä»¶å¤„ç†å»ºè®®
      if (anomalyResults.length > 0) {
        script += '# =========================\n';
        script += '# å¼‚å¸¸æ–‡ä»¶å¤„ç†å»ºè®®\n';
        script += '# =========================\n\n';
        
        const groupedAnomalies = {};
        anomalyResults.forEach(result => {
          result.anomalies.forEach(anomaly => {
            if (!groupedAnomalies[anomaly.rule]) {
              groupedAnomalies[anomaly.rule] = [];
            }
            groupedAnomalies[anomaly.rule].push({
              file: result.file,
              severity: anomaly.severity,
              suggestion: anomaly.suggestion
            });
          });
        });
        
        Object.entries(groupedAnomalies).forEach(([rule, items]) => {
          script += `# ${rule} (${items.length}ä¸ªæ–‡ä»¶)\n`;
          script += `# å»ºè®®: ${items[0].suggestion}\n`;
          
          items.forEach(item => {
            const action = rule === 'ä¸´æ—¶æ–‡ä»¶' ? 'å»ºè®®åˆ é™¤' : 
                          item.severity === 'error' ? 'éœ€è¦å¤„ç†' : 'å»ºè®®ä¼˜åŒ–';
            script += `# ${action}: "${item.file['æ–‡ä»¶è·¯å¾„']}"\n`;
            
            if (rule === 'ä¸´æ—¶æ–‡ä»¶') {
              script += `# rm "${item.file['æ–‡ä»¶è·¯å¾„']}"\n`;
            }
          });
          script += '\n';
        });
        hasContent = true;
      }
      
      if (!hasContent) {
        script += '# æ­å–œï¼æœªå‘ç°éœ€è¦æ¸…ç†çš„é—®é¢˜æ–‡ä»¶\n';
        script += '# æ‚¨çš„Unityé¡¹ç›®èµ„æºç®¡ç†è‰¯å¥½\n';
      } else {
        script += '# =========================\n';
        script += '# æ‰§è¡Œå»ºè®®\n';
        script += '# =========================\n';
        script += '# 1. å¤‡ä»½æ•´ä¸ªé¡¹ç›®\n';
        script += '# 2. ä½¿ç”¨ç‰ˆæœ¬æ§åˆ¶ç³»ç»Ÿ\n';
        script += '# 3. é€ä¸ªæ£€æŸ¥ä¸Šè¿°æ–‡ä»¶\n';
        script += '# 4. å–æ¶ˆæ³¨é‡Šéœ€è¦æ‰§è¡Œçš„å‘½ä»¤\n';
        script += '# 5. åˆ†æ‰¹æ‰§è¡Œï¼ŒåŠæ—¶éªŒè¯ç»“æœ\n';
      }
      
      const blob = new Blob([script], {type: 'text/plain'});
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = `unity_cleanup_suggestions_${new Date().toISOString().slice(0,10)}.sh`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      
      // æ˜¾ç¤ºç”Ÿæˆç»“æœæç¤º
      const problemCount = (duplicateGroups.length || 0) + (anomalyResults.length || 0);
      if (problemCount > 0) {
        alert(`âœ… æ¸…ç†å»ºè®®è„šæœ¬å·²ç”Ÿæˆï¼\n\n` +
              `å‘ç°é—®é¢˜ï¼š\n` +
              `â€¢ ${duplicateGroups.length} ç»„é‡å¤æ–‡ä»¶\n` +
              `â€¢ ${anomalyResults.length} ä¸ªå¼‚å¸¸æ–‡ä»¶\n\n` +
              `è„šæœ¬åŒ…å«è¯¦ç»†çš„å¤„ç†å»ºè®®ï¼Œè¯·ä»”ç»†é˜…è¯»åè°¨æ…æ‰§è¡Œã€‚`);
      } else {
        alert(`âœ… æ¸…ç†å»ºè®®è„šæœ¬å·²ç”Ÿæˆï¼\n\n` +
              `å¥½æ¶ˆæ¯ï¼šæœªå‘ç°éœ€è¦æ¸…ç†çš„é—®é¢˜æ–‡ä»¶ã€‚\n` +
              `æ‚¨çš„Unityé¡¹ç›®èµ„æºç®¡ç†è‰¯å¥½ï¼`);
      }
    }
    
    // ç¡®è®¤æ‰¹é‡æ¸…ç†
    function confirmBatchCleanup() {
      const confirmMsg = 'âš ï¸ è­¦å‘Šï¼šæ‰¹é‡æ¸…ç†å°†ä¼šåˆ é™¤æ£€æµ‹åˆ°çš„é‡å¤æ–‡ä»¶å’Œä¸´æ—¶æ–‡ä»¶ã€‚\n\n' +
                        'è¿™ä¸ªæ“ä½œä¸å¯é€†è½¬ï¼å»ºè®®ï¼š\n' +
                        '1. å…ˆå¤‡ä»½æ•´ä¸ªé¡¹ç›®\n' +
                        '2. ä»”ç»†æ£€æŸ¥æ¸…ç†åˆ—è¡¨\n' +
                        '3. ä½¿ç”¨ç‰ˆæœ¬æ§åˆ¶ç³»ç»Ÿ\n\n' +
                        'ç¡®å®šè¦ç»§ç»­å—ï¼Ÿ';
      
      if (confirm(confirmMsg)) {
        alert('æ‰¹é‡æ¸…ç†åŠŸèƒ½éœ€è¦æ›´é«˜çº§çš„æ–‡ä»¶ç³»ç»Ÿæƒé™ã€‚\nå»ºè®®ä½¿ç”¨"ç”Ÿæˆæ¸…ç†è„šæœ¬"åŠŸèƒ½ï¼Œæ‰‹åŠ¨æ‰§è¡Œæ¸…ç†æ“ä½œã€‚');
      }
    }
    

    
    // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
    document.addEventListener('DOMContentLoaded', function() {
      init();
    });
  </script>
</body>
</html>