<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Unity 资源扫描工具（本地版）</title>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
  <style>
      * {
          box-sizing: border-box;
      }
      
      body {
          font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
          max-width: 1200px;
          margin: 0 auto;
          padding: 20px;
          background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
          min-height: 100vh;
          line-height: 1.6;
      }
      
      .container {
          background: rgba(255, 255, 255, 0.95);
          backdrop-filter: blur(10px);
          padding: 40px;
          border-radius: 20px;
          box-shadow: 0 20px 40px rgba(0,0,0,0.1);
          border: 1px solid rgba(255,255,255,0.2);
      }
      
      h1 {
          color: #2d3748;
          text-align: center;
          margin-bottom: 10px;
          display: flex;
          align-items: center;
          justify-content: center;
          gap: 15px;
          font-size: 2.2rem;
          font-weight: 700;
      }
      
      .unity-logo {
          width: 40px;
          height: 40px;
          background: linear-gradient(45deg, #667eea, #764ba2);
          border-radius: 10px;
          display: inline-flex;
          align-items: center;
          justify-content: center;
          color: white;
          font-weight: bold;
          font-size: 18px;
          box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
      }
      
      .subtitle {
          text-align: center;
          color: #718096;
          margin-bottom: 40px;
          font-size: 16px;
          font-weight: 500;
      }
      
      .step {
          margin: 30px 0;
          padding: 30px;
          border: none;
          border-radius: 15px;
          background: linear-gradient(145deg, #ffffff, #f7fafc);
          box-shadow: 0 10px 25px rgba(0,0,0,0.08);
          border: 1px solid rgba(226, 232, 240, 0.8);
          transition: all 0.3s ease;
      }
      
      .step:hover {
          transform: translateY(-2px);
          box-shadow: 0 15px 35px rgba(0,0,0,0.12);
      }
      
      .step-title {
          font-size: 20px;
          font-weight: 600;
          color: #2d3748;
          margin-bottom: 20px;
          display: flex;
          align-items: center;
          gap: 15px;
      }
      
      .step-number {
          background: linear-gradient(45deg, #667eea, #764ba2);
          color: white;
          width: 32px;
          height: 32px;
          border-radius: 50%;
          display: flex;
          align-items: center;
          justify-content: center;
          font-size: 16px;
          font-weight: bold;
          box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
      }
      
      .folder-tree {
          max-height: 400px;
          overflow-y: auto;
          border: 1px solid #e2e8f0;
          border-radius: 10px;
          padding: 15px;
          background: #ffffff;
          font-family: 'SF Mono', Monaco, 'Cascadia Code', 'Roboto Mono', Consolas, 'Courier New', monospace;
          font-size: 14px;
          box-shadow: inset 0 2px 4px rgba(0,0,0,0.06);
      }
      
      .folder-tree::-webkit-scrollbar {
          width: 8px;
      }
      
      .folder-tree::-webkit-scrollbar-track {
          background: #f1f5f9;
          border-radius: 4px;
      }
      
      .folder-tree::-webkit-scrollbar-thumb {
          background: #cbd5e0;
          border-radius: 4px;
      }
      
      .folder-tree::-webkit-scrollbar-thumb:hover {
          background: #a0aec0;
      }
      
      .folder-item {
          padding: 8px 0;
          cursor: pointer;
          user-select: none;
          display: flex;
          align-items: center;
          gap: 8px;
          transition: all 0.2s ease;
          border-radius: 6px;
          padding: 6px 8px;
          margin: 2px 0;
      }
      
      .folder-item:hover {
          background: linear-gradient(90deg, #edf2f7, #e2e8f0);
          transform: translateX(4px);
      }
      
      .folder-item.selected {
          background: linear-gradient(90deg, #667eea, #764ba2);
          color: white;
          box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
      }
      
      .folder-toggle {
          width: 20px;
          height: 20px;
          display: flex;
          align-items: center;
          justify-content: center;
          cursor: pointer;
          border-radius: 4px;
          font-size: 14px;
          transition: all 0.2s ease;
          background: rgba(0,0,0,0.05);
      }
      
      .folder-toggle:hover {
          background: rgba(102, 126, 234, 0.1);
          transform: scale(1.1);
      }
      
      .folder-toggle.expanded {
          transform: rotate(90deg);
      }
      
      .folder-icon {
          width: 20px;
          text-align: center;
          flex-shrink: 0;
          font-size: 16px;
      }
      
      .folder-content {
          flex: 1;
          display: flex;
          align-items: center;
          gap: 8px;
      }
      
      .folder-children {
          margin-left: 25px;
      }
      
      .folder-name {
          flex: 1;
          font-weight: 500;
      }
      
      .file-count {
          font-size: 11px;
          background: linear-gradient(45deg, #667eea, #764ba2);
          color: white;
          padding: 4px 8px;
          border-radius: 12px;
          margin-left: 8px;
          font-weight: 500;
          box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3);
      }
      
      .folder-item.selected .file-count {
          background: rgba(255,255,255,0.2);
          box-shadow: 0 2px 8px rgba(255,255,255,0.2);
      }
      
      .format-selector {
          margin: 25px 0;
          padding: 25px;
          border: 1px solid #e2e8f0;
          border-radius: 15px;
          background: linear-gradient(145deg, #ffffff, #f8fafc);
          box-shadow: 0 4px 15px rgba(0,0,0,0.05);
      }
      
      .format-title {
          font-size: 18px;
          font-weight: 600;
          margin-bottom: 20px;
          color: #2d3748;
      }
      
      .format-grid {
          display: grid;
          grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
          gap: 20px;
      }
      
      .format-category {
          border: 1px solid #e2e8f0;
          border-radius: 12px;
          padding: 20px;
          background: linear-gradient(145deg, #ffffff, #f7fafc);
          transition: all 0.3s ease;
      }
      
      .format-category:hover {
          transform: translateY(-2px);
          box-shadow: 0 8px 25px rgba(0,0,0,0.1);
          border-color: #667eea;
      }
      
      .category-title {
          font-weight: 600;
          margin-bottom: 15px;
          color: #2d3748;
          display: flex;
          align-items: center;
          gap: 8px;
          font-size: 16px;
      }
      
      .format-option {
          display: flex;
          align-items: center;
          gap: 12px;
          margin: 12px 0;
          cursor: pointer;
          padding: 8px;
          border-radius: 8px;
          transition: all 0.2s ease;
      }
      
      .format-option:hover {
          background: linear-gradient(90deg, #edf2f7, #e2e8f0);
          transform: translateX(4px);
      }
      
      .format-option input[type="checkbox"] {
          margin: 0;
          width: 18px;
          height: 18px;
          accent-color: #667eea;
      }
      
      .format-option label {
          cursor: pointer;
          font-size: 14px;
          display: flex;
          align-items: center;
          gap: 8px;
          font-weight: 500;
          color: #4a5568;
      }
      
      .format-icon {
          width: 18px;
          height: 18px;
          border-radius: 4px;
          display: inline-block;
          box-shadow: 0 2px 8px rgba(0,0,0,0.15);
      }
      
      .icon-prefab { background: linear-gradient(45deg, #48bb78, #68d391); }
      .icon-image { background: linear-gradient(45deg, #ed8936, #f6ad55); }
      .icon-audio { background: linear-gradient(45deg, #9f7aea, #b794f6); }
      .icon-model { background: linear-gradient(45deg, #4299e1, #63b3ed); }
      .icon-script { background: linear-gradient(45deg, #718096, #a0aec0); }
      .icon-other { background: linear-gradient(45deg, #a0522d, #d69e2e); }
      
      .resource-list {
          max-height: 500px;
          overflow-y: auto;
          border: 1px solid #e2e8f0;
          border-radius: 15px;
          padding: 20px;
          margin: 20px 0;
          background: linear-gradient(145deg, #ffffff, #f8fafc);
          box-shadow: 0 4px 15px rgba(0,0,0,0.05);
      }
      
      .resource-list::-webkit-scrollbar {
          width: 8px;
      }
      
      .resource-list::-webkit-scrollbar-track {
          background: #f1f5f9;
          border-radius: 4px;
      }
      
      .resource-list::-webkit-scrollbar-thumb {
          background: #cbd5e0;
          border-radius: 4px;
      }
      
      .resource-list::-webkit-scrollbar-thumb:hover {
          background: #a0aec0;
      }
      
      .resource-item {
          padding: 15px 0;
          border-bottom: 1px solid #e2e8f0;
          font-size: 14px;
          display: flex;
          align-items: center;
          gap: 15px;
          transition: all 0.2s ease;
          border-radius: 8px;
          padding: 12px 15px;
          margin: 4px 0;
      }
      
      .resource-item:hover {
          background: linear-gradient(90deg, #edf2f7, #e2e8f0);
          transform: translateX(4px);
      }
      
      .resource-item.selected {
          background: linear-gradient(90deg, #e6fffa, #b2f5ea);
          border-color: #38b2ac;
      }
      
      .resource-item:last-child {
          border-bottom: none;
      }
      
      .resource-checkbox {
          width: 18px;
          height: 18px;
          accent-color: #667eea;
          cursor: pointer;
      }
      
      .resource-info {
          flex: 1;
      }
      
      .resource-name {
          font-weight: 600;
          color: #2d3748;
          margin-bottom: 4px;
      }
      
      .resource-path {
          color: #718096;
          font-size: 12px;
          font-family: 'SF Mono', Monaco, 'Cascadia Code', 'Roboto Mono', Consolas, 'Courier New', monospace;
      }
      
      .resource-type {
          font-size: 11px;
          background: linear-gradient(45deg, #667eea, #764ba2);
          color: white;
          padding: 6px 12px;
          border-radius: 20px;
          text-transform: uppercase;
          font-weight: 600;
          letter-spacing: 0.5px;
          box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3);
      }
      
      .batch-operations {
          background: linear-gradient(145deg, #ffffff, #f8fafc);
          border: 1px solid #e2e8f0;
          border-radius: 12px;
          padding: 15px 20px;
          margin: 15px 0;
          display: flex;
          align-items: center;
          gap: 12px;
          flex-wrap: wrap;
      }
      
      .batch-operations .selected-count {
          color: #4a5568;
          font-weight: 500;
          margin-right: 10px;
      }
      
      .batch-operations button {
          font-size: 12px;
          padding: 6px 12px;
          background: linear-gradient(45deg, #38b2ac, #4fd1c7);
          box-shadow: 0 2px 8px rgba(56, 178, 172, 0.3);
      }
      
      .batch-operations button:hover {
          background: linear-gradient(45deg, #319795, #38b2ac);
      }
      
      .batch-operations button:disabled {
          background: linear-gradient(45deg, #cbd5e0, #a0aec0);
          box-shadow: none;
      }
      
      button {
          background: linear-gradient(45deg, #667eea, #764ba2);
          color: white;
          border: none;
          padding: 12px 24px;
          border-radius: 10px;
          cursor: pointer;
          font-size: 14px;
          font-weight: 600;
          margin: 8px 6px;
          transition: all 0.3s ease;
          box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
          position: relative;
          overflow: hidden;
      }
      
      button:hover {
          transform: translateY(-2px);
          box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4);
      }
      
      button:active {
          transform: translateY(0);
      }
      
      button:disabled {
          background: linear-gradient(45deg, #cbd5e0, #a0aec0);
          cursor: not-allowed;
          transform: none;
          box-shadow: none;
      }
      
      button::before {
          content: '';
          position: absolute;
          top: 0;
          left: -100%;
          width: 100%;
          height: 100%;
          background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
          transition: left 0.5s;
      }
      
      button:hover::before {
          left: 100%;
      }
      
      input[type="text"], select {
          width: 100%;
          padding: 12px 16px;
          font-size: 14px;
          border: 2px solid #e2e8f0;
          border-radius: 10px;
          background: #ffffff;
          transition: all 0.3s ease;
          font-family: inherit;
      }
      
      input[type="text"]:focus, select:focus {
          outline: none;
          border-color: #667eea;
          box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
      }
      
      select {
          width: auto;
          margin: 0 10px;
          padding: 8px 12px;
          cursor: pointer;
      }
      
      .stats {
          background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
          color: white;
          padding: 25px;
          border-radius: 15px;
          margin: 25px 0;
          box-shadow: 0 10px 30px rgba(102, 126, 234, 0.3);
      }
      
      .stats-grid {
          display: grid;
          grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
          gap: 20px;
          margin-top: 20px;
      }
      
      .stat-item {
          background: rgba(255,255,255,0.15);
          backdrop-filter: blur(10px);
          padding: 20px;
          border-radius: 12px;
          text-align: center;
          border: 1px solid rgba(255,255,255,0.2);
          transition: all 0.3s ease;
      }
      
      .stat-item:hover {
          transform: translateY(-4px);
          background: rgba(255,255,255,0.2);
      }
      
      .stat-number {
          font-size: 24px;
          font-weight: 700;
          margin-bottom: 8px;
      }
      
      .stat-label {
          font-size: 12px;
          opacity: 0.9;
          font-weight: 500;
          text-transform: uppercase;
          letter-spacing: 0.5px;
      }
      
      .hidden {
          display: none;
      }
      
      .success-message {
          background: linear-gradient(45deg, #48bb78, #68d391);
          border: 1px solid #38a169;
          color: white;
          padding: 20px;
          border-radius: 12px;
          margin: 20px 0;
          box-shadow: 0 4px 15px rgba(72, 187, 120, 0.3);
          font-weight: 500;
      }
      
      .tree-controls {
          margin-bottom: 15px;
          display: flex;
          gap: 12px;
      }
      
      .tree-controls button {
          font-size: 12px;
          padding: 8px 16px;
          background: linear-gradient(45deg, #718096, #a0aec0);
          box-shadow: 0 2px 8px rgba(113, 128, 150, 0.3);
      }
      
      .tree-controls button:hover {
          background: linear-gradient(45deg, #4a5568, #718096);
      }
      
      .quick-select {
          margin-top: 20px;
          display: flex;
          gap: 12px;
          flex-wrap: wrap;
      }
      
      .quick-select button {
          font-size: 12px;
          padding: 8px 16px;
          background: linear-gradient(45deg, #48bb78, #68d391);
          box-shadow: 0 2px 8px rgba(72, 187, 120, 0.3);
      }
      
      .quick-select button:hover {
          background: linear-gradient(45deg, #38a169, #48bb78);
      }
      
      /* 扫描进度条现代化 */
      #scanProgressBar {
          margin-bottom: 25px;
          padding: 20px;
          background: linear-gradient(145deg, #ffffff, #f8fafc);
          border-radius: 15px;
          box-shadow: 0 4px 15px rgba(0,0,0,0.05);
          border: 1px solid #e2e8f0;
      }
      
      #scanProgressText {
          font-size: 14px;
          color: #4a5568;
          margin-bottom: 12px;
          font-weight: 500;
      }
      
      #scanProgressInner {
          height: 8px;
          background: linear-gradient(45deg, #667eea, #764ba2);
          border-radius: 4px;
          transition: width 0.3s ease;
          box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3);
      }
      
      /* 分页现代化 */
      #pagination {
          margin-top: 20px;
          text-align: center;
          font-size: 14px;
          color: #4a5568;
      }
      
      #pagination button {
          margin: 0 4px;
          padding: 8px 12px;
          font-size: 12px;
          min-width: 36px;
      }
      
      /* 弹窗现代化 */
      #fieldSelectModal {
          position: fixed;
          left: 0;
          top: 0;
          width: 100vw;
          height: 100vh;
          background: rgba(0,0,0,0.5);
          backdrop-filter: blur(5px);
          z-index: 999;
          align-items: center;
          justify-content: center;
      }
      
      #fieldSelectModal:not(.hidden) {
          display: flex;
      }
      
      #fieldSelectModal > div {
          background: #ffffff;
          padding: 30px 40px;
          border-radius: 20px;
          min-width: 400px;
          max-width: 90vw;
          max-height: 80vh;
          overflow-y: auto;
          box-shadow: 0 20px 40px rgba(0,0,0,0.3);
          border: 1px solid rgba(255,255,255,0.2);
      }
      
      #fieldSelectModal h3 {
          font-size: 20px;
          font-weight: 600;
          margin-bottom: 20px;
          color: #2d3748;
      }
      
      #fieldCheckboxes {
          margin-bottom: 25px;
      }
      
      #fieldCheckboxes label {
          display: block;
          margin-bottom: 12px;
          padding: 8px 12px;
          border-radius: 8px;
          transition: all 0.2s ease;
          cursor: pointer;
          font-weight: 500;
          color: #4a5568;
      }
      
      #fieldCheckboxes label:hover {
          background: linear-gradient(90deg, #edf2f7, #e2e8f0);
      }
      
      #fieldCheckboxes input[type="checkbox"] {
          margin-right: 10px;
          width: 16px;
          height: 16px;
          accent-color: #667eea;
      }
      
      /* 可视化图表样式 */
      .visualization-panel {
          margin: 25px 0;
          padding: 30px;
          background: linear-gradient(145deg, #ffffff, #f8fafc);
          border-radius: 15px;
          box-shadow: 0 10px 25px rgba(0,0,0,0.08);
          border: 1px solid rgba(226, 232, 240, 0.8);
      }
      
      .chart-controls {
          margin-bottom: 25px;
      }
      
      .chart-controls button {
          margin: 5px;
          font-size: 12px;
          padding: 8px 16px;
          background: linear-gradient(45deg, #667eea, #764ba2);
          box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3);
      }
      
      .chart-controls button:hover {
          background: linear-gradient(45deg, #5a67d8, #667eea);
      }
      
      .charts-container {
          display: grid;
          grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
          gap: 30px;
      }
      
      .chart-item {
          background: #ffffff;
          padding: 25px;
          border-radius: 12px;
          box-shadow: 0 4px 15px rgba(0,0,0,0.08);
          border: 1px solid #e2e8f0;
      }
      
      .chart-item h4 {
          margin: 0 0 20px 0;
          color: #2d3748;
          font-size: 16px;
          font-weight: 600;
          text-align: center;
      }
      
      .chart-item canvas {
          width: 100% !important;
          height: auto !important;
          max-height: 300px;
      }
      
      /* 去重和异常检测相关样式 */
      .duplicate-group {
          border: 1px solid #e2e8f0;
          border-radius: 12px;
          margin: 15px 0;
          padding: 20px;
          background: linear-gradient(145deg, #ffffff, #f8fafc);
          box-shadow: 0 4px 15px rgba(0,0,0,0.05);
      }
      
      .duplicate-group.type-name {
          border-left: 4px solid #ed8936;
      }
      
      .duplicate-group.type-content {
          border-left: 4px solid #e53e3e;
      }
      
      .duplicate-group-header {
          font-weight: 600;
          color: #2d3748;
          margin-bottom: 15px;
          display: flex;
          align-items: center;
          gap: 10px;
      }
      
      .duplicate-group-files {
          margin-left: 20px;
      }
      
      .duplicate-file-item {
          padding: 8px 12px;
          margin: 6px 0;
          background: rgba(0,0,0,0.02);
          border-radius: 6px;
          font-size: 13px;
          color: #4a5568;
          display: flex;
          align-items: center;
          gap: 10px;
      }
      
      .duplicate-file-item:hover {
          background: rgba(102, 126, 234, 0.1);
      }
      
      .anomaly-item {
          border: 1px solid #e2e8f0;
          border-radius: 12px;
          margin: 10px 0;
          padding: 15px;
          background: linear-gradient(145deg, #ffffff, #f8fafc);
          transition: all 0.2s ease;
      }
      
      .anomaly-item:hover {
          transform: translateY(-2px);
          box-shadow: 0 8px 25px rgba(0,0,0,0.1);
      }
      
      .anomaly-item.severity-error {
          border-left: 4px solid #e53e3e;
      }
      
      .anomaly-item.severity-warning {
          border-left: 4px solid #ed8936;
      }
      
      .anomaly-item.severity-info {
          border-left: 4px solid #3182ce;
      }
      
      .anomaly-header {
          font-weight: 600;
          color: #2d3748;
          margin-bottom: 8px;
          display: flex;
          align-items: center;
          gap: 8px;
      }
      
      .anomaly-path {
          color: #718096;
          font-size: 12px;
          font-family: 'SF Mono', Monaco, 'Cascadia Code', 'Roboto Mono', Consolas, 'Courier New', monospace;
          margin-bottom: 8px;
      }
      
      .anomaly-details {
          margin-top: 10px;
      }
      
      .anomaly-rule {
          display: inline-block;
          padding: 4px 8px;
          margin: 2px 4px 2px 0;
          border-radius: 12px;
          font-size: 11px;
          font-weight: 500;
      }
      
      .anomaly-rule.severity-error {
          background: #fed7d7;
          color: #c53030;
      }
      
      .anomaly-rule.severity-warning {
          background: #feebc8;
          color: #dd6b20;
      }
      
      .anomaly-rule.severity-info {
          background: #bee3f8;
          color: #2b6cb0;
      }
      
      .anomaly-suggestion {
          color: #4a5568;
          font-size: 12px;
          font-style: italic;
          margin-top: 8px;
          padding: 8px;
          background: rgba(0,0,0,0.02);
          border-radius: 6px;
      }
      
      .analysis-advice-item {
          margin: 15px 0;
          padding: 20px;
          border-radius: 12px;
          background: linear-gradient(145deg, #ffffff, #f8fafc);
          border: 1px solid #e2e8f0;
      }
      
      .advice-title {
          font-weight: 600;
          color: #2d3748;
          margin-bottom: 10px;
          display: flex;
          align-items: center;
          gap: 8px;
      }
      
      .advice-content {
          color: #4a5568;
          line-height: 1.6;
      }
      
      .cleanup-actions {
          margin-top: 20px;
          padding: 20px;
          background: linear-gradient(145deg, #ffffff, #f8fafc);
          border-radius: 12px;
          border: 1px solid #e2e8f0;
      }
      
      .cleanup-actions button {
          margin: 5px;
          font-size: 12px;
          padding: 8px 16px;
      }
      
      .cleanup-actions button.danger {
          background: linear-gradient(45deg, #e53e3e, #fc8181);
          box-shadow: 0 2px 8px rgba(229, 62, 62, 0.3);
      }
      
      .cleanup-actions button.danger:hover {
          background: linear-gradient(45deg, #c53030, #e53e3e);
      }
      
      /* 引用关系分析样式 */
      .dependency-graph {
          margin: 25px 0;
          padding: 25px;
          background: linear-gradient(145deg, #ffffff, #f8fafc);
          border-radius: 15px;
          box-shadow: 0 4px 15px rgba(0,0,0,0.05);
          border: 1px solid #e2e8f0;
      }
      
      .dependency-graph h4 {
          margin: 0 0 20px 0;
          color: #2d3748;
          font-size: 18px;
          font-weight: 600;
      }
      
      .graph-controls {
          display: flex;
          align-items: center;
          gap: 15px;
          margin-bottom: 20px;
      }
      
      .graph-controls button {
          font-size: 12px;
          padding: 8px 16px;
          background: linear-gradient(45deg, #4299e1, #63b3ed);
          box-shadow: 0 2px 8px rgba(66, 153, 225, 0.3);
      }
      
      .graph-controls button:hover {
          background: linear-gradient(45deg, #3182ce, #4299e1);
      }
      
      .graph-controls select {
          padding: 6px 12px;
          border: 1px solid #e2e8f0;
          border-radius: 6px;
          background: #ffffff;
          font-size: 12px;
      }
      
      .reference-item {
          border: 1px solid #e2e8f0;
          border-radius: 12px;
          margin: 10px 0;
          padding: 20px;
          background: linear-gradient(145deg, #ffffff, #f8fafc);
          transition: all 0.2s ease;
      }
      
      .reference-item:hover {
          transform: translateY(-2px);
          box-shadow: 0 8px 25px rgba(0,0,0,0.1);
      }
      
      .reference-header {
          font-weight: 600;
          color: #2d3748;
          margin-bottom: 12px;
          display: flex;
          align-items: center;
          gap: 10px;
          font-size: 16px;
      }
      
      .reference-path {
          color: #718096;
          font-size: 12px;
          font-family: 'SF Mono', Monaco, 'Cascadia Code', 'Roboto Mono', Consolas, 'Courier New', monospace;
          margin-bottom: 12px;
      }
      
      .reference-dependencies {
          margin-top: 15px;
      }
      
      .dependency-list {
          margin: 10px 0;
          padding-left: 20px;
      }
      
      .dependency-item {
          padding: 6px 0;
          color: #4a5568;
          font-size: 13px;
          display: flex;
          align-items: center;
          gap: 8px;
      }
      
      .dependency-type {
          display: inline-block;
          padding: 2px 6px;
          border-radius: 8px;
          font-size: 10px;
          font-weight: 500;
          text-transform: uppercase;
      }
      
      .dependency-type.prefab {
          background: #e6fffa;
          color: #234e52;
      }
      
      .dependency-type.texture {
          background: #fef5e7;
          color: #744210;
      }
      
      .dependency-type.material {
          background: #edf2f7;
          color: #2d3748;
      }
      
      .dependency-type.script {
          background: #e6f3ff;
          color: #2a4365;
      }
      
      .circular-dependency {
          border-left: 4px solid #e53e3e;
          background: linear-gradient(145deg, #fed7d7, #feb2b2);
      }
      
      .unused-asset {
          border-left: 4px solid #ed8936;
          background: linear-gradient(145deg, #feebc8, #fbd38d);
      }
      
      .reference-count {
          font-size: 11px;
          background: linear-gradient(45deg, #667eea, #764ba2);
          color: white;
          padding: 4px 8px;
          border-radius: 12px;
          margin-left: 8px;
          font-weight: 500;
          box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3);
      }
      
      /* 响应式设计 */
      @media (max-width: 768px) {
          body {
              padding: 10px;
          }
          
          .container {
              padding: 20px;
          }
          
          h1 {
              font-size: 1.8rem;
          }
          
          .format-grid {
              grid-template-columns: 1fr;
          }
          
          .stats-grid {
              grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
          }
          
          .quick-select {
              justify-content: center;
          }
          
          #fieldSelectModal > div {
              margin: 20px;
              padding: 20px;
              min-width: auto;
          }
          
          .duplicate-group-files {
              margin-left: 0;
          }
          
          .cleanup-actions {
              text-align: center;
          }
      }
      
      /* 兼容性提示样式 */
      .compatibility-warning {
          background: linear-gradient(135deg, #fff3cd, #ffeaa7);
          border: 2px solid #ffc107;
          border-radius: 15px;
          margin: 20px 0;
          padding: 0;
          box-shadow: 0 8px 25px rgba(255, 193, 7, 0.3);
          animation: slideDown 0.5s ease-out;
      }
      
      .compatibility-warning.hidden {
          display: none;
      }
      
      @keyframes slideDown {
          from {
              opacity: 0;
              transform: translateY(-20px);
          }
          to {
              opacity: 1;
              transform: translateY(0);
          }
      }
      
      .warning-content {
          padding: 25px;
      }
      
      .warning-header {
          display: flex;
          align-items: center;
          gap: 10px;
          margin-bottom: 15px;
          color: #856404;
          font-size: 18px;
      }
      
      .warning-icon {
          font-size: 24px;
      }
      
      .warning-body {
          color: #856404;
          line-height: 1.6;
      }
      
      .warning-body p {
          margin-bottom: 15px;
      }
      
      .browser-support {
          display: grid;
          grid-template-columns: 1fr 1fr;
          gap: 20px;
          margin: 15px 0;
          font-size: 14px;
      }
      
      .supported, .not-supported {
          padding: 15px;
          border-radius: 10px;
          background: rgba(255,255,255,0.3);
      }
      
      .supported {
          border-left: 4px solid #28a745;
      }
      
      .not-supported {
          border-left: 4px solid #dc3545;
      }
      
      .browser-support ul {
          margin: 8px 0 0 20px;
          padding: 0;
      }
      
      .browser-support li {
          margin: 4px 0;
      }
      
      .security-note {
          margin-top: 15px;
          padding: 15px;
          background: rgba(255,255,255,0.4);
          border-radius: 10px;
          border-left: 4px solid #17a2b8;
      }
      
      .security-note ul {
          margin: 8px 0 0 20px;
          padding: 0;
      }
      
      .security-note li {
          margin: 4px 0;
      }
      
      .dismiss-btn {
          margin-top: 20px;
          background: linear-gradient(45deg, #ffc107, #ffca2c);
          color: #856404;
          border: none;
          padding: 10px 20px;
          border-radius: 8px;
          font-weight: 600;
          cursor: pointer;
          transition: all 0.3s ease;
          box-shadow: 0 2px 8px rgba(255, 193, 7, 0.3);
      }
      
      .dismiss-btn:hover {
          background: linear-gradient(45deg, #e0a800, #ffc107);
          transform: translateY(-2px);
          box-shadow: 0 4px 15px rgba(255, 193, 7, 0.4);
      }
      
      /* 预览区域样式 */
      .preview-img, .preview-audio {
          border-radius: 8px;
          overflow: hidden;
          box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      }
      
      .preview-img {
          background: 
              linear-gradient(45deg, #e2e8f0 25%, transparent 25%), 
              linear-gradient(-45deg, #e2e8f0 25%, transparent 25%), 
              linear-gradient(45deg, transparent 75%, #e2e8f0 75%), 
              linear-gradient(-45deg, transparent 75%, #e2e8f0 75%);
          background-size: 8px 8px;
          background-position: 0 0, 0 4px, 4px -4px, -4px 0px;
          border: 2px solid #e2e8f0;
      }
      
      .preview-audio {
          background: #f8fafc;
          border: 1px solid #e2e8f0;
          padding: 4px;
      }
  </style>
</head>
<body>
  <div class="container">
      <h1>
          <div class="unity-logo">U</div>
          Unity 资源扫描工具（本地版）
      </h1>
      <div class="subtitle">选择Unity项目目录 → 选择目标文件夹 → 选择文件格式 → 导出资源列表（全程本地处理，数据不会上传）</div>
      
      <!-- 兼容性提示 -->
      <div id="compatibilityWarning" class="compatibility-warning">
          <div class="warning-content">
              <div class="warning-header">
                  <span class="warning-icon">⚠️</span>
                  <strong>浏览器兼容性提醒</strong>
              </div>
              <div class="warning-body">
                  <p>本工具使用现代浏览器的 <strong>File System Access API</strong> 来访问本地文件系统。</p>
                  <div class="browser-support">
                      <div class="supported">
                          <strong>✅ 支持的浏览器：</strong>
                          <ul>
                              <li>Chrome 86+ (推荐)</li>
                              <li>Edge 86+</li>
                              <li>Safari 15.2+ (macOS)</li>
                          </ul>
                      </div>
                      <div class="not-supported">
                          <strong>❌ 不支持的浏览器：</strong>
                          <ul>
                              <li>Firefox (所有版本)</li>
                              <li>Internet Explorer</li>
                              <li>较旧版本的浏览器</li>
                          </ul>
                      </div>
                  </div>
                  <div class="security-note">
                      <strong>🔒 安全说明：</strong>
                      <ul>
                          <li>工具完全在本地运行，不会上传任何文件或数据</li>
                          <li>需要您主动授权访问文件夹</li>
                          <li>所有数据处理都在您的设备上完成</li>
                      </ul>
                  </div>
              </div>
              <button id="dismissWarning" class="dismiss-btn">我知道了</button>
          </div>
      </div>
      
      <!-- 扫描进度条 -->
      <div id="scanProgressBar" class="hidden">
          <div id="scanProgressText"></div>
          <div style="background:#e2e8f0;border-radius:8px;overflow:hidden;height:8px;">
              <div id="scanProgressInner" style="width:0%;"></div>
          </div>
      </div>
      
      <!-- 步骤1: 选择Unity项目目录 -->
      <div class="step">
          <div class="step-title">
              <div class="step-number">1</div>
              选择Unity项目目录
          </div>
          <div style="text-align:center;">
              <button id="pickDirBtn">📂 选择Unity项目根目录</button>
              <div id="pickedDir" style="margin-top:15px;color:#718096;font-size:14px;font-weight:500;"></div>
              
              <!-- 扫描选项 -->
              <div class="scan-options" style="margin-top: 20px; padding: 15px; background: #f8fafc; border-radius: 10px; border: 1px solid #e2e8f0;">
                  <div style="font-weight: 600; margin-bottom: 10px; color: #2d3748;">⚙️ 扫描选项</div>
                  <div style="display: flex; flex-direction: column; gap: 8px; text-align: left;">
                      <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                          <input type="radio" name="scanScope" value="full" checked style="accent-color: #667eea;">
                          <span>🔍 完整扫描（扫描整个项目目录）</span>
                      </label>
                      <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                          <input type="radio" name="scanScope" value="assets" style="accent-color: #667eea;">
                          <span>🎯 仅Assets目录（推荐，跳过Library/Temp等系统目录）</span>
                      </label>
                      <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                          <input type="radio" name="scanScope" value="custom" style="accent-color: #667eea;">
                          <span>📁 自定义范围（手动选择要扫描的目录）</span>
                      </label>
                  </div>
              </div>
          </div>
      </div>

      <!-- 步骤2: 选择目标文件夹 -->
      <div class="step hidden" id="step2">
          <div class="step-title">
              <div class="step-number">2</div>
              选择要导出的目标文件夹
          </div>
          <div class="tree-controls">
              <button id="expandAllBtn">📂 展开全部</button>
              <button id="collapseAllBtn">📁 折叠全部</button>
          </div>
          <div class="folder-tree" id="folderTree"></div>
          <div style="margin-top: 20px;">
              <span id="selectedFolder" style="color: #718096; font-size: 14px; font-weight: 500;"></span>
          </div>
      </div>

      <!-- 步骤3: 选择文件格式并导出 -->
      <div class="step hidden" id="step3">
          <div class="step-title">
              <div class="step-number">3</div>
              选择要导出的文件格式
          </div>
          <div class="format-selector">
              <div class="format-title">🎯 选择要导出的资源类型（可多选）</div>
              <div class="format-grid">
                  <div class="format-category">
                      <div class="category-title">🎮 游戏对象</div>
                      <div class="format-option">
                          <input type="checkbox" id="prefab" value="prefab" checked>
                          <label for="prefab"><span class="format-icon icon-prefab"></span>Prefab (.prefab)</label>
                      </div>
                      <div class="format-option">
                          <input type="checkbox" id="unity" value="unity">
                          <label for="unity"><span class="format-icon icon-prefab"></span>场景 (.unity)</label>
                      </div>
                  </div>
                  <div class="format-category">
                      <div class="category-title">🖼️ 图像资源</div>
                      <div class="format-option">
                          <input type="checkbox" id="png" value="png">
                          <label for="png"><span class="format-icon icon-image"></span>PNG (.png)</label>
                      </div>
                      <div class="format-option">
                          <input type="checkbox" id="jpg" value="jpg">
                          <label for="jpg"><span class="format-icon icon-image"></span>JPG (.jpg/.jpeg)</label>
                      </div>
                      <div class="format-option">
                          <input type="checkbox" id="tga" value="tga">
                          <label for="tga"><span class="format-icon icon-image"></span>TGA (.tga)</label>
                      </div>
                      <div class="format-option">
                          <input type="checkbox" id="psd" value="psd">
                          <label for="psd"><span class="format-icon icon-image"></span>PSD (.psd)</label>
                      </div>
                  </div>
                  <div class="format-category">
                      <div class="category-title">🎵 音频资源</div>
                      <div class="format-option">
                          <input type="checkbox" id="wav" value="wav">
                          <label for="wav"><span class="format-icon icon-audio"></span>WAV (.wav)</label>
                      </div>
                      <div class="format-option">
                          <input type="checkbox" id="mp3" value="mp3">
                          <label for="mp3"><span class="format-icon icon-audio"></span>MP3 (.mp3)</label>
                      </div>
                      <div class="format-option">
                          <input type="checkbox" id="ogg" value="ogg">
                          <label for="ogg"><span class="format-icon icon-audio"></span>OGG (.ogg)</label>
                      </div>
                  </div>
                  <div class="format-category">
                      <div class="category-title">🎲 3D模型</div>
                      <div class="format-option">
                          <input type="checkbox" id="fbx" value="fbx">
                          <label for="fbx"><span class="format-icon icon-model"></span>FBX (.fbx)</label>
                      </div>
                      <div class="format-option">
                          <input type="checkbox" id="obj" value="obj">
                          <label for="obj"><span class="format-icon icon-model"></span>OBJ (.obj)</label>
                      </div>
                      <div class="format-option">
                          <input type="checkbox" id="blend" value="blend">
                          <label for="blend"><span class="format-icon icon-model"></span>Blender (.blend)</label>
                      </div>
                  </div>
                  <div class="format-category">
                      <div class="category-title">📝 脚本代码</div>
                      <div class="format-option">
                          <input type="checkbox" id="cs" value="cs">
                          <label for="cs"><span class="format-icon icon-script"></span>C# (.cs)</label>
                      </div>
                      <div class="format-option">
                          <input type="checkbox" id="js" value="js">
                          <label for="js"><span class="format-icon icon-script"></span>JavaScript (.js)</label>
                      </div>
                  </div>
                  <div class="format-category">
                      <div class="category-title">📄 其他资源</div>
                      <div class="format-option">
                          <input type="checkbox" id="txt" value="txt">
                          <label for="txt"><span class="format-icon icon-other"></span>文本 (.txt)</label>
                      </div>
                      <div class="format-option">
                          <input type="checkbox" id="json" value="json">
                          <label for="json"><span class="format-icon icon-other"></span>JSON (.json)</label>
                      </div>
                      <div class="format-option">
                          <input type="checkbox" id="xml" value="xml">
                          <label for="xml"><span class="format-icon icon-other"></span>XML (.xml)</label>
                      </div>
                  </div>
              </div>
              <div class="quick-select">
                  <button id="selectAllBtn">✅ 全选</button>
                  <button id="clearAllBtn">❌ 清空</button>
                  <button id="selectImageBtn">🖼️ 选择图像</button>
                  <button id="selectAudioBtn">🎵 选择音频</button>
                  <button id="selectModelBtn">🎲 选择模型</button>
                  <button id="smartDetectBtn">🔍 智能检测格式</button>
              </div>
          </div>
          <div style="text-align: center; margin-top: 25px;">
              <button id="showBtn" disabled>🔍 筛选并预览</button>
              <button id="fieldSelectBtn" disabled>📝 选择导出字段</button>
              <select id="exportFormat">
                  <option value="excel">Excel</option>
                  <option value="csv">CSV</option>
                  <option value="json">JSON</option>
              </select>
              <button id="exportBtn" disabled>📊 导出</button>
              <button id="copyAllPathsBtn" disabled>📋 复制所有路径</button>
              <button id="resetBtn">🔄 重新开始</button>
          </div>
      </div>

      <!-- 步骤4: 结果展示 -->
      <div class="step hidden" id="step4">
          <div class="step-title">
              <div class="step-number">4</div>
              筛选结果
          </div>
          <div style="margin-bottom: 20px;">
              <input type="text" id="searchInput" placeholder="输入文件名或路径关键字进行过滤...">
          </div>
          <div class="stats hidden" id="stats"></div>
          
          <!-- 可视化统计图表 -->
          <div class="visualization-panel hidden" id="visualPanel">
              <div class="step-title" style="margin-bottom: 20px;">
                  <div class="step-number">📊</div>
                  资源统计可视化
              </div>
              <div class="chart-controls" style="text-align: center; margin-bottom: 20px;">
                  <button id="showTypeChartBtn">📊 按类型统计</button>
                  <button id="showSizeChartBtn">📏 按大小分布</button>
                  <button id="showFolderChartBtn">📁 按文件夹统计</button>
                  <button id="hideChartsBtn">❌ 隐藏图表</button>
              </div>
              <div class="charts-container">
                  <div class="chart-item hidden" id="typeChart">
                      <h4>文件类型分布</h4>
                      <canvas id="typeChartCanvas" width="400" height="200"></canvas>
                  </div>
                  <div class="chart-item hidden" id="sizeChart">
                      <h4>文件大小分布</h4>
                      <canvas id="sizeChartCanvas" width="400" height="200"></canvas>
                  </div>
                  <div class="chart-item hidden" id="folderChart">
                      <h4>文件夹分布（Top 10）</h4>
                      <canvas id="folderChartCanvas" width="400" height="200"></canvas>
                  </div>
              </div>
          </div>
          <div class="batch-operations hidden" id="batchOperations">
              <div class="selected-count" id="selectedCount">已选择 0 个文件</div>
              <button id="selectAllBtn2">✅ 全选</button>
              <button id="clearSelectionBtn">❌ 取消全选</button>
              <button id="copyPathsBtn" disabled>📋 复制路径</button>
              <button id="exportSelectedBtn" disabled>📊 导出选中</button>
          </div>
          <div class="resource-list" id="resourceList"></div>
          <div id="pagination"></div>
      </div>

      <!-- 步骤5: 去重与异常检测 -->
      <div class="step hidden" id="step5">
          <div class="step-title">
              <div class="step-number">5</div>
              资源去重与异常检测
          </div>
          <div style="text-align: center; margin-bottom: 25px;">
              <button id="detectDuplicatesBtn">🔍 检测重复资源</button>
              <button id="detectAnomaliesBtn">⚠️ 检测异常问题</button>
              <button id="runFullAnalysisBtn">🔬 完整分析</button>
          </div>
          
          <!-- 去重检测结果 -->
          <div id="duplicateResults" class="hidden">
              <h3 style="color: #2d3748; margin-bottom: 20px;">🔍 重复资源检测结果</h3>
              <div id="duplicateStats" class="stats"></div>
              <div id="duplicateGroups" class="resource-list"></div>
          </div>
          
          <!-- 异常检测结果 -->
          <div id="anomalyResults" class="hidden">
              <h3 style="color: #2d3748; margin-bottom: 20px;">⚠️ 异常问题检测结果</h3>
              <div id="anomalyStats" class="stats"></div>
              <div id="anomalyList" class="resource-list"></div>
          </div>
          
          <!-- 分析建议 -->
          <div id="analysisAdvice" class="hidden">
              <h3 style="color: #2d3748; margin-bottom: 20px;">💡 优化建议</h3>
              <div id="adviceContent" class="format-selector"></div>
          </div>
      </div>

      <!-- 步骤6: 资源引用关系分析 -->
      <div class="step hidden" id="step6">
          <div class="step-title">
              <div class="step-number">6</div>
              资源引用关系分析
          </div>
          <div style="text-align: center; margin-bottom: 25px;">
              <button id="analyzeReferencesBtn">🔗 分析引用关系</button>
              <button id="findUnusedAssetsBtn">🗑️ 查找未使用资源</button>
              <button id="detectCircularDepsBtn">🔄 检测循环依赖</button>
              <button id="exportDependencyBtn" disabled>📊 导出依赖报告</button>
          </div>
          
          <!-- 引用关系分析结果 -->
          <div id="referenceResults" class="hidden">
              <h3 style="color: #2d3748; margin-bottom: 20px;">🔗 引用关系分析结果</h3>
              <div id="referenceStats" class="stats"></div>
              
              <!-- 依赖关系图 -->
              <div class="dependency-graph hidden" id="dependencyGraph">
                  <h4>📊 依赖关系可视化</h4>
                  <div class="graph-controls" style="margin-bottom: 15px;">
                      <button id="showGraphBtn">📈 显示依赖图</button>
                      <button id="hideGraphBtn">❌ 隐藏依赖图</button>
                      <select id="graphTypeSelect">
                          <option value="force">力导向图</option>
                          <option value="tree">树状图</option>
                          <option value="circular">环形图</option>
                      </select>
                  </div>
                  <div id="dependencyGraphContainer" style="width: 100%; height: 400px; border: 1px solid #e2e8f0; border-radius: 8px; background: #f8fafc;"></div>
              </div>
              
              <!-- 详细分析结果 -->
              <div id="referenceDetails" class="resource-list"></div>
          </div>
          
          <!-- 未使用资源结果 -->
          <div id="unusedResults" class="hidden">
              <h3 style="color: #2d3748; margin-bottom: 20px;">🗑️ 未使用资源检测结果</h3>
              <div id="unusedStats" class="stats"></div>
              <div id="unusedList" class="resource-list"></div>
          </div>
          
          <!-- 循环依赖结果 -->
          <div id="circularResults" class="hidden">
              <h3 style="color: #2d3748; margin-bottom: 20px;">🔄 循环依赖检测结果</h3>
              <div id="circularStats" class="stats"></div>
              <div id="circularList" class="resource-list"></div>
          </div>
      </div>
  </div>

  <!-- 字段选择弹窗 -->
  <div id="fieldSelectModal" class="hidden">
    <div>
      <h3>选择要导出的字段</h3>
      <div id="fieldCheckboxes"></div>
      <div style="text-align:right;">
        <button id="cancelFieldBtn" style="background:linear-gradient(45deg, #cbd5e0, #a0aec0);color:#4a5568;">取消</button>
        <button id="confirmFieldBtn" style="margin-left:12px;">确定</button>
      </div>
    </div>
  </div>

  <script>
    // 全局变量
    let dirHandle = null;
    let allFiles = [];
    let selectedFolderPath = '';
    let filteredFiles = [];
    let resourceData = [];
    let folderTreeRoot = null;
    let scanFileCount = 0;
    let scanDirCount = 0;
    let scanProgressActive = false;
    let currentPage = 1;
    let pageSize = 100;
    let lastDisplayFiles = [];
    let selectedItems = new Set(); // 存储选中项的索引
    
    // 去重和异常检测相关
    let duplicateGroups = [];
    let anomalyResults = [];
    let analysisInProgress = false;
    
    // 引用关系分析相关
    let assetGuidMap = new Map(); // GUID -> 资源信息
    let dependencyMap = new Map(); // 资源路径 -> 依赖列表
    let reverseDepMap = new Map(); // 资源路径 -> 被引用列表
    let unusedAssets = [];
    let circularDependencies = [];
    
    // 字段定义
    const allFields = [
      {key:'文件名称', label:'文件名称', default:true},
      {key:'文件路径', label:'文件路径', default:true},
      {key:'文件类型', label:'文件类型', default:true},
      {key:'文件大小', label:'文件大小(Byte)', default:false},
      {key:'修改时间', label:'修改时间', default:false},
      {key:'父文件夹', label:'父文件夹', default:false},
      {key:'重复状态', label:'重复状态', default:false},
      {key:'异常信息', label:'异常信息', default:false}
    ];
    let selectedFields = [];
    
    // 初始化
    function init() {
      loadFieldSelect();
      bindEvents();
      checkCompatibility();
      // 确保弹窗初始状态隐藏
      document.getElementById('fieldSelectModal').classList.add('hidden');
    }
    
    // 检查浏览器兼容性
    function checkCompatibility() {
      const warningDiv = document.getElementById('compatibilityWarning');
      const dismissBtn = document.getElementById('dismissWarning');
      
      // 检查是否已经关闭过提示
      if (localStorage.getItem('unity_tool_warning_dismissed') === 'true') {
        warningDiv.classList.add('hidden');
        return;
      }
      
      // 检查浏览器支持
      const isSupported = 'showDirectoryPicker' in window;
      const userAgent = navigator.userAgent;
      const isChrome = /Chrome/.test(userAgent) && !/Edge/.test(userAgent);
      const isEdge = /Edge/.test(userAgent);
      const isSafari = /Safari/.test(userAgent) && !/Chrome/.test(userAgent);
      const isFirefox = /Firefox/.test(userAgent);
      
      if (!isSupported || isFirefox) {
        // 更新警告内容为不兼容
        const warningHeader = warningDiv.querySelector('.warning-header strong');
        const warningBody = warningDiv.querySelector('.warning-body');
        
        warningHeader.textContent = '❌ 浏览器不兼容警告';
        warningDiv.style.background = 'linear-gradient(135deg, #f8d7da, #f5c6cb)';
        warningDiv.style.borderColor = '#dc3545';
        
        warningBody.innerHTML = `
          <p><strong>抱歉，您的浏览器不支持本工具所需的 File System Access API。</strong></p>
          <div class="browser-support">
              <div class="supported">
                  <strong>✅ 请使用以下浏览器：</strong>
                  <ul>
                      <li>Chrome 86+ (强烈推荐)</li>
                      <li>Microsoft Edge 86+</li>
                      <li>Safari 15.2+ (macOS)</li>
                  </ul>
              </div>
              <div class="not-supported">
                  <strong>❌ 当前浏览器：</strong>
                  <ul>
                      <li>${isFirefox ? 'Firefox (不支持)' : '未知浏览器'}</li>
                      <li>建议切换到Chrome浏览器</li>
                  </ul>
              </div>
          </div>
          <div class="security-note">
              <strong>📱 如何解决：</strong>
              <ul>
                  <li>下载并安装 Google Chrome 浏览器</li>
                  <li>或使用 Microsoft Edge 浏览器</li>
                  <li>macOS 用户可以使用 Safari 15.2+</li>
                  <li>然后重新访问本工具</li>
              </ul>
          </div>
        `;
      }
      
      // 绑定关闭事件
      dismissBtn.onclick = function() {
        warningDiv.classList.add('hidden');
        localStorage.setItem('unity_tool_warning_dismissed', 'true');
      };
    }
    
    // 读取本地字段选择
    function loadFieldSelect() {
      let saved = localStorage.getItem('unity_asset_export_fields');
      if (saved) {
        try {
          selectedFields = JSON.parse(saved);
        } catch(e) {
          selectedFields = [];
        }
      }
      if (!selectedFields || !Array.isArray(selectedFields) || selectedFields.length === 0) {
        selectedFields = allFields.filter(f => f.default).map(f => f.key);
      }
    }
    
    // 绑定事件
    function bindEvents() {
      // 主要按钮事件
      document.getElementById('pickDirBtn').onclick = pickDirectory;
      document.getElementById('expandAllBtn').onclick = expandAll;
      document.getElementById('collapseAllBtn').onclick = collapseAll;
      document.getElementById('showBtn').onclick = showResults;
      document.getElementById('fieldSelectBtn').onclick = openFieldSelect;
      document.getElementById('exportBtn').onclick = exportData;
      document.getElementById('copyAllPathsBtn').onclick = copyAllPaths;
      document.getElementById('resetBtn').onclick = resetTool;
      
      // 快捷选择按钮
      document.getElementById('selectAllBtn').onclick = selectAllFormats;
      document.getElementById('clearAllBtn').onclick = clearAllFormats;
      document.getElementById('selectImageBtn').onclick = selectImageFormats;
      document.getElementById('selectAudioBtn').onclick = selectAudioFormats;
      document.getElementById('selectModelBtn').onclick = selectModelFormats;
      document.getElementById('smartDetectBtn').onclick = smartDetectFormats;
      
      // 字段选择弹窗
      document.getElementById('cancelFieldBtn').onclick = closeFieldSelect;
      document.getElementById('confirmFieldBtn').onclick = applyFieldSelect;
      
      // 批量操作按钮
      document.getElementById('selectAllBtn2').onclick = selectAllItems;
      document.getElementById('clearSelectionBtn').onclick = clearSelection;
      document.getElementById('copyPathsBtn').onclick = copySelectedPaths;
      document.getElementById('exportSelectedBtn').onclick = exportSelectedItems;
      
      // 去重和异常检测按钮
      document.getElementById('detectDuplicatesBtn').onclick = detectDuplicates;
      document.getElementById('detectAnomaliesBtn').onclick = detectAnomalies;
      document.getElementById('runFullAnalysisBtn').onclick = runFullAnalysis;
      
      // 可视化图表按钮
      document.getElementById('showTypeChartBtn').onclick = showTypeChart;
      document.getElementById('showSizeChartBtn').onclick = showSizeChart;
      document.getElementById('showFolderChartBtn').onclick = showFolderChart;
      document.getElementById('hideChartsBtn').onclick = hideCharts;
      
      // 引用关系分析按钮
      document.getElementById('analyzeReferencesBtn').onclick = analyzeReferences;
      document.getElementById('findUnusedAssetsBtn').onclick = findUnusedAssets;
      document.getElementById('detectCircularDepsBtn').onclick = detectCircularDependencies;
      document.getElementById('exportDependencyBtn').onclick = exportDependencyReport;
      
      // 搜索输入框
      document.getElementById('searchInput').addEventListener('input', function() {
        currentPage = 1;
        selectedItems.clear();
        updateBatchOperations();
        renderFilteredResults();
      });
      
      // 页面卸载时清理
      window.addEventListener('beforeunload', function() {
        if(window._previewBlobUrls) {
          window._previewBlobUrls.forEach(url => URL.revokeObjectURL(url));
          window._previewBlobUrls = [];
        }
      });
    }
    
    // 进度条相关
    function showScanProgress() {
      document.getElementById('scanProgressBar').classList.remove('hidden');
      updateScanProgress();
    }
    
    function hideScanProgress() {
      document.getElementById('scanProgressBar').classList.add('hidden');
    }
    
    function updateScanProgress(currentDir) {
      const text = `已扫描 <b>${scanFileCount}</b> 个文件，<b>${scanDirCount}</b> 个文件夹${currentDir ? '，当前目录：' + currentDir : ''}`;
      document.getElementById('scanProgressText').innerHTML = text;
      if (scanProgressActive) {
        const percent = (scanFileCount % 100) + 1;
        document.getElementById('scanProgressInner').style.width = percent + '%';
      } else {
        document.getElementById('scanProgressInner').style.width = '0%';
      }
    }
    
    // 选择目录
    async function pickDirectory() {
      if (!window.showDirectoryPicker) {
        alert('你的浏览器不支持本地目录访问（File System Access API）。请使用最新版 Chrome、Edge 或 Safari。');
        return;
      }
      
      try {
        dirHandle = await window.showDirectoryPicker();
        document.getElementById('pickedDir').textContent = '已选择目录: ' + dirHandle.name;
        document.getElementById('step2').classList.remove('hidden');
        
        // 重置状态
        allFiles = [];
        selectedFolderPath = '';
        filteredFiles = [];
        resourceData = [];
        folderTreeRoot = null;
        document.getElementById('step3').classList.add('hidden');
        document.getElementById('step4').classList.add('hidden');
        
        // 显示开始扫描按钮
        showStartScanButton();
        
      } catch (e) {
        console.log('用户取消选择目录');
      }
    }
    
    // 显示开始扫描按钮
    function showStartScanButton() {
      const existingBtn = document.getElementById('startScanBtn');
      if (existingBtn) {
        existingBtn.remove();
      }
      
      const scanOptions = document.querySelector('.scan-options');
      const startBtn = document.createElement('button');
      startBtn.id = 'startScanBtn';
      startBtn.innerHTML = '🚀 开始扫描';
      startBtn.style.cssText = `
        background: linear-gradient(45deg, #4CAF50, #45a049);
        font-size: 16px;
        padding: 12px 24px;
        margin-top: 15px;
        width: 100%;
        box-shadow: 0 4px 15px rgba(76, 175, 80, 0.3);
      `;
      startBtn.onclick = startScanning;
      scanOptions.appendChild(startBtn);
    }
    
    // 开始扫描
    async function startScanning() {
      if (!dirHandle) {
        alert('请先选择Unity项目目录');
        return;
      }
      
      // 隐藏开始扫描按钮
      const startBtn = document.getElementById('startScanBtn');
      if (startBtn) {
        startBtn.style.display = 'none';
      }
      
      // 重置扫描状态
      scanFileCount = 0;
      scanDirCount = 0;
      scanProgressActive = true;
      showScanProgress();
      
      try {
        await initFolderTree();
        scanProgressActive = false;
        hideScanProgress();
      } catch (e) {
        scanProgressActive = false;
        hideScanProgress();
        console.error('扫描过程中出错:', e);
        alert('扫描过程中出现错误，请重试');
        
        // 重新显示开始扫描按钮
        if (startBtn) {
          startBtn.style.display = 'block';
        }
      }
    }
    
    // 懒加载文件夹树
    async function buildLazyFolderTree(handle, pathPrefix = '', pathArr = []) {
      const entries = [];
      for await (const entry of handle.values()) {
        entries.push(entry);
      }
      
      const folders = [];
      const files = [];
      
      for (const entry of entries) {
        if (entry.kind === 'directory') {
          folders.push({
            name: entry.name,
            path: pathPrefix + entry.name,
            handle: entry,
            loaded: false,
            children: [],
            parent: pathArr.length ? pathArr.join('/') : null,
            expanded: false,
            fileCount: 0
          });
        } else if (entry.kind === 'file') {
          files.push({
            name: entry.name,
            path: pathPrefix + entry.name,
            ext: entry.name.includes('.') ? entry.name.split('.').pop().toLowerCase() : '',
            pathArr: [...pathArr, entry.name],
            size: '',
            lastModified: '',
            parentFolder: pathArr.length > 0 ? pathArr[pathArr.length - 1] : ''
          });
        }
      }
      
      return {folders, files};
    }
    
    // 初始化文件夹树
    async function initFolderTree() {
      if (!dirHandle) return;
      
      // 获取扫描范围
      const scanScope = document.querySelector('input[name="scanScope"]:checked').value;
      let scanHandle = dirHandle;
      let scanPath = '';
      
      if (scanScope === 'assets') {
        // 尝试找到Assets文件夹
        try {
          scanHandle = await dirHandle.getDirectoryHandle('Assets');
          scanPath = 'Assets/';
          console.log('使用Assets目录扫描');
        } catch (e) {
          console.warn('未找到Assets文件夹，使用完整扫描');
          alert('⚠️ 未找到Assets文件夹，将使用完整扫描模式。\n请确保选择的是Unity项目根目录。');
        }
      }
      
      const {folders} = await buildLazyFolderTree(scanHandle, scanPath, scanPath ? ['Assets'] : []);
      folderTreeRoot = folders.map(f => ({...f}));
      renderFolderTree();
      
      // 扫描完成提示
      if (allFiles.length > 0) {
        const scopeText = scanScope === 'assets' ? '（仅Assets目录）' : 
                         scanScope === 'custom' ? '（自定义范围）' : '（完整项目）';
        const summary = `✅ 扫描完成${scopeText}！发现 ${scanFileCount} 个文件，${scanDirCount} 个文件夹`;
        document.getElementById('scanProgressText').innerHTML = summary;
        
        // 3秒后隐藏进度条
        setTimeout(() => {
          hideScanProgress();
        }, 3000);
      }
    }
    
    // 懒加载子目录
    async function loadFolderChildren(folder) {
      if (folder.loaded) return;
      
      const {folders, files} = await buildLazyFolderTree(
        folder.handle, 
        folder.path + '/', 
        folder.path ? folder.path.split('/') : []
      );
      
      folder.children = folders;
      folder.loaded = true;
      folder.fileCount = files.length;
    }
    
    // 渲染文件夹树
    function renderFolderTree() {
      const folderTree = document.getElementById('folderTree');
      folderTree.innerHTML = '';
      
      if (!folderTreeRoot) return;
      
      folderTreeRoot.forEach(rootFolder => {
        renderFolderNodeLazy(rootFolder, folderTree, 0);
      });
    }
    
    // 渲染文件夹节点
    function renderFolderNodeLazy(folder, container, depth) {
      const folderItem = document.createElement('div');
      folderItem.className = 'folder-item' + (selectedFolderPath === folder.path ? ' selected' : '');
      folderItem.dataset.path = folder.path;
      
      const indent = '　'.repeat(depth);
      folderItem.innerHTML = `
        <div class="folder-content">
          <div class="folder-toggle ${folder.expanded ? 'expanded' : ''}">${folder.expanded ? '▼' : '▶'}</div>
          <span class="folder-icon">📁</span>
          <span class="folder-name">${indent}${folder.name}</span>
          ${folder.fileCount > 0 ? `<span class="file-count">${folder.fileCount}</span>` : ''}
        </div>
      `;
      
      // 展开/折叠事件
      folderItem.querySelector('.folder-toggle').onclick = async (e) => {
        e.stopPropagation();
        if (!folder.expanded) {
          await loadFolderChildren(folder);
        }
        folder.expanded = !folder.expanded;
        renderFolderTree();
      };
      
      // 选择文件夹事件
      folderItem.addEventListener('click', function(e) {
        if (e.target.classList.contains('folder-toggle')) return;
        
        document.querySelectorAll('.folder-item').forEach(item => {
          item.classList.remove('selected');
        });
        
        this.classList.add('selected');
        selectedFolderPath = this.dataset.path;
        document.getElementById('selectedFolder').textContent = `已选择: ${selectedFolderPath}`;
        document.getElementById('step3').classList.remove('hidden');
        document.getElementById('showBtn').disabled = false;
        document.getElementById('fieldSelectBtn').disabled = false;
        document.getElementById('exportBtn').disabled = false;
        document.getElementById('copyAllPathsBtn').disabled = false;
        document.getElementById('step4').classList.add('hidden');
      });
      
      container.appendChild(folderItem);
      
      // 渲染子文件夹
      if (folder.expanded && folder.children && folder.children.length > 0) {
        const childrenContainer = document.createElement('div');
        childrenContainer.className = 'folder-children';
        
        folder.children.forEach(childFolder => {
          renderFolderNodeLazy(childFolder, childrenContainer, depth + 1);
        });
        
        container.appendChild(childrenContainer);
      }
    }
    
    // 展开/折叠所有文件夹
    function expandAll() {
      // 懒加载情况下，只能展开已加载的
      if (folderTreeRoot) {
        expandFolderRecursive(folderTreeRoot);
        renderFolderTree();
      }
    }
    
    function collapseAll() {
      if (folderTreeRoot) {
        collapseFolderRecursive(folderTreeRoot);
        renderFolderTree();
      }
    }
    
    function expandFolderRecursive(folders) {
      folders.forEach(folder => {
        folder.expanded = true;
        if (folder.children && folder.children.length > 0) {
          expandFolderRecursive(folder.children);
        }
      });
    }
    
    function collapseFolderRecursive(folders) {
      folders.forEach(folder => {
        folder.expanded = false;
        if (folder.children && folder.children.length > 0) {
          collapseFolderRecursive(folder.children);
        }
      });
    }
    
    // 格式选择相关
    function getSelectedFormats() {
      const checkboxes = document.querySelectorAll('.format-option input[type="checkbox"]:checked');
      return Array.from(checkboxes).map(cb => cb.value);
    }
    
    function selectAllFormats() {
      document.querySelectorAll('.format-option input[type="checkbox"]').forEach(cb => cb.checked = true);
    }
    
    function clearAllFormats() {
      document.querySelectorAll('.format-option input[type="checkbox"]').forEach(cb => cb.checked = false);
    }
    
    function selectImageFormats() {
      clearAllFormats();
      ['png','jpg','tga','psd'].forEach(id => {
        const el = document.getElementById(id);
        if (el) el.checked = true;
      });
    }
    
    function selectAudioFormats() {
      clearAllFormats();
      ['wav','mp3','ogg'].forEach(id => {
        const el = document.getElementById(id);
        if (el) el.checked = true;
      });
    }
    
    function selectModelFormats() {
      clearAllFormats();
      ['fbx','obj','blend'].forEach(id => {
        const el = document.getElementById(id);
        if (el) el.checked = true;
      });
    }
    
    // 智能格式检测
    function smartDetectFormats() {
      if (!selectedFolderPath || allFiles.length === 0) {
        alert('请先选择文件夹并等待扫描完成');
        return;
      }
      
      // 获取选中文件夹下的所有文件
      const folderFiles = allFiles.filter(f => f.path.startsWith(selectedFolderPath + '/'));
      
      if (folderFiles.length === 0) {
        alert('选中的文件夹中没有找到文件，请选择其他文件夹');
        return;
      }
      
      // 统计文件格式
      const extCounts = {};
      folderFiles.forEach(f => {
        if (f.ext) {
          extCounts[f.ext] = (extCounts[f.ext] || 0) + 1;
        }
      });
      
      // 清空当前选择
      clearAllFormats();
      
      // 定义工具支持的格式映射
      const formatMap = {
        'prefab': 'prefab',
        'unity': 'unity',
        'png': 'png',
        'jpg': 'jpg',
        'jpeg': 'jpg',
        'tga': 'tga',
        'psd': 'psd',
        'wav': 'wav',
        'mp3': 'mp3',
        'ogg': 'ogg',
        'fbx': 'fbx',
        'obj': 'obj',
        'blend': 'blend',
        'cs': 'cs',
        'js': 'js',
        'txt': 'txt',
        'json': 'json',
        'xml': 'xml'
      };
      
      // 自动选择存在的格式
      let selectedCount = 0;
      const detectedFormats = [];
      
      Object.entries(extCounts).forEach(([ext, count]) => {
        if (formatMap[ext]) {
          const checkbox = document.getElementById(formatMap[ext]);
          if (checkbox) {
            checkbox.checked = true;
            selectedCount++;
            detectedFormats.push(`${ext.toUpperCase()}(${count}个)`);
          }
        }
      });
      
      // 显示检测结果
      if (selectedCount > 0) {
        alert(`🎯 智能检测完成！\n\n` +
              `在文件夹"${selectedFolderPath}"中检测到以下格式：\n` +
              `${detectedFormats.join(', ')}\n\n` +
              `已自动为您选择这些格式，您可以直接点击"筛选并预览"。`);
      } else {
        // 显示所有检测到的格式
        const allFormats = Object.entries(extCounts)
          .sort((a, b) => b[1] - a[1])
          .slice(0, 10)
          .map(([ext, count]) => `${ext || '(无扩展名)'}: ${count}个`)
          .join('\n');
        
        alert(`❌ 未检测到工具支持的格式\n\n` +
              `该文件夹中的文件格式分布：\n${allFormats}\n\n` +
              `建议：\n1. 选择Unity项目的Assets文件夹\n2. 手动选择需要的格式`);
      }
    }
    
    // 扫描选中文件夹的文件
    async function scanSelectedFolder() {
      if (!selectedFolderPath || !dirHandle) return [];
      
      const files = [];
      const pathParts = selectedFolderPath.split('/');
      
      let currentHandle = dirHandle;
      for (const part of pathParts) {
        currentHandle = await currentHandle.getDirectoryHandle(part);
      }
      
      await scanDirRecursive(currentHandle, selectedFolderPath + '/', pathParts);
      return allFiles.filter(f => f.path.startsWith(selectedFolderPath + '/'));
    }
    
    async function scanDirRecursive(handle, pathPrefix, pathArr) {
      scanDirCount++;
      updateScanProgress(pathPrefix);
      
      let batch = 0;
      const entries = [];
      
      try {
        for await (const entry of handle.values()) {
          entries.push(entry);
        }
      } catch (e) {
        console.warn('无法读取目录:', pathPrefix, e);
        return;
      }
      
      for (let i = 0; i < entries.length; i++) {
        const entry = entries[i];
        
        try {
          if (entry.kind === 'file') {
            let fileObj = {
              name: entry.name,
              path: pathPrefix + entry.name,
              ext: entry.name.includes('.') ? entry.name.split('.').pop().toLowerCase() : '',
              pathArr: [...pathArr, entry.name],
              size: 0,
              lastModified: '',
              parentFolder: pathArr.length > 0 ? pathArr[pathArr.length - 1] : ''
            };
            
            try {
              const file = await entry.getFile();
              fileObj.size = file.size;
              fileObj.lastModified = new Date(file.lastModified).toLocaleString();
            } catch(e) {
              console.warn('无法获取文件信息:', entry.name, e);
              // 即使无法获取详细信息，也保留文件记录
            }
            
            allFiles.push(fileObj);
            scanFileCount++;
            
            // 添加调试日志（仅在控制台显示）
            if (scanFileCount <= 10) {
              console.log('扫描到文件:', fileObj.path, '格式:', fileObj.ext);
            }
            
          } else if (entry.kind === 'directory') {
            // 跳过一些系统目录
            const skipDirs = ['.git', '.svn', 'node_modules', '.DS_Store', 'Temp', 'Library'];
            if (!skipDirs.includes(entry.name)) {
              await scanDirRecursive(entry, pathPrefix + entry.name + '/', [...pathArr, entry.name]);
            }
          }
        } catch (e) {
          console.warn('处理条目失败:', entry.name, e);
          continue;
        }
        
        batch++;
        if (batch % 30 === 0) {
          updateScanProgress(pathPrefix);
          await new Promise(res => setTimeout(res, 0));
        }
      }
      
      updateScanProgress(pathPrefix);
    }
    
    // 显示筛选结果
    async function showResults() {
      if (!selectedFolderPath) {
        alert('请先选择目标文件夹');
        return;
      }
      
      const selectedFormats = getSelectedFormats();
      if (selectedFormats.length === 0) {
        alert('请至少选择一种文件格式！');
        return;
      }
      
      // 如果还没有扫描过选中文件夹，先扫描
      if (allFiles.length === 0 || !allFiles.some(f => f.path.startsWith(selectedFolderPath + '/'))) {
        scanFileCount = 0;
        scanDirCount = 0;
        scanProgressActive = true;
        showScanProgress();
        
        await scanSelectedFolder();
        
        scanProgressActive = false;
        hideScanProgress();
      }
      
      // 筛选文件
      filteredFiles = allFiles.filter(file => {
        if (!file.path.startsWith(selectedFolderPath + '/')) return false;
        
        if (selectedFormats.includes(file.ext)) return true;
        if (selectedFormats.includes('jpg') && (file.ext === 'jpg' || file.ext === 'jpeg')) return true;
        
        return false;
      });
      
      if (filteredFiles.length === 0) {
        // 添加详细的调试信息
        const debugInfo = `
          <div style="text-align: center; color: #718096; padding: 40px;">
            <div style="font-size: 18px; margin-bottom: 20px;">❌ 未找到任何目标格式的文件</div>
            <div style="background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 8px; padding: 20px; margin: 20px auto; max-width: 600px; text-align: left;">
              <h4 style="margin-top: 0; color: #2d3748;">📊 扫描统计信息：</h4>
              <p><strong>选择的文件夹：</strong> ${selectedFolderPath || '未选择'}</p>
              <p><strong>扫描到的总文件数：</strong> ${allFiles.length}</p>
              <p><strong>选择的格式：</strong> ${selectedFormats.join(', ') || '未选择'}</p>
              <p><strong>该文件夹下的文件数：</strong> ${allFiles.filter(f => f.path.startsWith(selectedFolderPath + '/')).length}</p>
              ${allFiles.length > 0 ? `
                <h4 style="color: #2d3748;">📁 文件夹下的文件类型分布：</h4>
                <div style="font-size: 12px; color: #4a5568;">
                  ${(() => {
                    const folderFiles = allFiles.filter(f => f.path.startsWith(selectedFolderPath + '/'));
                    const extCounts = {};
                    folderFiles.forEach(f => {
                      extCounts[f.ext] = (extCounts[f.ext] || 0) + 1;
                    });
                    return Object.entries(extCounts)
                      .sort((a, b) => b[1] - a[1])
                      .slice(0, 10)
                      .map(([ext, count]) => `${ext || '(无扩展名)'}: ${count}个`)
                      .join('<br>');
                  })()}
                </div>
              ` : ''}
            </div>
            <div style="margin-top: 20px;">
              <h4 style="color: #2d3748;">💡 可能的解决方案：</h4>
              <div style="text-align: left; max-width: 500px; margin: 0 auto; color: #4a5568;">
                <p>1. 确认选择的文件夹中确实包含目标格式的文件</p>
                <p>2. 检查是否选择了正确的文件格式</p>
                <p>3. 尝试选择项目的根目录或Assets文件夹</p>
                <p>4. 如果是刚扫描的项目，请等待扫描完成</p>
              </div>
            </div>
          </div>
        `;
        document.getElementById('resourceList').innerHTML = debugInfo;
        document.getElementById('stats').style.display = 'none';
        document.getElementById('step4').classList.remove('hidden');
        return;
      }
      
      // 构建资源数据
      resourceData = filteredFiles.map(f => ({
        '文件名称': f.name,
        '文件路径': f.path,
        '文件类型': f.ext.toUpperCase(),
        '文件大小': f.size,
        '修改时间': f.lastModified,
        '父文件夹': f.parentFolder,
        '重复状态': '未检测',
        '异常信息': '未检测'
      }));
      
      currentPage = 1;
      document.getElementById('step4').classList.remove('hidden');
      document.getElementById('step5').classList.remove('hidden'); // 显示步骤5
      document.getElementById('step6').classList.remove('hidden'); // 显示步骤6
      document.getElementById('visualPanel').classList.remove('hidden'); // 显示可视化面板
      renderFilteredResults();
    }
    
    // 可视化图表功能
    let currentCharts = {};
    
    function showTypeChart() {
      if (!resourceData || resourceData.length === 0) {
        alert('请先扫描和筛选资源文件');
        return;
      }
      
      // 统计文件类型
      const typeCounts = {};
      resourceData.forEach(f => {
        const type = f['文件类型'].toLowerCase();
        typeCounts[type] = (typeCounts[type] || 0) + 1;
      });
      
      const sortedTypes = Object.entries(typeCounts)
        .sort((a, b) => b[1] - a[1])
        .slice(0, 10); // 取前10种类型
      
      const labels = sortedTypes.map(([type, count]) => `${type.toUpperCase()} (${count})`);
      const data = sortedTypes.map(([type, count]) => count);
      const colors = generateColors(sortedTypes.length);
      
      document.getElementById('typeChart').classList.remove('hidden');
      
      const ctx = document.getElementById('typeChartCanvas').getContext('2d');
      
      // 销毁之前的图表
      if (currentCharts.typeChart) {
        currentCharts.typeChart.destroy();
      }
      
      currentCharts.typeChart = new Chart(ctx, {
        type: 'doughnut',
        data: {
          labels: labels,
          datasets: [{
            data: data,
            backgroundColor: colors,
            borderWidth: 2,
            borderColor: '#ffffff'
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              position: 'bottom',
              labels: {
                padding: 15,
                usePointStyle: true,
                font: {
                  size: 12
                }
              }
            },
            tooltip: {
              callbacks: {
                label: function(context) {
                  const total = context.dataset.data.reduce((a, b) => a + b, 0);
                  const percentage = ((context.parsed * 100) / total).toFixed(1);
                  return `${context.label}: ${percentage}%`;
                }
              }
            }
          }
        }
      });
    }
    
    function showSizeChart() {
      if (!resourceData || resourceData.length === 0) {
        alert('请先扫描和筛选资源文件');
        return;
      }
      
      // 按文件大小分组
      const sizeRanges = [
        { label: '< 10KB', min: 0, max: 10 * 1024 },
        { label: '10KB - 100KB', min: 10 * 1024, max: 100 * 1024 },
        { label: '100KB - 1MB', min: 100 * 1024, max: 1024 * 1024 },
        { label: '1MB - 10MB', min: 1024 * 1024, max: 10 * 1024 * 1024 },
        { label: '10MB - 50MB', min: 10 * 1024 * 1024, max: 50 * 1024 * 1024 },
        { label: '> 50MB', min: 50 * 1024 * 1024, max: Infinity }
      ];
      
      const sizeCounts = sizeRanges.map(range => {
        return resourceData.filter(f => {
          const size = f['文件大小'] || 0;
          return size >= range.min && size < range.max;
        }).length;
      });
      
      const labels = sizeRanges.map(range => range.label);
      const colors = ['#ff6384', '#36a2eb', '#ffce56', '#4bc0c0', '#9966ff', '#ff9f40'];
      
      document.getElementById('sizeChart').classList.remove('hidden');
      
      const ctx = document.getElementById('sizeChartCanvas').getContext('2d');
      
      if (currentCharts.sizeChart) {
        currentCharts.sizeChart.destroy();
      }
      
      currentCharts.sizeChart = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: labels,
          datasets: [{
            label: '文件数量',
            data: sizeCounts,
            backgroundColor: colors,
            borderColor: colors.map(color => color + '80'),
            borderWidth: 1
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              display: false
            },
            tooltip: {
              callbacks: {
                label: function(context) {
                  return `${context.label}: ${context.parsed.y} 个文件`;
                }
              }
            }
          },
          scales: {
            y: {
              beginAtZero: true,
              ticks: {
                stepSize: 1
              }
            }
          }
        }
      });
    }
    
    function showFolderChart() {
      if (!resourceData || resourceData.length === 0) {
        alert('请先扫描和筛选资源文件');
        return;
      }
      
      // 统计文件夹分布
      const folderCounts = {};
      resourceData.forEach(f => {
        const folder = f['父文件夹'] || '根目录';
        folderCounts[folder] = (folderCounts[folder] || 0) + 1;
      });
      
      const sortedFolders = Object.entries(folderCounts)
        .sort((a, b) => b[1] - a[1])
        .slice(0, 10); // 取前10个文件夹
      
      const labels = sortedFolders.map(([folder, count]) => folder);
      const data = sortedFolders.map(([folder, count]) => count);
      const colors = generateColors(sortedFolders.length);
      
      document.getElementById('folderChart').classList.remove('hidden');
      
      const ctx = document.getElementById('folderChartCanvas').getContext('2d');
      
      if (currentCharts.folderChart) {
        currentCharts.folderChart.destroy();
      }
      
      currentCharts.folderChart = new Chart(ctx, {
        type: 'horizontalBar',
        data: {
          labels: labels,
          datasets: [{
            label: '文件数量',
            data: data,
            backgroundColor: colors,
            borderColor: colors.map(color => color + '80'),
            borderWidth: 1
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              display: false
            },
            tooltip: {
              callbacks: {
                label: function(context) {
                  return `${context.label}: ${context.parsed.x} 个文件`;
                }
              }
            }
          },
          scales: {
            x: {
              beginAtZero: true,
              ticks: {
                stepSize: 1
              }
            }
          }
        }
      });
    }
    
    function hideCharts() {
      document.getElementById('typeChart').classList.add('hidden');
      document.getElementById('sizeChart').classList.add('hidden');
      document.getElementById('folderChart').classList.add('hidden');
      
      // 销毁所有图表
      Object.values(currentCharts).forEach(chart => {
        if (chart) chart.destroy();
      });
      currentCharts = {};
    }
    
    // 生成颜色数组
    function generateColors(count) {
      const baseColors = [
        '#ff6384', '#36a2eb', '#ffce56', '#4bc0c0', '#9966ff', 
        '#ff9f40', '#ff6384', '#c9cbcf', '#4bc0c0', '#ff6384'
      ];
      
      const colors = [];
      for (let i = 0; i < count; i++) {
        if (i < baseColors.length) {
          colors.push(baseColors[i]);
        } else {
          // 生成随机颜色
          const hue = (i * 137.508) % 360; // 黄金角度
          colors.push(`hsl(${hue}, 70%, 60%)`);
        }
      }
      return colors;
    }
    
    // ========================================
    // 引用关系分析功能
    // ========================================
    
    // 分析引用关系
    async function analyzeReferences() {
      if (!dirHandle || !resourceData || resourceData.length === 0) {
        alert('请先扫描资源文件');
        return;
      }
      
      analysisInProgress = true;
      showScanProgress();
      document.getElementById('scanProgressText').innerHTML = '正在分析资源引用关系...';
      
      // 重置数据
      assetGuidMap.clear();
      dependencyMap.clear();
      reverseDepMap.clear();
      
      try {
        // 第一步：收集所有资源的GUID信息
        await collectAssetGuids();
        
        // 第二步：分析依赖关系
        await analyzeDependencies();
        
        // 第三步：构建反向引用关系
        buildReverseReferences();
        
        // 显示结果
        renderReferenceResults();
        
      } catch (error) {
        console.error('分析引用关系失败:', error);
        alert('分析引用关系失败: ' + error.message);
      } finally {
        analysisInProgress = false;
        hideScanProgress();
      }
    }
    
    // 收集资源GUID信息
    async function collectAssetGuids() {
      document.getElementById('scanProgressText').innerHTML = '正在收集资源GUID信息...';
      
      let processed = 0;
      const totalFiles = allFiles.length;
      
      for (const file of allFiles) {
        try {
          // 查找对应的.meta文件
          const metaPath = file.path + '.meta';
          const metaHandle = await getFileHandleByPath(dirHandle, metaPath);
          
          if (metaHandle) {
            const metaFile = await metaHandle.getFile();
            const metaContent = await metaFile.text();
            const guid = extractGuidFromMeta(metaContent);
            
            if (guid) {
              assetGuidMap.set(guid, {
                path: file.path,
                name: file.name,
                ext: file.ext,
                guid: guid
              });
            }
          }
        } catch (e) {
          // 忽略无法读取的文件
        }
        
        processed++;
        if (processed % 10 === 0) {
          document.getElementById('scanProgressText').innerHTML = 
            `正在收集资源GUID信息... (${processed}/${totalFiles})`;
          await new Promise(res => setTimeout(res, 0));
        }
      }
    }
    
    // 从.meta文件中提取GUID
    function extractGuidFromMeta(metaContent) {
      const guidMatch = metaContent.match(/guid:\s*([a-f0-9]{32})/i);
      return guidMatch ? guidMatch[1] : null;
    }
    
    // 分析依赖关系
    async function analyzeDependencies() {
      document.getElementById('scanProgressText').innerHTML = '正在分析依赖关系...';
      
      const unityFiles = allFiles.filter(f => 
        ['prefab', 'unity', 'mat', 'asset'].includes(f.ext.toLowerCase())
      );
      
      let processed = 0;
      const totalFiles = unityFiles.length;
      
      for (const file of unityFiles) {
        try {
          const fileHandle = await getFileHandleByPath(dirHandle, file.path);
          if (fileHandle) {
            const fileContent = await fileHandle.getFile();
            const content = await fileContent.text();
            const dependencies = extractDependencies(content);
            
            if (dependencies.length > 0) {
              dependencyMap.set(file.path, dependencies);
            }
          }
        } catch (e) {
          console.warn('分析文件依赖失败:', file.path, e);
        }
        
        processed++;
        if (processed % 5 === 0) {
          document.getElementById('scanProgressText').innerHTML = 
            `正在分析依赖关系... (${processed}/${totalFiles})`;
          await new Promise(res => setTimeout(res, 0));
        }
      }
    }
    
    // 从文件内容中提取依赖关系
    function extractDependencies(content) {
      const dependencies = [];
      
      // 匹配GUID引用模式
      const guidPattern = /guid:\s*([a-f0-9]{32})/gi;
      let match;
      
      while ((match = guidPattern.exec(content)) !== null) {
        const guid = match[1];
        const asset = assetGuidMap.get(guid);
        
        if (asset && !dependencies.some(dep => dep.guid === guid)) {
          dependencies.push({
            guid: guid,
            path: asset.path,
            name: asset.name,
            type: getAssetType(asset.ext)
          });
        }
      }
      
      return dependencies;
    }
    
    // 获取资源类型
    function getAssetType(ext) {
      const typeMap = {
        'prefab': 'prefab',
        'png': 'texture',
        'jpg': 'texture',
        'jpeg': 'texture',
        'mat': 'material',
        'cs': 'script',
        'unity': 'scene',
        'fbx': 'model',
        'wav': 'audio',
        'mp3': 'audio'
      };
      return typeMap[ext.toLowerCase()] || 'other';
    }
    
    // 构建反向引用关系
    function buildReverseReferences() {
      reverseDepMap.clear();
      
      for (const [filePath, dependencies] of dependencyMap) {
        dependencies.forEach(dep => {
          if (!reverseDepMap.has(dep.path)) {
            reverseDepMap.set(dep.path, []);
          }
          
          reverseDepMap.get(dep.path).push({
            path: filePath,
            name: filePath.split('/').pop(),
            type: getAssetType(filePath.split('.').pop())
          });
        });
      }
    }
    
    // 渲染引用关系分析结果
    function renderReferenceResults() {
      document.getElementById('step6').classList.remove('hidden');
      document.getElementById('referenceResults').classList.remove('hidden');
      document.getElementById('exportDependencyBtn').disabled = false;
      
      // 统计信息
      const totalAssets = assetGuidMap.size;
      const assetsWithDeps = dependencyMap.size;
      const totalDependencies = Array.from(dependencyMap.values())
        .reduce((sum, deps) => sum + deps.length, 0);
      
      let statsHtml = `<div style="font-size:18px;font-weight:600;">分析了 <b>${totalAssets}</b> 个资源，发现 <b>${totalDependencies}</b> 个依赖关系</div>`;
      statsHtml += '<div class="stats-grid">';
      statsHtml += `<div class="stat-item"><div class="stat-number">${totalAssets}</div><div class="stat-label">总资源数</div></div>`;
      statsHtml += `<div class="stat-item"><div class="stat-number">${assetsWithDeps}</div><div class="stat-label">有依赖的资源</div></div>`;
      statsHtml += `<div class="stat-item"><div class="stat-number">${totalDependencies}</div><div class="stat-label">依赖关系数</div></div>`;
      statsHtml += `<div class="stat-item"><div class="stat-number">${reverseDepMap.size}</div><div class="stat-label">被引用的资源</div></div>`;
      statsHtml += '</div>';
      
      document.getElementById('referenceStats').innerHTML = statsHtml;
      
      // 详细依赖关系列表
      let detailsHtml = '';
      let itemCount = 0;
      const maxItems = 50; // 限制显示数量以提高性能
      
      for (const [filePath, dependencies] of dependencyMap) {
        if (itemCount >= maxItems) {
          detailsHtml += `<div style="text-align: center; padding: 20px; color: #718096;">
            还有 ${dependencyMap.size - maxItems} 个资源未显示，请使用导出功能查看完整报告
          </div>`;
          break;
        }
        
        const fileName = filePath.split('/').pop();
        const references = reverseDepMap.get(filePath) || [];
        
        detailsHtml += `<div class="reference-item">
          <div class="reference-header">
            📄 ${fileName}
            <span class="reference-count">依赖 ${dependencies.length}</span>
            <span class="reference-count">被引用 ${references.length}</span>
          </div>
          <div class="reference-path">${filePath}</div>
          
          ${dependencies.length > 0 ? `
            <div class="reference-dependencies">
              <strong>依赖的资源：</strong>
              <div class="dependency-list">
                ${dependencies.slice(0, 10).map(dep => `
                  <div class="dependency-item">
                    <span class="dependency-type ${dep.type}">${dep.type}</span>
                    <span>${dep.name}</span>
                  </div>
                `).join('')}
                ${dependencies.length > 10 ? `<div style="color: #718096; font-size: 12px;">还有 ${dependencies.length - 10} 个依赖...</div>` : ''}
              </div>
            </div>
          ` : ''}
          
          ${references.length > 0 ? `
            <div class="reference-dependencies">
              <strong>被以下资源引用：</strong>
              <div class="dependency-list">
                ${references.slice(0, 5).map(ref => `
                  <div class="dependency-item">
                    <span class="dependency-type ${ref.type}">${ref.type}</span>
                    <span>${ref.name}</span>
                  </div>
                `).join('')}
                ${references.length > 5 ? `<div style="color: #718096; font-size: 12px;">还有 ${references.length - 5} 个引用...</div>` : ''}
              </div>
            </div>
          ` : ''}
        </div>`;
        
        itemCount++;
      }
      
      if (detailsHtml === '') {
        detailsHtml = '<div style="text-align: center; color: #718096; padding: 40px;">未发现资源依赖关系</div>';
      }
      
      document.getElementById('referenceDetails').innerHTML = detailsHtml;
    }
    
    // 查找未使用资源
    async function findUnusedAssets() {
      if (assetGuidMap.size === 0) {
        alert('请先运行"分析引用关系"');
        return;
      }
      
      unusedAssets = [];
      
      // 查找没有被任何资源引用的资源
      for (const [guid, asset] of assetGuidMap) {
        const isReferenced = reverseDepMap.has(asset.path);
        const isSceneOrPrefab = ['unity', 'prefab'].includes(asset.ext.toLowerCase());
        
        // 场景文件和预制件通常是入口点，不算未使用
        if (!isReferenced && !isSceneOrPrefab) {
          unusedAssets.push(asset);
        }
      }
      
      renderUnusedResults();
    }
    
    // 渲染未使用资源结果
    function renderUnusedResults() {
      document.getElementById('unusedResults').classList.remove('hidden');
      
      let statsHtml = `<div style="font-size:18px;font-weight:600;">发现 <b>${unusedAssets.length}</b> 个可能未使用的资源</div>`;
      statsHtml += '<div class="stats-grid">';
      
      const typeStats = {};
      unusedAssets.forEach(asset => {
        const type = getAssetType(asset.ext);
        typeStats[type] = (typeStats[type] || 0) + 1;
      });
      
      Object.entries(typeStats).forEach(([type, count]) => {
        statsHtml += `<div class="stat-item"><div class="stat-number">${count}</div><div class="stat-label">${type.toUpperCase()}</div></div>`;
      });
      
      statsHtml += '</div>';
      document.getElementById('unusedStats').innerHTML = statsHtml;
      
      // 未使用资源列表
      let listHtml = '';
      unusedAssets.slice(0, 100).forEach(asset => {
        listHtml += `<div class="reference-item unused-asset">
          <div class="reference-header">
            🗑️ ${asset.name}
            <span class="dependency-type ${getAssetType(asset.ext)}">${getAssetType(asset.ext)}</span>
          </div>
          <div class="reference-path">${asset.path}</div>
          <div style="margin-top: 10px; color: #dd6b20; font-size: 13px;">
            💡 此资源似乎没有被其他资源引用，可能可以安全删除
          </div>
        </div>`;
      });
      
      if (unusedAssets.length > 100) {
        listHtml += `<div style="text-align: center; padding: 20px; color: #718096;">
          还有 ${unusedAssets.length - 100} 个未使用资源，请使用导出功能查看完整列表
        </div>`;
      }
      
      if (listHtml === '') {
        listHtml = '<div style="text-align: center; color: #718096; padding: 40px;">✅ 所有资源都有被引用</div>';
      }
      
      document.getElementById('unusedList').innerHTML = listHtml;
    }
    
    // 检测循环依赖
    async function detectCircularDependencies() {
      if (dependencyMap.size === 0) {
        alert('请先运行"分析引用关系"');
        return;
      }
      
      circularDependencies = [];
      const visited = new Set();
      const visiting = new Set();
      
      // 深度优先搜索检测循环
      function detectCycle(path, currentPath = []) {
        if (visiting.has(path)) {
          // 找到循环依赖
          const cycleStart = currentPath.indexOf(path);
          if (cycleStart !== -1) {
            const cycle = currentPath.slice(cycleStart);
            cycle.push(path); // 完成循环
            circularDependencies.push(cycle);
          }
          return;
        }
        
        if (visited.has(path)) {
          return;
        }
        
        visiting.add(path);
        currentPath.push(path);
        
        const dependencies = dependencyMap.get(path) || [];
        dependencies.forEach(dep => {
          detectCycle(dep.path, [...currentPath]);
        });
        
        visiting.delete(path);
        visited.add(path);
        currentPath.pop();
      }
      
      // 检查所有资源
      for (const filePath of dependencyMap.keys()) {
        if (!visited.has(filePath)) {
          detectCycle(filePath);
        }
      }
      
      renderCircularResults();
    }
    
    // 渲染循环依赖结果
    function renderCircularResults() {
      document.getElementById('circularResults').classList.remove('hidden');
      
      let statsHtml = `<div style="font-size:18px;font-weight:600;">发现 <b>${circularDependencies.length}</b> 个循环依赖</div>`;
      if (circularDependencies.length > 0) {
        statsHtml += '<div style="color: #e53e3e; margin-top: 10px;">⚠️ 循环依赖可能导致加载问题，建议及时修复</div>';
      }
      
      document.getElementById('circularStats').innerHTML = statsHtml;
      
      // 循环依赖列表
      let listHtml = '';
      circularDependencies.forEach((cycle, index) => {
        listHtml += `<div class="reference-item circular-dependency">
          <div class="reference-header">
            🔄 循环依赖 ${index + 1}
            <span class="reference-count">${cycle.length - 1} 个文件</span>
          </div>
          <div class="dependency-list">
            ${cycle.map((path, i) => {
              const fileName = path.split('/').pop();
              const isLast = i === cycle.length - 1;
              return `
                <div class="dependency-item">
                  <span>${i + 1}.</span>
                  <span>${fileName}</span>
                  ${!isLast ? '<span style="color: #667eea;">→</span>' : '<span style="color: #e53e3e;">🔄</span>'}
                </div>
              `;
            }).join('')}
          </div>
          <div style="margin-top: 10px; color: #c53030; font-size: 13px;">
            💡 建议重构这些资源的依赖关系以打破循环
          </div>
        </div>`;
      });
      
      if (listHtml === '') {
        listHtml = '<div style="text-align: center; color: #718096; padding: 40px;">✅ 未发现循环依赖</div>';
      }
      
      document.getElementById('circularList').innerHTML = listHtml;
    }
    
    // 导出依赖关系报告
    function exportDependencyReport() {
      if (assetGuidMap.size === 0) {
        alert('请先运行引用关系分析');
        return;
      }
      
      const reportData = [];
      
      // 依赖关系报告
      for (const [filePath, dependencies] of dependencyMap) {
        const references = reverseDepMap.get(filePath) || [];
        
        reportData.push({
          '资源名称': filePath.split('/').pop(),
          '资源路径': filePath,
          '资源类型': getAssetType(filePath.split('.').pop()),
          '依赖数量': dependencies.length,
          '被引用数量': references.length,
          '依赖列表': dependencies.map(dep => dep.path).join('; '),
          '被引用列表': references.map(ref => ref.path).join('; '),
          '状态': unusedAssets.some(asset => asset.path === filePath) ? '未使用' : 
                 circularDependencies.some(cycle => cycle.includes(filePath)) ? '循环依赖' : '正常'
        });
      }
      
      const ws = XLSX.utils.json_to_sheet(reportData);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, "依赖关系报告");
      
      // 添加未使用资源表
      if (unusedAssets.length > 0) {
        const unusedData = unusedAssets.map(asset => ({
          '资源名称': asset.name,
          '资源路径': asset.path,
          '资源类型': getAssetType(asset.ext),
          '建议': '可能可以安全删除'
        }));
        const unusedWs = XLSX.utils.json_to_sheet(unusedData);
        XLSX.utils.book_append_sheet(wb, unusedWs, "未使用资源");
      }
      
      // 添加循环依赖表
      if (circularDependencies.length > 0) {
        const circularData = [];
        circularDependencies.forEach((cycle, index) => {
          cycle.slice(0, -1).forEach((path, i) => {
            circularData.push({
              '循环组': index + 1,
              '顺序': i + 1,
              '资源名称': path.split('/').pop(),
              '资源路径': path,
              '下一个依赖': cycle[i + 1].split('/').pop()
            });
          });
        });
        const circularWs = XLSX.utils.json_to_sheet(circularData);
        XLSX.utils.book_append_sheet(wb, circularWs, "循环依赖");
      }
      
      XLSX.writeFile(wb, `Unity依赖关系报告_${new Date().toISOString().slice(0,10)}.xlsx`);
      
      alert(`✅ 依赖关系报告已导出！\n\n` +
            `包含内容：\n` +
            `• 完整依赖关系分析 (${reportData.length} 个资源)\n` +
            `• 未使用资源列表 (${unusedAssets.length} 个)\n` +
            `• 循环依赖检测 (${circularDependencies.length} 个)\n\n` +
            `可用于项目优化和资源清理。`);
    }
    
    // 渲染筛选结果
    function renderFilteredResults() {
      const searchInput = document.getElementById('searchInput');
      let keyword = searchInput ? searchInput.value.trim().toLowerCase() : '';
      let displayFiles = resourceData;
      
      if (keyword) {
        displayFiles = resourceData.filter(f =>
          f['文件名称'].toLowerCase().includes(keyword) ||
          f['文件路径'].toLowerCase().includes(keyword)
        );
      }
      
      lastDisplayFiles = displayFiles;
      
      if (displayFiles.length === 0) {
        document.getElementById('resourceList').innerHTML = '<div style="text-align: center; color: #718096; padding: 40px;">❌ 未找到任何目标格式的文件</div>';
        document.getElementById('stats').style.display = 'none';
        document.getElementById('batchOperations').classList.add('hidden');
        renderPagination(0, 1, pageSize);
        return;
      }
      
      // 统计
      const formatStats = {};
      displayFiles.forEach(f => {
        let ext = f['文件类型'].toLowerCase();
        if (ext === 'jpeg') ext = 'jpg';
        formatStats[ext] = (formatStats[ext] || 0) + 1;
      });
      
      let statsHtml = '<div style="font-size:18px;font-weight:600;">共找到 <b>' + displayFiles.length + '</b> 个资源文件</div>';
      statsHtml += '<div class="stats-grid">';
      Object.entries(formatStats).forEach(([ext, count]) => {
        statsHtml += `<div class="stat-item"><div class="stat-number">${count}</div><div class="stat-label">${ext.toUpperCase()}</div></div>`;
      });
      statsHtml += '</div>';
      
      document.getElementById('stats').innerHTML = statsHtml;
      document.getElementById('stats').style.display = '';
      document.getElementById('batchOperations').classList.remove('hidden');
      
      // 分页
      const pageCount = Math.max(1, Math.ceil(displayFiles.length / pageSize));
      if (currentPage > pageCount) currentPage = pageCount;
      
      const startIdx = (currentPage - 1) * pageSize;
      const endIdx = Math.min(startIdx + pageSize, displayFiles.length);
      
      // 清理之前的预览
      if (window._previewBlobUrls) {
        window._previewBlobUrls.forEach(url => URL.revokeObjectURL(url));
      }
      window._previewBlobUrls = [];
      
      let listHtml = '';
      for (let i = startIdx; i < endIdx; i++) {
        const f = displayFiles[i];
        const isSelected = selectedItems.has(i);
        let previewHtml = '';
        const ext = f['文件类型'].toLowerCase();
        
        if (['png','jpg','jpeg','gif','bmp','webp'].includes(ext)) {
          previewHtml = `<span class='preview-img' data-path='${f['文件路径']}' style='display:inline-block;width:48px;height:48px;vertical-align:middle;background:#f7fafc;border:2px solid #e2e8f0;border-radius:8px;overflow:hidden;'></span>`;
        } else if (['mp3','wav','ogg'].includes(ext)) {
          previewHtml = `<span class='preview-audio' data-path='${f['文件路径']}' style='display:inline-block;width:120px;vertical-align:middle;'></span>`;
        }
        
        listHtml += `<div class="resource-item ${isSelected ? 'selected' : ''}">
          <input type="checkbox" class="resource-checkbox" data-index="${i}" ${isSelected ? 'checked' : ''}>
          <div class="resource-info">
            <div class="resource-name">${f['文件名称']}</div>
            <div class="resource-path">${f['文件路径']}</div>
          </div>
          <div class="resource-type">${f['文件类型']}</div>
          <div>${previewHtml}</div>
        </div>`;
      }
      
      document.getElementById('resourceList').innerHTML = listHtml;
      renderPagination(displayFiles.length, currentPage, pageSize);
      
      // 绑定多选框事件
      document.querySelectorAll('.resource-checkbox').forEach(checkbox => {
        checkbox.addEventListener('change', function() {
          const index = parseInt(this.dataset.index);
          if (this.checked) {
            selectedItems.add(index);
          } else {
            selectedItems.delete(index);
          }
          updateBatchOperations();
        });
      });
      
      updateBatchOperations();
      // 异步加载预览
      loadPreviews();
    }
    
    // 加载预览（限流）
    function loadPreviews() {
      const MAX_PREVIEW_CONCURRENCY = 8;
      
      if (window._previewAbort) window._previewAbort.cancelled = true;
      window._previewAbort = {cancelled: false};
      
      setTimeout(() => {
        const container = document.getElementById('resourceList');
        if (!container) return;
        
        const tasks = [];
        
        // 收集图片任务
        for (const el of container.querySelectorAll('.preview-img')) {
          const path = el.getAttribute('data-path');
          tasks.push({el, path, type: 'img'});
        }
        
        // 收集音频任务
        for (const el of container.querySelectorAll('.preview-audio')) {
          const path = el.getAttribute('data-path');
          tasks.push({el, path, type: 'audio'});
        }
        
        let running = 0, idx = 0;
        
        function runNext() {
          if (window._previewAbort.cancelled) return;
          
          while (running < MAX_PREVIEW_CONCURRENCY && idx < tasks.length) {
            const task = tasks[idx++];
            running++;
            
            (async () => {
              try {
                const fileHandle = await getFileHandleByPath(dirHandle, task.path);
                if (fileHandle) {
                  const file = await fileHandle.getFile();
                  const url = URL.createObjectURL(file);
                  window._previewBlobUrls.push(url);
                  
                  if (task.type === 'img') {
                    task.el.innerHTML = `<img src='${url}' style='width:100%;height:100%;object-fit:cover;' loading='lazy'>`;
                  } else if (task.type === 'audio') {
                    task.el.innerHTML = `<audio src='${url}' controls style='width:100px;height:32px;'></audio>`;
                  }
                }
              } catch(e) {
                console.warn('预览加载失败:', task.path);
              }
              
              running--;
              runNext();
            })();
          }
        }
        
        runNext();
      }, 0);
    }
    
    // 递归查找文件句柄
    async function getFileHandleByPath(rootHandle, relPath) {
      const parts = relPath.split('/');
      let curr = rootHandle;
      
      for (let i = 0; i < parts.length; i++) {
        if (i === parts.length - 1) {
          return await curr.getFileHandle(parts[i]).catch(() => null);
        } else {
          curr = await curr.getDirectoryHandle(parts[i]).catch(() => null);
          if (!curr) return null;
        }
      }
      
      return null;
    }
    
    // 分页相关
    function renderPagination(total, page, pageSize) {
      const pageCount = Math.max(1, Math.ceil(total / pageSize));
      let html = '';
      
      if (pageCount <= 1) {
        document.getElementById('pagination').innerHTML = '';
        return;
      }
      
      html += `<button data-page="1" ${page === 1 ? 'disabled' : ''}>首页</button> `;
      html += `<button data-page="${page - 1}" ${page === 1 ? 'disabled' : ''}>上一页</button> `;
      
      let start = Math.max(1, page - 2), end = Math.min(pageCount, page + 2);
      if (start > 1) html += '... ';
      
      for (let i = start; i <= end; i++) {
        html += `<button data-page="${i}" ${i === page ? 'style="font-weight:bold;background:linear-gradient(45deg, #667eea, #764ba2);color:#fff;"' : ''}>${i}</button> `;
      }
      
      if (end < pageCount) html += '... ';
      html += `<button data-page="${page + 1}" ${page === pageCount ? 'disabled' : ''}>下一页</button> `;
      html += `<button data-page="${pageCount}" ${page === pageCount ? 'disabled' : ''}>末页</button> `;
      html += `&nbsp; 第 ${page} / ${pageCount} 页，共 ${total} 条`;
      
      document.getElementById('pagination').innerHTML = html;
      
      // 绑定分页按钮事件
      document.querySelectorAll('#pagination button[data-page]').forEach(btn => {
        btn.addEventListener('click', function() {
          if (!this.disabled) {
            gotoPage(parseInt(this.dataset.page));
          }
        });
      });
    }
    
    function gotoPage(page) {
      currentPage = page;
      renderFilteredResults();
    }
    
    // 字段选择弹窗
    function openFieldSelect() {
      const modal = document.getElementById('fieldSelectModal');
      const box = document.getElementById('fieldCheckboxes');
      
      box.innerHTML = allFields.map(f =>
        `<label><input type='checkbox' value='${f.key}' ${selectedFields.includes(f.key) ? 'checked' : ''}> ${f.label}</label>`
      ).join('');
      
      modal.classList.remove('hidden');
    }
    
    function closeFieldSelect() {
      document.getElementById('fieldSelectModal').classList.add('hidden');
    }
    
    function applyFieldSelect() {
      const box = document.getElementById('fieldCheckboxes');
      selectedFields = Array.from(box.querySelectorAll('input[type=checkbox]:checked')).map(cb => cb.value);
      
      if (selectedFields.length === 0) {
        alert('请至少选择一个字段');
        return;
      }
      
      localStorage.setItem('unity_asset_export_fields', JSON.stringify(selectedFields));
      closeFieldSelect();
    }
    
    // 批量操作相关
    function updateBatchOperations() {
      const selectedCountSpan = document.getElementById('selectedCount');
      const selectAllBtn2 = document.getElementById('selectAllBtn2');
      const clearSelectionBtn = document.getElementById('clearSelectionBtn');
      const copyPathsBtn = document.getElementById('copyPathsBtn');
      const exportSelectedBtn = document.getElementById('exportSelectedBtn');

      const totalItems = lastDisplayFiles.length;
      const selectedCount = selectedItems.size;

      selectedCountSpan.textContent = `已选择 ${selectedCount} 个文件`;
      selectAllBtn2.disabled = totalItems === 0;
      clearSelectionBtn.disabled = selectedCount === 0;
      copyPathsBtn.disabled = selectedCount === 0;
      exportSelectedBtn.disabled = selectedCount === 0;
    }

    function selectAllItems() {
      selectedItems.clear();
      for (let i = 0; i < lastDisplayFiles.length; i++) {
        selectedItems.add(i);
      }
      renderFilteredResults(); // 重新渲染以更新选中状态的视觉反馈
    }

    function clearSelection() {
      selectedItems.clear();
      renderFilteredResults(); // 重新渲染以清除选中状态的视觉反馈
    }

    function copySelectedPaths() {
      if (selectedItems.size === 0) {
        alert('请先选择要复制的文件');
        return;
      }
      const paths = selectedItems.size === 0 ? [] : Array.from(selectedItems).map(idx => lastDisplayFiles[idx]['文件路径']);
      const pathsString = paths.join('\n');
      navigator.clipboard.writeText(pathsString).then(() => {
        alert('已复制 ' + selectedItems.size + ' 个文件的路径到剪贴板！');
      }).catch(err => {
        console.error('复制失败:', err);
        alert('复制失败，请手动复制。');
      });
    }

    function exportSelectedItems() {
      if (selectedItems.size === 0) {
        alert('请先选择要导出的文件');
        return;
      }
      
      if (!selectedFields || selectedFields.length === 0) {
        alert('请先选择要导出的字段');
        return;
      }

      const exportRows = Array.from(selectedItems).map(idx => {
        const f = lastDisplayFiles[idx];
        const obj = {};
        selectedFields.forEach(field => obj[field] = f[field]);
        return obj;
      });
      
      const format = document.getElementById('exportFormat').value;
      
      if (format === 'excel') {
        const ws = XLSX.utils.json_to_sheet(exportRows);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "资源列表");
        XLSX.writeFile(wb, "Unity资源清单.xlsx");
      } else if (format === 'csv') {
        let csv = selectedFields.join(',') + '\n';
        exportRows.forEach(row => {
          csv += selectedFields.map(f => '"' + String(row[f] || '').replace(/"/g, '""') + '"').join(',') + '\n';
        });
        
        const blob = new Blob([csv], {type: 'text/csv'});
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = 'Unity资源清单.csv';
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
      } else if (format === 'json') {
        const blob = new Blob([JSON.stringify(exportRows, null, 2)], {type: 'application/json'});
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = 'Unity资源清单.json';
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
      }
    }
    
    // 导出数据
    function exportData() {
      if (!resourceData || resourceData.length === 0) {
        alert('请先筛选并预览要导出的内容');
        return;
      }
      
      if (!selectedFields || selectedFields.length === 0) {
        alert('请先选择要导出的字段');
        return;
      }
      
      const exportRows = resourceData.map(row => {
        const obj = {};
        selectedFields.forEach(f => obj[f] = row[f]);
        return obj;
      });
      
      const format = document.getElementById('exportFormat').value;
      
      if (format === 'excel') {
        const ws = XLSX.utils.json_to_sheet(exportRows);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "资源列表");
        XLSX.writeFile(wb, "Unity资源清单.xlsx");
      } else if (format === 'csv') {
        let csv = selectedFields.join(',') + '\n';
        exportRows.forEach(row => {
          csv += selectedFields.map(f => '"' + String(row[f] || '').replace(/"/g, '""') + '"').join(',') + '\n';
        });
        
        const blob = new Blob([csv], {type: 'text/csv'});
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = 'Unity资源清单.csv';
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
      } else if (format === 'json') {
        const blob = new Blob([JSON.stringify(exportRows, null, 2)], {type: 'application/json'});
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = 'Unity资源清单.json';
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
      }
    }
    
    // 复制所有文件路径
    function copyAllPaths() {
      if (!resourceData || resourceData.length === 0) {
        alert('请先筛选并预览要导出的内容');
        return;
      }
      
      // 显示路径格式选择对话框
      const pathType = confirm(
        '选择路径格式：\n\n' +
        '确定 = 相对路径（相对于Unity项目根目录）\n' +
        '取消 = 绝对路径（完整文件系统路径）\n\n' +
        `将复制 ${resourceData.length} 个文件的路径到剪贴板。`
      );
      
      let pathsString;
      if (pathType) {
        // 相对路径
        pathsString = resourceData.map(f => {
          // 移除项目根目录部分，保留相对路径
          let relativePath = f['文件路径'];
          if (dirHandle && dirHandle.name) {
            const projectName = dirHandle.name;
            const index = relativePath.indexOf(projectName);
            if (index !== -1) {
              relativePath = relativePath.substring(index + projectName.length + 1);
            }
          }
          return relativePath;
        }).join('\n');
      } else {
        // 绝对路径
        pathsString = resourceData.map(f => f['文件路径']).join('\n');
      }
      
      // 复制到剪贴板
      navigator.clipboard.writeText(pathsString).then(() => {
        const pathTypeText = pathType ? '相对路径' : '绝对路径';
        alert(`✅ 成功复制 ${resourceData.length} 个文件的${pathTypeText}到剪贴板！\n\n` +
              `格式：每行一个文件路径\n` +
              `可以直接粘贴到文本编辑器或Excel中使用。`);
      }).catch(err => {
        console.error('复制失败:', err);
        
        // 备用方案：创建文本区域并选择
        const textarea = document.createElement('textarea');
        textarea.value = pathsString;
        document.body.appendChild(textarea);
        textarea.select();
        document.execCommand('copy');
        document.body.removeChild(textarea);
        
        alert(`✅ 已复制 ${resourceData.length} 个文件路径到剪贴板！`);
      });
    }
    
    // 重置工具
    function resetTool() {
      dirHandle = null;
      allFiles = [];
      selectedFolderPath = '';
      filteredFiles = [];
      resourceData = [];
      folderTreeRoot = null;
      currentPage = 1;
      selectedItems.clear(); // 重置选中项
      
      // 重置去重和异常检测数据
      duplicateGroups = [];
      anomalyResults = [];
      analysisInProgress = false;
      
      // 重置引用关系分析数据
      assetGuidMap.clear();
      dependencyMap.clear();
      reverseDepMap.clear();
      unusedAssets = [];
      circularDependencies = [];
      
      document.getElementById('pickedDir').textContent = '';
      document.getElementById('selectedFolder').textContent = '';
      document.getElementById('step2').classList.add('hidden');
      document.getElementById('step3').classList.add('hidden');
      document.getElementById('step4').classList.add('hidden');
      document.getElementById('step5').classList.add('hidden');
      document.getElementById('step6').classList.add('hidden');
      
      // 隐藏分析结果
      document.getElementById('duplicateResults').classList.add('hidden');
      document.getElementById('anomalyResults').classList.add('hidden');
      document.getElementById('analysisAdvice').classList.add('hidden');
      document.getElementById('referenceResults').classList.add('hidden');
      document.getElementById('unusedResults').classList.add('hidden');
      document.getElementById('circularResults').classList.add('hidden');
      
      // 清理预览
      if (window._previewBlobUrls) {
        window._previewBlobUrls.forEach(url => URL.revokeObjectURL(url));
        window._previewBlobUrls = [];
      }
      
      // 重置格式选择
      document.querySelectorAll('.format-option input[type="checkbox"]').forEach(cb => cb.checked = false);
      document.getElementById('prefab').checked = true;
      
      // 重置搜索
      document.getElementById('searchInput').value = '';
    }
    
    // 计算文件hash
    async function calculateFileHash(fileHandle) {
      try {
        const file = await fileHandle.getFile();
        const arrayBuffer = await file.arrayBuffer();
        const hashBuffer = await crypto.subtle.digest('SHA-256', arrayBuffer);
        const hashArray = Array.from(new Uint8Array(hashBuffer));
        return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
      } catch (e) {
        console.warn('计算文件hash失败:', e);
        return null;
      }
    }
    
    // 资源去重检测
    async function detectDuplicates() {
      if (!resourceData || resourceData.length === 0) {
        alert('请先扫描资源文件');
        return;
      }
      
      analysisInProgress = true;
      showScanProgress();
      document.getElementById('scanProgressText').innerHTML = '正在分析资源重复情况...';
      
      const duplicateMap = new Map();
      const sizeMap = new Map();
      const nameMap = new Map();
      
      // 按文件大小分组
      for (let i = 0; i < resourceData.length; i++) {
        const file = resourceData[i];
        const size = file['文件大小'];
        const name = file['文件名称'];
        
        if (!sizeMap.has(size)) {
          sizeMap.set(size, []);
        }
        sizeMap.get(size).push({index: i, file});
        
        if (!nameMap.has(name)) {
          nameMap.set(name, []);
        }
        nameMap.get(name).push({index: i, file});
        
        if (i % 10 === 0) {
          document.getElementById('scanProgressText').innerHTML = `正在分析资源重复情况... (${i + 1}/${resourceData.length})`;
          await new Promise(res => setTimeout(res, 0));
        }
      }
      
      duplicateGroups = [];
      
      // 检测同名文件
      for (const [name, files] of nameMap) {
        if (files.length > 1) {
          duplicateGroups.push({
            type: 'name',
            key: name,
            files: files,
            description: `同名文件 (${files.length}个)`
          });
        }
      }
      
      // 检测同大小文件并计算hash
      for (const [size, files] of sizeMap) {
        if (files.length > 1 && size > 0) {
          document.getElementById('scanProgressText').innerHTML = `正在计算文件hash... (大小: ${size} bytes)`;
          
          const hashMap = new Map();
          for (const {index, file} of files) {
            try {
              const fileHandle = await getFileHandleByPath(dirHandle, file['文件路径']);
              if (fileHandle) {
                const hash = await calculateFileHash(fileHandle);
                if (hash) {
                  if (!hashMap.has(hash)) {
                    hashMap.set(hash, []);
                  }
                  hashMap.get(hash).push({index, file});
                }
              }
            } catch (e) {
              console.warn('处理文件失败:', file['文件路径']);
            }
          }
          
          // 添加内容相同的文件组
          for (const [hash, hashFiles] of hashMap) {
            if (hashFiles.length > 1) {
              duplicateGroups.push({
                type: 'content',
                key: hash,
                files: hashFiles,
                description: `内容相同 (${hashFiles.length}个, ${size} bytes)`
              });
            }
          }
        }
      }
      
      // 更新资源数据，添加重复状态
      resourceData.forEach((file, index) => {
        let duplicateStatus = '无重复';
        
        for (const group of duplicateGroups) {
          if (group.files.some(f => f.index === index)) {
            if (group.type === 'name') {
              duplicateStatus = '同名重复';
            } else if (group.type === 'content') {
              duplicateStatus = '内容重复';
            }
            break;
          }
        }
        
        file['重复状态'] = duplicateStatus;
      });
      
      analysisInProgress = false;
      hideScanProgress();
      
      // 显示结果
      renderDuplicateResults();
    }
    
    // 异常检测
    function detectAnomalies() {
      if (!resourceData || resourceData.length === 0) {
        alert('请先扫描资源文件');
        return;
      }
      
      anomalyResults = [];
      
      // 定义异常检测规则
      const rules = [
        {
          name: '文件过大',
          check: (file) => {
            const size = file['文件大小'];
            const ext = file['文件类型'].toLowerCase();
            const limits = {
              'png': 5 * 1024 * 1024,  // 5MB
              'jpg': 3 * 1024 * 1024,  // 3MB
              'jpeg': 3 * 1024 * 1024,
              'wav': 10 * 1024 * 1024, // 10MB
              'mp3': 5 * 1024 * 1024,  // 5MB
              'fbx': 20 * 1024 * 1024, // 20MB
              'prefab': 1 * 1024 * 1024 // 1MB
            };
            return size > (limits[ext] || 10 * 1024 * 1024);
          },
          severity: 'warning',
          suggestion: '考虑压缩或优化文件大小'
        },
        {
          name: '命名不规范',
          check: (file) => {
            const name = file['文件名称'];
            // 检查是否包含中文、特殊字符、空格
            return /[\u4e00-\u9fa5\s]/.test(name) || /[^\w\-\.]/.test(name);
          },
          severity: 'info',
          suggestion: '建议使用英文命名，避免空格和特殊字符'
        },
        {
          name: '路径过深',
          check: (file) => {
            const path = file['文件路径'];
            return path.split('/').length > 8;
          },
          severity: 'warning',
          suggestion: '路径层级过深，建议简化目录结构'
        },
        {
          name: '临时文件',
          check: (file) => {
            const name = file['文件名称'];
            return name.includes('temp') || name.includes('tmp') || name.includes('~') || name.startsWith('.');
          },
          severity: 'error',
          suggestion: '建议删除临时文件'
        },
        {
          name: '版本冲突',
          check: (file) => {
            const name = file['文件名称'];
            return /\d+$/.test(name.replace(/\.[^.]+$/, '')) || name.includes('copy') || name.includes('副本');
          },
          severity: 'warning',
          suggestion: '可能存在版本冲突，建议检查是否为重复文件'
        }
      ];
      
      // 应用检测规则
      resourceData.forEach((file, index) => {
        const anomalies = [];
        
        rules.forEach(rule => {
          if (rule.check(file)) {
            anomalies.push({
              rule: rule.name,
              severity: rule.severity,
              suggestion: rule.suggestion
            });
          }
        });
        
        if (anomalies.length > 0) {
          anomalyResults.push({
            index,
            file,
            anomalies
          });
        }
        
        // 更新文件的异常信息
        file['异常信息'] = anomalies.length > 0 ? 
          anomalies.map(a => `${a.rule}(${a.severity})`).join('; ') : 
          '无异常';
      });
      
      renderAnomalyResults();
    }
    
    // 渲染去重检测结果
    function renderDuplicateResults() {
      document.getElementById('step5').classList.remove('hidden');
      document.getElementById('duplicateResults').classList.remove('hidden');
      
      // 统计信息
      const duplicateCount = duplicateGroups.reduce((sum, group) => sum + group.files.length, 0);
      const groupCount = duplicateGroups.length;
      
      let statsHtml = `<div style="font-size:18px;font-weight:600;">发现 <b>${groupCount}</b> 组重复资源，共 <b>${duplicateCount}</b> 个文件</div>`;
      statsHtml += '<div class="stats-grid">';
      
      const nameGroups = duplicateGroups.filter(g => g.type === 'name');
      const contentGroups = duplicateGroups.filter(g => g.type === 'content');
      
      statsHtml += `<div class="stat-item"><div class="stat-number">${nameGroups.length}</div><div class="stat-label">同名重复组</div></div>`;
      statsHtml += `<div class="stat-item"><div class="stat-number">${contentGroups.length}</div><div class="stat-label">内容重复组</div></div>`;
      statsHtml += `<div class="stat-item"><div class="stat-number">${duplicateCount}</div><div class="stat-label">重复文件数</div></div>`;
      statsHtml += '</div>';
      
      document.getElementById('duplicateStats').innerHTML = statsHtml;
      
      // 重复组列表
      let groupsHtml = '';
      duplicateGroups.forEach((group, index) => {
        const icon = group.type === 'name' ? '📝' : '🔗';
        groupsHtml += `<div class="duplicate-group type-${group.type}">
          <div class="duplicate-group-header">
            ${icon} ${group.description}
          </div>
          <div class="duplicate-group-files">`;
        
        group.files.forEach(({file}) => {
          groupsHtml += `<div class="duplicate-file-item">
            <span>📄</span>
            <span style="flex:1;">${file['文件名称']}</span>
            <span style="color:#718096;font-size:12px;">${file['文件路径']}</span>
          </div>`;
        });
        
        groupsHtml += `</div></div>`;
      });
      
      if (groupsHtml === '') {
        groupsHtml = '<div style="text-align: center; color: #718096; padding: 40px;">✅ 未发现重复资源</div>';
      }
      
      document.getElementById('duplicateGroups').innerHTML = groupsHtml;
    }
    
    // 渲染异常检测结果
    function renderAnomalyResults() {
      document.getElementById('step5').classList.remove('hidden');
      document.getElementById('anomalyResults').classList.remove('hidden');
      
      // 统计信息
      const errorCount = anomalyResults.filter(a => a.anomalies.some(an => an.severity === 'error')).length;
      const warningCount = anomalyResults.filter(a => a.anomalies.some(an => an.severity === 'warning')).length;
      const infoCount = anomalyResults.filter(a => a.anomalies.some(an => an.severity === 'info')).length;
      
      let statsHtml = `<div style="font-size:18px;font-weight:600;">发现 <b>${anomalyResults.length}</b> 个异常文件</div>`;
      statsHtml += '<div class="stats-grid">';
      statsHtml += `<div class="stat-item"><div class="stat-number">${errorCount}</div><div class="stat-label">严重错误</div></div>`;
      statsHtml += `<div class="stat-item"><div class="stat-number">${warningCount}</div><div class="stat-label">警告</div></div>`;
      statsHtml += `<div class="stat-item"><div class="stat-number">${infoCount}</div><div class="stat-label">提醒</div></div>`;
      statsHtml += '</div>';
      
      document.getElementById('anomalyStats').innerHTML = statsHtml;
      
      // 异常列表
      let anomaliesHtml = '';
      anomalyResults.forEach(result => {
        const highestSeverity = result.anomalies.reduce((max, a) => {
          const levels = {error: 3, warning: 2, info: 1};
          return levels[a.severity] > levels[max] ? a.severity : max;
        }, 'info');
        
        const icon = {error: '❌', warning: '⚠️', info: 'ℹ️'}[highestSeverity];
        
        anomaliesHtml += `<div class="anomaly-item severity-${highestSeverity}">
          <div class="anomaly-header">
            ${icon} ${result.file['文件名称']}
          </div>
          <div class="anomaly-path">${result.file['文件路径']}</div>
          <div class="anomaly-details">`;
        
        result.anomalies.forEach(anomaly => {
          anomaliesHtml += `<span class="anomaly-rule severity-${anomaly.severity}">${anomaly.rule}</span>`;
        });
        
        anomaliesHtml += `</div>`;
        
        // 显示建议
        const suggestions = [...new Set(result.anomalies.map(a => a.suggestion))];
        suggestions.forEach(suggestion => {
          anomaliesHtml += `<div class="anomaly-suggestion">💡 ${suggestion}</div>`;
        });
        
        anomaliesHtml += `</div>`;
      });
      
      if (anomaliesHtml === '') {
        anomaliesHtml = '<div style="text-align: center; color: #718096; padding: 40px;">✅ 未发现异常问题</div>';
      }
      
      document.getElementById('anomalyList').innerHTML = anomaliesHtml;
    }
    
    // 完整分析
    async function runFullAnalysis() {
      if (!resourceData || resourceData.length === 0) {
        alert('请先扫描资源文件');
        return;
      }
      
      document.getElementById('step5').classList.remove('hidden');
      
      // 依次运行去重和异常检测
      await detectDuplicates();
      detectAnomalies();
      
      // 生成分析建议
      generateAnalysisAdvice();
    }
    
    // 生成分析建议
    function generateAnalysisAdvice() {
      document.getElementById('analysisAdvice').classList.remove('hidden');
      
      const advice = [];
      
      // 基于去重结果的建议
      if (duplicateGroups.length > 0) {
        const duplicateCount = duplicateGroups.reduce((sum, group) => sum + group.files.length, 0);
        advice.push({
          title: '🔍 重复资源清理',
          content: `发现 ${duplicateGroups.length} 组重复资源，共 ${duplicateCount} 个文件。建议：
          <br>• 删除内容相同的重复文件，保留一个版本
          <br>• 检查同名文件是否为不同版本，考虑重命名或合并
          <br>• 建立统一的资源命名规范，避免未来重复`
        });
      }
      
      // 基于异常检测的建议
      if (anomalyResults.length > 0) {
        const errorCount = anomalyResults.filter(a => a.anomalies.some(an => an.severity === 'error')).length;
        const warningCount = anomalyResults.filter(a => a.anomalies.some(an => an.severity === 'warning')).length;
        
        if (errorCount > 0) {
          advice.push({
            title: '❌ 严重问题修复',
            content: `发现 ${errorCount} 个严重问题，需要立即处理：
            <br>• 删除临时文件和系统生成的隐藏文件
            <br>• 检查并修复损坏的资源文件
            <br>• 清理开发过程中产生的测试文件`
          });
        }
        
        if (warningCount > 0) {
          advice.push({
            title: '⚠️ 优化建议',
            content: `发现 ${warningCount} 个可优化项目：
            <br>• 压缩过大的图片和音频文件
            <br>• 简化过深的目录结构
            <br>• 统一资源命名规范，使用英文命名`
          });
        }
      }
      
      // 通用建议
      advice.push({
        title: '📋 最佳实践',
        content: `建议建立以下资源管理规范：
        <br>• 定期运行资源扫描和清理
        <br>• 使用版本控制系统管理资源变更
        <br>• 建立资源审查流程，避免引入问题文件
        <br>• 定义清晰的文件夹结构和命名约定`
      });
      
      let adviceHtml = '';
      advice.forEach(item => {
        adviceHtml += `<div class="analysis-advice-item">
          <div class="advice-title">${item.title}</div>
          <div class="advice-content">${item.content}</div>
        </div>`;
      });
      
      // 添加清理操作按钮
      adviceHtml += `<div class="cleanup-actions">
        <h4 style="margin-bottom: 15px;">🛠️ 快速操作</h4>
        <button onclick="exportDuplicateReport()">📊 导出重复文件报告</button>
        <button onclick="exportAnomalyReport()">📋 导出异常问题报告</button>
        <button onclick="generateCleanupScript()">📝 生成清理脚本</button>
        <button class="danger" onclick="confirmBatchCleanup()">🗑️ 批量清理（谨慎使用）</button>
      </div>`;
      
      document.getElementById('adviceContent').innerHTML = adviceHtml;
    }
    
    // 导出重复文件报告
    function exportDuplicateReport() {
      if (duplicateGroups.length === 0) {
        alert('没有发现重复文件');
        return;
      }
      
      const reportData = [];
      duplicateGroups.forEach(group => {
        group.files.forEach(({file}) => {
          reportData.push({
            '文件名称': file['文件名称'],
            '文件路径': file['文件路径'],
            '重复类型': group.type === 'name' ? '同名重复' : '内容重复',
            '重复组': group.description,
            '文件大小': file['文件大小'],
            '修改时间': file['修改时间']
          });
        });
      });
      
      const ws = XLSX.utils.json_to_sheet(reportData);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, "重复文件报告");
      XLSX.writeFile(wb, "Unity重复文件报告.xlsx");
    }
    
    // 导出异常问题报告
    function exportAnomalyReport() {
      if (anomalyResults.length === 0) {
        alert('没有发现异常问题');
        return;
      }
      
      const reportData = [];
      anomalyResults.forEach(result => {
        result.anomalies.forEach(anomaly => {
          reportData.push({
            '文件名称': result.file['文件名称'],
            '文件路径': result.file['文件路径'],
            '异常类型': anomaly.rule,
            '严重程度': anomaly.severity,
            '修复建议': anomaly.suggestion,
            '文件大小': result.file['文件大小'],
            '修改时间': result.file['修改时间']
          });
        });
      });
      
      const ws = XLSX.utils.json_to_sheet(reportData);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, "异常问题报告");
      XLSX.writeFile(wb, "Unity异常问题报告.xlsx");
    }
    
    // 生成清理脚本
    function generateCleanupScript() {
      let script = '#!/bin/bash\n';
      script += '# Unity资源清理建议脚本\n';
      script += '# 此脚本仅为建议，请根据实际情况谨慎执行\n';
      script += '# 建议：1. 备份项目 2. 使用版本控制 3. 逐条检查后执行\n\n';
      
      let hasContent = false;
      
      // 重复文件处理建议
      if (duplicateGroups.length > 0) {
        script += '# =========================\n';
        script += '# 重复文件处理建议\n';
        script += '# =========================\n\n';
        
        duplicateGroups.forEach((group, index) => {
          script += `# 重复组 ${index + 1}: ${group.description}\n`;
          
          if (group.type === 'content') {
            script += '# 内容完全相同的文件，建议保留一个：\n';
            group.files.forEach((item, fileIndex) => {
              if (fileIndex === 0) {
                script += `# 保留: "${item.file['文件路径']}"\n`;
              } else {
                script += `# 可删除: rm "${item.file['文件路径']}"\n`;
              }
            });
          } else {
            script += '# 同名文件，请手动检查是否为不同版本：\n';
            group.files.forEach(item => {
              script += `# 检查: "${item.file['文件路径']}"\n`;
            });
          }
          script += '\n';
        });
        hasContent = true;
      }
      
      // 异常文件处理建议
      if (anomalyResults.length > 0) {
        script += '# =========================\n';
        script += '# 异常文件处理建议\n';
        script += '# =========================\n\n';
        
        const groupedAnomalies = {};
        anomalyResults.forEach(result => {
          result.anomalies.forEach(anomaly => {
            if (!groupedAnomalies[anomaly.rule]) {
              groupedAnomalies[anomaly.rule] = [];
            }
            groupedAnomalies[anomaly.rule].push({
              file: result.file,
              severity: anomaly.severity,
              suggestion: anomaly.suggestion
            });
          });
        });
        
        Object.entries(groupedAnomalies).forEach(([rule, items]) => {
          script += `# ${rule} (${items.length}个文件)\n`;
          script += `# 建议: ${items[0].suggestion}\n`;
          
          items.forEach(item => {
            const action = rule === '临时文件' ? '建议删除' : 
                          item.severity === 'error' ? '需要处理' : '建议优化';
            script += `# ${action}: "${item.file['文件路径']}"\n`;
            
            if (rule === '临时文件') {
              script += `# rm "${item.file['文件路径']}"\n`;
            }
          });
          script += '\n';
        });
        hasContent = true;
      }
      
      if (!hasContent) {
        script += '# 恭喜！未发现需要清理的问题文件\n';
        script += '# 您的Unity项目资源管理良好\n';
      } else {
        script += '# =========================\n';
        script += '# 执行建议\n';
        script += '# =========================\n';
        script += '# 1. 备份整个项目\n';
        script += '# 2. 使用版本控制系统\n';
        script += '# 3. 逐个检查上述文件\n';
        script += '# 4. 取消注释需要执行的命令\n';
        script += '# 5. 分批执行，及时验证结果\n';
      }
      
      const blob = new Blob([script], {type: 'text/plain'});
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = `unity_cleanup_suggestions_${new Date().toISOString().slice(0,10)}.sh`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      
      // 显示生成结果提示
      const problemCount = (duplicateGroups.length || 0) + (anomalyResults.length || 0);
      if (problemCount > 0) {
        alert(`✅ 清理建议脚本已生成！\n\n` +
              `发现问题：\n` +
              `• ${duplicateGroups.length} 组重复文件\n` +
              `• ${anomalyResults.length} 个异常文件\n\n` +
              `脚本包含详细的处理建议，请仔细阅读后谨慎执行。`);
      } else {
        alert(`✅ 清理建议脚本已生成！\n\n` +
              `好消息：未发现需要清理的问题文件。\n` +
              `您的Unity项目资源管理良好！`);
      }
    }
    
    // 确认批量清理
    function confirmBatchCleanup() {
      const confirmMsg = '⚠️ 警告：批量清理将会删除检测到的重复文件和临时文件。\n\n' +
                        '这个操作不可逆转！建议：\n' +
                        '1. 先备份整个项目\n' +
                        '2. 仔细检查清理列表\n' +
                        '3. 使用版本控制系统\n\n' +
                        '确定要继续吗？';
      
      if (confirm(confirmMsg)) {
        alert('批量清理功能需要更高级的文件系统权限。\n建议使用"生成清理脚本"功能，手动执行清理操作。');
      }
    }
    

    
    // 页面加载完成后初始化
    document.addEventListener('DOMContentLoaded', function() {
      init();
    });
  </script>
</body>
</html>